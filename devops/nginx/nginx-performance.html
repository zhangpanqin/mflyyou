<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nginx-包教包会-进阶 | Mflyyou</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="张攀钦的笔记">
    <meta name="theme-color" content="#3eaf7c">
    
    <link rel="preload" href="/assets/css/0.styles.0ce27dc8.css" as="style"><link rel="preload" href="/assets/js/app.c876b023.js" as="script"><link rel="preload" href="/assets/js/5.f1c50b28.js" as="script"><link rel="preload" href="/assets/js/2.85c620a8.js" as="script"><link rel="preload" href="/assets/js/56.1f5db295.js" as="script"><link rel="preload" href="/assets/js/11.66cb8558.js" as="script"><link rel="prefetch" href="/assets/js/10.9d78016d.js"><link rel="prefetch" href="/assets/js/100.d3ccb03a.js"><link rel="prefetch" href="/assets/js/101.db6336a9.js"><link rel="prefetch" href="/assets/js/102.dff088bb.js"><link rel="prefetch" href="/assets/js/103.87b5352b.js"><link rel="prefetch" href="/assets/js/104.e7e828d9.js"><link rel="prefetch" href="/assets/js/105.a0308ea1.js"><link rel="prefetch" href="/assets/js/106.7da8a737.js"><link rel="prefetch" href="/assets/js/12.2e1232ac.js"><link rel="prefetch" href="/assets/js/13.1fa48f49.js"><link rel="prefetch" href="/assets/js/14.88c327e5.js"><link rel="prefetch" href="/assets/js/15.886666ee.js"><link rel="prefetch" href="/assets/js/16.ff3aceaf.js"><link rel="prefetch" href="/assets/js/17.eadbe78e.js"><link rel="prefetch" href="/assets/js/18.cd8f2138.js"><link rel="prefetch" href="/assets/js/19.b44d07c7.js"><link rel="prefetch" href="/assets/js/20.74e35385.js"><link rel="prefetch" href="/assets/js/21.765405a2.js"><link rel="prefetch" href="/assets/js/22.2f152ee9.js"><link rel="prefetch" href="/assets/js/23.ac30fbae.js"><link rel="prefetch" href="/assets/js/24.711f90e7.js"><link rel="prefetch" href="/assets/js/25.d3d81640.js"><link rel="prefetch" href="/assets/js/26.95e73776.js"><link rel="prefetch" href="/assets/js/27.6a6bee8c.js"><link rel="prefetch" href="/assets/js/28.c23d3233.js"><link rel="prefetch" href="/assets/js/29.e7f501b7.js"><link rel="prefetch" href="/assets/js/3.fd75c0a5.js"><link rel="prefetch" href="/assets/js/30.160d973d.js"><link rel="prefetch" href="/assets/js/31.62e9ec91.js"><link rel="prefetch" href="/assets/js/32.63450723.js"><link rel="prefetch" href="/assets/js/33.6a9fe332.js"><link rel="prefetch" href="/assets/js/34.dc78c409.js"><link rel="prefetch" href="/assets/js/35.819eb997.js"><link rel="prefetch" href="/assets/js/36.6f0dd57b.js"><link rel="prefetch" href="/assets/js/37.97cff2db.js"><link rel="prefetch" href="/assets/js/38.42474606.js"><link rel="prefetch" href="/assets/js/39.22279c24.js"><link rel="prefetch" href="/assets/js/4.1d7c8e50.js"><link rel="prefetch" href="/assets/js/40.c79b3ee7.js"><link rel="prefetch" href="/assets/js/41.95abde40.js"><link rel="prefetch" href="/assets/js/42.1a49cfd4.js"><link rel="prefetch" href="/assets/js/43.d4322a35.js"><link rel="prefetch" href="/assets/js/44.d7f9ac42.js"><link rel="prefetch" href="/assets/js/45.531ba324.js"><link rel="prefetch" href="/assets/js/46.0ae453bf.js"><link rel="prefetch" href="/assets/js/47.5c18d38d.js"><link rel="prefetch" href="/assets/js/48.4df5e318.js"><link rel="prefetch" href="/assets/js/49.faafeee6.js"><link rel="prefetch" href="/assets/js/50.dc72e991.js"><link rel="prefetch" href="/assets/js/51.da69b59a.js"><link rel="prefetch" href="/assets/js/52.18528bef.js"><link rel="prefetch" href="/assets/js/53.090cfc3f.js"><link rel="prefetch" href="/assets/js/54.87b885f3.js"><link rel="prefetch" href="/assets/js/55.d191ddc1.js"><link rel="prefetch" href="/assets/js/57.4668a9cd.js"><link rel="prefetch" href="/assets/js/58.2459bcea.js"><link rel="prefetch" href="/assets/js/59.45048184.js"><link rel="prefetch" href="/assets/js/6.0b5d6365.js"><link rel="prefetch" href="/assets/js/60.2db0a1a8.js"><link rel="prefetch" href="/assets/js/61.b4db17d2.js"><link rel="prefetch" href="/assets/js/62.4aa9c88c.js"><link rel="prefetch" href="/assets/js/63.687d4393.js"><link rel="prefetch" href="/assets/js/64.da286e35.js"><link rel="prefetch" href="/assets/js/65.0048315d.js"><link rel="prefetch" href="/assets/js/66.842b0f76.js"><link rel="prefetch" href="/assets/js/67.ca23d6c3.js"><link rel="prefetch" href="/assets/js/68.af55b577.js"><link rel="prefetch" href="/assets/js/69.3faac7ab.js"><link rel="prefetch" href="/assets/js/7.c6b9ef78.js"><link rel="prefetch" href="/assets/js/70.10aac9ff.js"><link rel="prefetch" href="/assets/js/71.518c4fa7.js"><link rel="prefetch" href="/assets/js/72.37b67ecc.js"><link rel="prefetch" href="/assets/js/73.7aebaed8.js"><link rel="prefetch" href="/assets/js/74.d44ba387.js"><link rel="prefetch" href="/assets/js/75.938e5d60.js"><link rel="prefetch" href="/assets/js/76.b4c99a45.js"><link rel="prefetch" href="/assets/js/77.a9ba8193.js"><link rel="prefetch" href="/assets/js/78.3cb7672c.js"><link rel="prefetch" href="/assets/js/79.31c9f385.js"><link rel="prefetch" href="/assets/js/8.2e49308c.js"><link rel="prefetch" href="/assets/js/80.076d581b.js"><link rel="prefetch" href="/assets/js/81.56b7bfb0.js"><link rel="prefetch" href="/assets/js/82.1b4546de.js"><link rel="prefetch" href="/assets/js/83.647327e8.js"><link rel="prefetch" href="/assets/js/84.d3e47f47.js"><link rel="prefetch" href="/assets/js/85.e87c4084.js"><link rel="prefetch" href="/assets/js/86.8083d1e3.js"><link rel="prefetch" href="/assets/js/87.7dcfa72d.js"><link rel="prefetch" href="/assets/js/88.06082791.js"><link rel="prefetch" href="/assets/js/89.ab52b490.js"><link rel="prefetch" href="/assets/js/9.64727c80.js"><link rel="prefetch" href="/assets/js/90.a1265b3f.js"><link rel="prefetch" href="/assets/js/91.05480ab6.js"><link rel="prefetch" href="/assets/js/92.d116ed0a.js"><link rel="prefetch" href="/assets/js/93.74379bdc.js"><link rel="prefetch" href="/assets/js/94.3ca7ca9a.js"><link rel="prefetch" href="/assets/js/95.be2c08bf.js"><link rel="prefetch" href="/assets/js/96.4fde0d8d.js"><link rel="prefetch" href="/assets/js/97.22bb863f.js"><link rel="prefetch" href="/assets/js/98.4eeef762.js"><link rel="prefetch" href="/assets/js/99.ca987746.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0ce27dc8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Mflyyou</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/java/base/java-messy-code.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/go/base/go-command.html" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/springboot/project-sumary/" class="nav-link">
  SpringBoot
</a></div><div class="nav-item"><a href="/tcp-ip/http/http-cors-jsonp/" class="nav-link">
  TCP/IP
</a></div><div class="nav-item"><a href="/dev-tools/asdf/" class="nav-link">
  开发工具
</a></div><div class="nav-item"><a href="/devops/docker/" class="nav-link">
  DevOps
</a></div> <a href="https://github.com/zhangpanqin/mflyyou" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/java/base/java-messy-code.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/go/base/go-command.html" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/springboot/project-sumary/" class="nav-link">
  SpringBoot
</a></div><div class="nav-item"><a href="/tcp-ip/http/http-cors-jsonp/" class="nav-link">
  TCP/IP
</a></div><div class="nav-item"><a href="/dev-tools/asdf/" class="nav-link">
  开发工具
</a></div><div class="nav-item"><a href="/devops/docker/" class="nav-link">
  DevOps
</a></div> <a href="https://github.com/zhangpanqin/mflyyou" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Docker</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/devops/docker/" class="sidebar-link">Docker</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Terraform</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/devops/terraform/" class="sidebar-link">Terraform</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>AWS</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/devops/aws/" class="sidebar-link">Aws</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Linux</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/devops/linux/linux-base.html" class="sidebar-link">Linux 基础</a></li><li><a href="/devops/linux/vim.html" class="sidebar-link">Vim</a></li><li><a href="/devops/linux/ssh.html" class="sidebar-link">SSH</a></li><li><a href="/devops/linux/redirect-pipeline.html" class="sidebar-link">重定向和管道流</a></li><li><a href="/devops/linux/debian.html" class="sidebar-link">Debian</a></li><li><a href="/devops/linux/shell-base.html" class="sidebar-link">shell 基础</a></li><li><a href="/devops/linux/shell-example.html" class="sidebar-link">实用的 shell 列子</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>auth0</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/devops/auth0/auth0.html" class="sidebar-link">auth0</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Nginx</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/devops/nginx/nginx-base.html" class="sidebar-link">Nginx-包教包会-入门</a></li><li><a href="/devops/nginx/nginx-config.html" class="sidebar-link">Nginx-性能优化</a></li><li><a href="/devops/nginx/nginx-performance.html" aria-current="page" class="active sidebar-link">Nginx-包教包会-进阶</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#本文内容" class="sidebar-link">本文内容</a></li></ul></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#授权才能访问-nginx-中的资源" class="sidebar-link">授权才能访问 Nginx 中的资源</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#nginx-自带登录验证" class="sidebar-link">Nginx 自带登录验证</a></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#第三方授权访问" class="sidebar-link">第三方授权访问</a></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#ngx-http-secure-link-module" class="sidebar-link">ngx_http_secure_link_module</a></li></ul></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#基于请求限流" class="sidebar-link">基于请求限流</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#设置以什么为标识限流" class="sidebar-link">设置以什么为标识限流</a></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#设置哪些地方限流" class="sidebar-link">设置哪些地方限流</a></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#列子讲解" class="sidebar-link">列子讲解</a></li></ul></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#基于链接数限流" class="sidebar-link">基于链接数限流</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#limit-conn-zone" class="sidebar-link">limitconnzone</a></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#limit-conn-在哪里限制" class="sidebar-link">limit_conn 在哪里限制</a></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#limit-conn-status-配置限流时的响应状态码" class="sidebar-link">limitconnstatus 配置限流时的响应状态码</a></li></ul></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#基于响应带宽限制" class="sidebar-link">基于响应带宽限制</a></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#代理" class="sidebar-link">代理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#proxy-buffering" class="sidebar-link">proxy_buffering</a></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#proxy-buffer-size" class="sidebar-link">proxybuffersize</a></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#proxy-buffers" class="sidebar-link">proxy_buffers</a></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#proxy-busy-buffers-size" class="sidebar-link">proxybusybuffers_size</a></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#proxy-temp-file-write-size-一次写入临时文件的数据大小" class="sidebar-link">proxytempfilewritesize 一次写入临时文件的数据大小</a></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#proxy-temp-path-定义临时文件的目录" class="sidebar-link">proxytemppath 定义临时文件的目录</a></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#proxy-pass" class="sidebar-link">proxy_pass</a></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#proxy-set-header-传递请求头到代理服务器" class="sidebar-link">proxysetheader 传递请求头到代理服务器</a></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#proxy-pass-request-body-设置是否传递请求体到代理服务器" class="sidebar-link">proxypassrequest_body 设置是否传递请求体到代理服务器</a></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#proxy-pass-request-headers-是否将原始请求的请求头传递给代理服务器" class="sidebar-link">proxypassrequest_headers 是否将原始请求的请求头传递给代理服务器</a></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#ngx-http-proxy-module-模块支持内嵌变量" class="sidebar-link">ngxhttpproxy_module 模块支持内嵌变量</a></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#总结" class="sidebar-link">总结</a></li></ul></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#获取用户真实-ip" class="sidebar-link">获取用户真实 ip</a></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#基于代理的负载均衡" class="sidebar-link">基于代理的负载均衡</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#简单负载均衡" class="sidebar-link">简单负载均衡</a></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#server" class="sidebar-link">server</a></li><li class="sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#backup-设置备用机" class="sidebar-link">backup 设置备用机</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>数据库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>Mysql</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/devops/database/mysql/" class="sidebar-link">Mysql 基础</a></li><li><a href="/devops/database/mysql/mysql-arch.html" class="sidebar-link">Mysql 架构</a></li><li><a href="/devops/database/mysql/mysql-index.html" class="sidebar-link">Mysql索引</a></li><li><a href="/devops/database/mysql/mysql-lock-and-transaction.html" class="sidebar-link">Mysql 事务和锁</a></li><li><a href="/devops/database/mysql/mysql-explain.html" class="sidebar-link">Explain 查看执行计划</a></li><li><a href="/devops/database/mysql/mysql-limit.html" class="sidebar-link">Mysql Limit 限制</a></li><li><a href="/devops/database/mysql/mysql-data-types.html" class="sidebar-link">Mysql 数据类型</a></li><li><a href="/devops/database/mysql/mysql-account-management.html" class="sidebar-link">Mysql 用户权限管理</a></li><li><a href="/devops/database/mysql/mysql-backup-recovery.html" class="sidebar-link">Mysql数据备份与恢复</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>PostgreSql</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/devops/database/postgresql/postgresql.html" class="sidebar-link">PostgreSQL 基础</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Elasticsearch</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/devops/elasticsearch/es.html" class="sidebar-link">Elasticsearch</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Redis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/devops/redis/redis.html" class="sidebar-link">Redis 基础</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/devops/vue/vue-depoly.html" class="sidebar-link">你不知道的 SpringBoot 与 Vue 部署解决方案</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p><a href="http://mflyyou.cn/2020/03/27/nginx-bao-jiao-bao-hui-ru-men/" target="_blank" rel="noopener noreferrer">Nginx-包教包会-入门<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 一文中介绍了怎么使用 <code>Nginx</code> 搭建 web 服务器。</p> <p>但有的时候呢，我们需要对资源进行访问控制。比如说需要登录才能访问，访问链接具有时间段限制。</p> <p>又比如说防止恶意攻击，使用限流，限制带宽等等</p> <p>我们也会使用 <code>Nginx</code> 作为代理服务器，将我们的动态内容的请求转发到应用服务器去处理。</p> <p>下一期,总结一下 <code>Nginx</code> 相关的配置,给出一个配置模板</p> <h3 id="本文内容"><a href="#本文内容" class="header-anchor">#</a> 本文内容</h3> <ul><li>基于 <code>ngx_http_auth_basic_module</code>模块，使用用户名和密码限制资源的访问</li> <li>基于 <code>ngx_http_auth_request_module</code> 集成已有的授权验证</li> <li>基于 <code>ngx_http_secure_link_module</code> 限制连接的时效性和访问控制</li> <li>基于请求的限流、基于并发链接数限流，限制每个链接的带宽</li> <li>为什么要使用 Nginx 作为代理服务器及代理的配置，及获取用户的真实 ip 。</li> <li>基于代理的负载均衡</li></ul> <h2 id="授权才能访问-nginx-中的资源"><a href="#授权才能访问-nginx-中的资源" class="header-anchor">#</a> 授权才能访问 Nginx 中的资源</h2> <p>有的时候我们想简单限制用户的访问。可以使用 <code>ngx_http_auth_basic_module</code> 模块，我们预先设置好账号和密码，用户需要使用特定的用户和密码才能访问。在网站没有用户登录管理功能的时候，可以作为一个替代品。</p> <table><thead><tr><th style="text-align:left;">Syntax:</th> <th><code>auth_basic string | off;</code></th></tr></thead> <tbody><tr><td style="text-align:left;">Default:</td> <td><code>auth_basic off;</code></td></tr> <tr><td style="text-align:left;">Context:</td> <td><code>http</code>, <code>server</code>, <code>location</code>, <code>limit_except</code></td></tr></tbody></table> <table><thead><tr><th style="text-align:left;">Syntax:</th> <th><code>auth_basic_user_file file;</code></th></tr></thead> <tbody><tr><td style="text-align:left;">Default:</td> <td>—</td></tr> <tr><td style="text-align:left;">Context:</td> <td><code>http</code>, <code>server</code>, <code>location</code>, <code>limit_except</code></td></tr></tbody></table> <h3 id="nginx-自带登录验证"><a href="#nginx-自带登录验证" class="header-anchor">#</a> Nginx 自带登录验证</h3> <h4 id="密码生成"><a href="#密码生成" class="header-anchor">#</a> 密码生成</h4> <p>可以使用 <code>htpasswd</code> 生成密码，也可以使用 <code>OpenSSL</code> 生成密码。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>yum <span class="token function">install</span> httpd-tools <span class="token parameter variable">-y</span>
<span class="token comment"># htpasswd --h 可以查看帮助命令</span>

<span class="token comment"># 在指定文件位置生成，用户zhang1 和它的密码，输入之后，会让你设置你的密码</span>
htpasswd <span class="token parameter variable">-c</span> /etc/nginx/mypasswd zhang1

<span class="token comment"># 在已有的文件中添加用户 zhang2</span>
htpasswd  /etc/nginx/mypasswd zhang2
</code></pre></div><p>mypasswd 中文件的内容</p> <div class="language-txt extra-class"><pre class="language-txt"><code>zhang1:$apr1$5dvJBg5z$aY.ncM55O8caHgyOvd.G0/
zhang2:$apr1$3YUp0G3g$agIpFCfS4K3rfqn.F29VB1
</code></pre></div><h4 id="配置访问控制"><a href="#配置访问控制" class="header-anchor">#</a> 配置访问控制</h4> <p>然后再 nginx 中添加这个配置</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">auth_basic</span> <span class="token string">&quot;sdaf&quot;</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">auth_basic_user_file</span> /etc/nginx/mypasswd</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>nginx -s reload</code> 刷新配置，然后再访问资源就需要输入预先设置好的用户名和密码。</p> <h3 id="第三方授权访问"><a href="#第三方授权访问" class="header-anchor">#</a> 第三方授权访问</h3> <p><code>ngx_http_auth_basic_module</code> 尽管可以限制访问，但是作用太鸡肋了，它相当于另一套登录逻辑。它不能集成我们已有的授权功能。</p> <p><code>Nginx</code> 中的模块 <code>ngx_http_auth_request_module</code> 也支持第三方的授权的验证的。</p> <p><code>nginx -V</code> 看你的编译的模块中是否包含此模块。</p> <table><thead><tr><th>-</th> <th>说明</th></tr></thead> <tbody><tr><td>语法</td> <td><strong>auth_request</strong> <code>uri</code></td></tr> <tr><td>默认</td> <td>auth_request off;</td></tr> <tr><td>上下文</td> <td>http、server、location</td></tr></tbody></table> <p><code>auth_request</code> 启用基于子请求 (<code>uri</code>) 结果的授权。子请求返回一个 <code>2xx</code> 响应吗，则允许访问。如果返回 <code>401</code> 和 <code>403</code> 则拒绝访问。</p> <p>下面模拟一个场景进行实现。</p> <p>子请求(<code>/auth</code>)的验证基于 <code>cookie</code> 中的 <code>Authorization</code> ,存在返回 200 状态码。不存在返回 <code>403</code> 状态码。</p> <p>在 <code>nginx</code> 配置 <code>403</code> 状态码跳转到我们的登录页面。</p> <p><code>http://localhost:9090</code> 下的资源都需要限制访问。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">9090</span> default_server</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span> <span class="token string">&quot;<span class="token variable">$host</span>&quot;</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">root</span> /usr/local/var/www</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">index</span> index.html</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token comment">#  9090 下的请求，都去访问 /auth 看看有没有权限访问</span>
        <span class="token directive"><span class="token keyword">auth_request</span> /auth</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token directive"><span class="token keyword">location</span> =/auth</span> <span class="token punctuation">{</span>
        <span class="token comment"># 代理去访问我们已有的登录授权</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:8087/auth</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_pass_request_body</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Content-Length <span class="token string">&quot;&quot;</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># 403 状态码，跳转我们已有的授权登录功能</span>
    <span class="token directive"><span class="token keyword">error_page</span> <span class="token number">403</span> = @login</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">location</span> @login</span> <span class="token punctuation">{</span>
        <span class="token comment"># oriUrl 使我们用于登录成功之后的跳转链接</span>
        <span class="token directive"><span class="token keyword">return</span> <span class="token number">302</span> http://localhost:8087/login.html?oriUrl=<span class="token variable">$scheme</span>://<span class="token variable">$http_host</span><span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>用户访问资源，如果鉴权失败会跳转到登录页面，在登录页面登录之后，重新跳转到用户访问的资源路径。</p> <p>登录页面实现逻辑：点击登录，地址栏刷新地址，请求接口 <code>http://localhost:8087/login?oriUrl=xxx</code>，访问成功，接口会设置 <code>cookie</code> 并跳转到 <code>oriUrl</code> 指定的资源。</p> <p><code>login.html</code> 内容，这里我不想在写 ajax 去请求接口饭后进行跳转，所以改变浏览器地址栏</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
        登录页面,点击登录之后跳转到访问的页面.
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>login<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">&gt;</span></span>登录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
            <span class="token keyword">let</span> elementById <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            elementById<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;/login&quot;</span> <span class="token operator">+</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>search<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>服务端代码</code>，<code>http://localhost:8087</code></p> <p>服务端会鉴权接口只判断有没有 <code>Authorization</code> cookie。</p> <p>登录接口也比较简单，没有进行账号密码验证，访问既返回 cookie。并跳转。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthController</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用于资源鉴权，逻辑比较简单，就看有没有 cookie</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/auth&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">res</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Cookie</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cookies <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Cookie</span><span class="token punctuation">&gt;</span></span> authorization1 <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>cookies<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
             <span class="token class-name">String</span> value <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>authorization1<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token string">&quot;fail&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 登录逻辑，也比较简单，访问就会设置 cookie 及跳转</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RedirectView</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cookie<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cookie<span class="token punctuation">.</span><span class="token function">setDomain</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> oriUrl <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;oriUrl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">RedirectView</span> redirectView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedirectView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redirectView<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>oriUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> redirectView<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>效果演示，访问<code>http://localhost:9090/index.html</code> 的时候由于没有登录，<code>nginx</code> 错误状态码 <code>403</code> 跳转到了登录页面，在登录页面点击登录，跳转到 <code>http://localhost:9090/index.html</code></p> <p><img src="/blog/20200404234250.gif?author=zhangpanqin" alt="auth"></p> <h3 id="ngx-http-secure-link-module"><a href="#ngx-http-secure-link-module" class="header-anchor">#</a> <strong>ngx_http_secure_link_module</strong></h3> <p>有的时候呢，我们希望访问的链接具有时效性。比如微信发布的文章中，文章路径有时效性，过了这个时效性就没有办法访问了。或者有的资源必须带有一些字段我们才让其访问。</p> <h4 id="secure-link"><a href="#secure-link" class="header-anchor">#</a> secure_link</h4> <table><thead><tr><th>-</th> <th>说明</th></tr></thead> <tbody><tr><td>语法</td> <td><strong>secure_link</strong> expression;</td></tr> <tr><td>默认</td> <td>-</td></tr> <tr><td>上下文</td> <td>http、server、location</td></tr></tbody></table> <p>定义从哪里取到的链接的 md5 和 过期时间，以逗号隔开</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># 从请求参数中取链接的 md5 和过期时间</span>
<span class="token directive"><span class="token keyword">secure_link</span> <span class="token variable">$arg_md5,</span><span class="token variable">$arg_expires</span></span><span class="token punctuation">;</span>
</code></pre></div><h4 id="secure-link-md5"><a href="#secure-link-md5" class="header-anchor">#</a> secure_link_md5</h4> <table><thead><tr><th style="text-align:left;">Syntax:</th> <th><code>secure_link_md5 expression;</code></th></tr></thead> <tbody><tr><td style="text-align:left;">Default:</td> <td>—</td></tr> <tr><td style="text-align:left;">Context:</td> <td><code>http</code>, <code>server</code>, <code>location</code></td></tr></tbody></table> <p>在<code>secure_link_md5</code> 的 <code>expression</code> 中可以通过 <code>$secure_link_expires</code> (只能在 <code>secure_link_md5 expression;</code> 使用)获取链接指定的过期时间。</p> <p>nginx 会校验取到的 <code>md5</code> （secure_link 指定的第一个值）和 <code>secure_link_md5</code> 指定的 <code>expression</code> 计算出来的 <code>md5</code> 是否一致， 不一样会将 <code>secure_lin</code> 设置为 <code>&quot;&quot;</code> 。校验 md5 成功，校验过期时间，过期将 <code>secure_link</code> 设置为 <code>&quot;0”</code> ,校验成功设置为 <code>&quot;1&quot;</code> 。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /s/</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">secure_link</span> <span class="token variable">$arg_md5,</span><span class="token variable">$arg_expires</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">secure_link_md5</span> <span class="token string">&quot;123<span class="token variable">$secure_link_expires</span><span class="token variable">$uri</span> hello&quot;</span></span><span class="token punctuation">;</span>

    <span class="token comment"># md5 不一致返回空</span>
    <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$secure_link</span> = <span class="token string">&quot;&quot;</span>)</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">return</span> <span class="token number">403</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># secure_link 为 0 标识，链接过期了</span>
    <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$secure_link</span> = <span class="token string">&quot;0&quot;</span>)</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">return</span> <span class="token number">410</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们需要事先将链接计算好，然后将连接发布出去。</p> <p>比如说我想限制 <code>/s/a.jpg</code> 访问。那么我需要使用算法计算链接。比如说</p> <h4 id="shell-命令生成-md5-的值。"><a href="#shell-命令生成-md5-的值。" class="header-anchor">#</a> shell 命令生成 md5 的值。</h4> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token comment"># 服务 IP 端口</span>
<span class="token assign-left variable">IP</span><span class="token operator">=</span>localhost:8888
<span class="token assign-left variable">LINK_URL</span><span class="token operator">=</span><span class="token string">&quot;/s/a.jpg&quot;</span>
<span class="token assign-left variable">NOW</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%s<span class="token variable">)</span></span>
<span class="token assign-left variable">TIMESTAMP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>NOW <span class="token operator">+</span> <span class="token number">10</span><span class="token variable">))</span></span>
<span class="token assign-left variable">SECRET_STR</span><span class="token operator">=</span>hello

<span class="token assign-left variable">md5</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">&quot;123<span class="token variable">${TIMESTAMP}</span><span class="token variable">${LINK_URL}</span> <span class="token variable">${SECRET_STR}</span>&quot;</span> <span class="token operator">|</span> openssl md5 <span class="token parameter variable">-binary</span> <span class="token operator">|</span> openssl base64 <span class="token operator">|</span> <span class="token function">tr</span> +/ <span class="token parameter variable">-_</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token operator">=</span><span class="token variable">)</span></span>

<span class="token builtin class-name">echo</span> <span class="token string">&quot;http://<span class="token variable">${IP}</span><span class="token variable">${LINK_URL}</span>?md5=<span class="token variable">${md5}</span>&amp;expires=<span class="token variable">${TIMESTAMP}</span>&quot;</span>
</code></pre></div><p>上述脚本会打印出访问链接。</p> <h4 id="java-生成-md5-的值"><a href="#java-生成-md5-的值" class="header-anchor">#</a> java 生成 md5 的值</h4> <p>一般我们都会在服务端进行生成链接。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpSecureLink</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> site <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8888&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> secret <span class="token operator">=</span> <span class="token string">&quot; hello&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">createLink</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">long</span> expireTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> l <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEpochSecond</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;+8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> expireTime<span class="token punctuation">;</span>
        <span class="token class-name">String</span> time <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> md5 <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">encodeBase64URLSafeString</span><span class="token punctuation">(</span><span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token string">&quot;123&quot;</span> <span class="token operator">+</span> time <span class="token operator">+</span> path <span class="token operator">+</span> secret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> site <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">&quot;?md5=&quot;</span> <span class="token operator">+</span> md5 <span class="token operator">+</span> <span class="token string">&quot;&amp;expires=&quot;</span> <span class="token operator">+</span> time<span class="token punctuation">;</span>
        <span class="token keyword">return</span> url<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">createLink</span><span class="token punctuation">(</span><span class="token string">&quot;/s/a.jpg&quot;</span><span class="token punctuation">,</span> <span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>需引入 jar</p> <div class="language-txt extra-class"><pre class="language-txt"><code>&lt;dependency&gt;
    &lt;groupId&gt;commons-codec&lt;/groupId&gt;
    &lt;artifactId&gt;commons-codec&lt;/artifactId&gt;
    &lt;version&gt;1.14&lt;/version&gt;
&lt;/dependency&gt;
</code></pre></div><p>这样我们的链接就可以限制到哪些用户可以访问，还可以具有一定的时效性。</p> <h2 id="基于请求限流"><a href="#基于请求限流" class="header-anchor">#</a> 基于请求限流</h2> <p><strong>ngx_http_limit_req_module</strong> 采用 <code>漏桶算法</code> 进行限流。</p> <img src="/blog/20200405104827.png?author=zhangpanqin" alt="28171216_TJQR" style="zoom:67%;"> <p>水滴比作网络请求，当水滴超过桶的容量，请求会被拒绝。<code>漏桶算法</code>是以匀速掉落水滴（处理请求）。</p> <p>比如说 <code>rate=3r/m</code> 是 20000ms(20s) 一个匀速处理请求。nginx 是毫秒作计量单位。超过的请求就会被抛弃掉。桶的容量实际是一个队列，<strong>limit_req</strong> 中的 <code>burst</code> 配置队列的大小，burst 可以应对突发请求。</p> <p>比如 <code>rate=3r/m</code> ,那么 <code>20s</code> 处理一个请求。这 <code>20s</code> 来两个请求就会有一个请求被抛弃掉。</p> <p><code>rate=3r/m</code> 和 <code>burst=3</code> 可以应对突发请求，<code>20s</code> 内来了五个请求，一个被处理，三个请求放到缓冲队列等待处理，剩下的一个被抛弃掉。然后匀速处理请求，一个一个消耗掉队列中的请求，队列中有空余位置，又可以应对突发请求了。</p> <h3 id="设置以什么为标识限流"><a href="#设置以什么为标识限流" class="header-anchor">#</a> 设置以什么为标识限流</h3> <table><thead><tr><th>-</th> <th>说明</th></tr></thead> <tbody><tr><td>语法</td> <td><strong>limit_req_zone</strong> key zone=name:size rate=rate;</td></tr> <tr><td>默认</td> <td>-</td></tr> <tr><td>上下文</td> <td>http</td></tr></tbody></table> <p>key 可以包含文本、变量及组合。设置限制请求的标识。</p> <p>以下配置相当于根据访问用户的 <code>ip</code> 限制访问，每秒只能 10 个请求。</p> <p>比如说，我访问 <code>http://localhost:9091/2.jpg</code> 限流了，我再去访问<code>http://localhost:9091/1.jpg</code>也是会被限流。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">limit_req_zone</span> <span class="token variable">$binary_remote_addr</span> zone=one:10m rate=10r/s</span><span class="token punctuation">;</span>
</code></pre></div><p>下面这个以用户的 <code>ip</code> +访问路径为限制标识。</p> <p>比如说，我访问 <code>http://localhost:9091/2.jpg</code> 限流了，但是我可以访问 <code>http://localhost:9091/1.jpg</code>。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">limit_req_zone</span> <span class="token variable">$binary_remote_addr</span><span class="token variable">$uri</span> zone=one11:10m rate=3r/m</span><span class="token punctuation">;</span>
</code></pre></div><p><code>size</code> 相当于为设置保存 key 的空间，超过这个空间大小，就会使用缓存策略，清楚掉最近最少使用的状态。</p> <h3 id="设置哪些地方限流"><a href="#设置哪些地方限流" class="header-anchor">#</a> 设置哪些地方限流</h3> <table><thead><tr><th>-</th> <th>说明</th></tr></thead> <tbody><tr><td>语法</td> <td><strong>limit_req</strong> zone=name [burst=number] [nodelay];</td></tr> <tr><td>默认</td> <td>-</td></tr> <tr><td>上下文</td> <td>http、server、location</td></tr></tbody></table> <p>一般我们都会配置 <code>limit_req zone=one11 burst=4 nodelay;</code></p> <p><strong>nodelay</strong> 为配置缓冲队列中的请求，不延迟执行，但是队列中的空间还是需要匀速消耗请求去恢复。</p> <p>###设置限流的响应状态码</p> <table><thead><tr><th>-</th> <th>说明</th></tr></thead> <tbody><tr><td>语法</td> <td><strong>limit_req_status</strong> code;</td></tr> <tr><td>默认</td> <td><strong>limit_req_status</strong> 503;</td></tr> <tr><td>上下文</td> <td>http、server、location</td></tr></tbody></table> <p>设置拒绝请求的响应状态码。</p> <h3 id="列子讲解"><a href="#列子讲解" class="header-anchor">#</a> 列子讲解</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">limit_req_zone</span> <span class="token variable">$binary_remote_addr</span><span class="token variable">$uri</span> zone=one:10m rate=3r/m</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">9091</span> default_server</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">limit_req</span> zone=one burst=4 nodelay</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">root</span> /Users/zhangpanqin/stduy_app/break2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>缓冲队列为 4。每 20 s 处理一个请求。nodelay 让队列中的请求不延迟执行。</p> <p>第一个 20 s 内，可以处理 5 个请求。队列和匀速加一块正好五个。</p> <p>第二个 20 s 内，就只能处理 1 个请求。因为队列中的容量没有回复。</p> <p>如果接下来一段时间都没有请求处理的话，那么队列就会每 20 s 回复一个位置，回复的位置可以处理请求，这样慢慢达到 4 个。又可以 20 s 内处理 5 个请求了。</p> <p><code>limit_req_zone</code> 配置的是用户的 ip 和 path 作为限流标识。</p> <p>比如说，我访问 <code>http://localhost:9091/2.jpg</code> 五次限流之后，但是我可以访问 <code>http://localhost:9091/1.jpg</code>五次。</p> <h2 id="基于链接数限流"><a href="#基于链接数限流" class="header-anchor">#</a> 基于链接数限流</h2> <p>有的时候我们基于请求限流还不能达到我们的目的，因为瞬间流量控制不了，我上面举的例子是基于 ip 和 path 限流，如果被恶意攻击，那么可能好几百的请求被处理，这显然不符合正常用户的行为。</p> <p>比如说你有一个文件下载功能，每个文件 1 分钟只能下载一次，但是恶意攻击的话，你的 100 个文件我同时下载，这样的带宽和流量就被白白消耗了。</p> <p>针对上述情况，我们可以结合连接数限流，每个 ip 限制并发链接 5 个。这样就没有办法一次性下载 100 个文件了。</p> <p><strong>ngx_http_limit_conn_module</strong> 就是针对并发链接限制的，服务器处理了请求并读取了整个请求头，并发链接才会计数。</p> <h3 id="limit-conn-zone"><a href="#limit-conn-zone" class="header-anchor">#</a> limit_conn_zone</h3> <table><thead><tr><th>-</th> <th>说明</th></tr></thead> <tbody><tr><td>语法</td> <td><strong>limit_conn_zone</strong> key zone=name:size;</td></tr> <tr><td>默认</td> <td>-</td></tr> <tr><td>上下文</td> <td>http</td></tr></tbody></table> <p>key 用于限流标识。zone 定义存储的大小和名称。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">limit_conn_zone</span> <span class="token variable">$binary_remote_addr</span> zone=addr:10m</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="limit-conn-在哪里限制"><a href="#limit-conn-在哪里限制" class="header-anchor">#</a> limit_conn 在哪里限制</h3> <table><thead><tr><th>-</th> <th>说明</th></tr></thead> <tbody><tr><td>语法</td> <td><strong>limit_conn</strong> zone number;</td></tr> <tr><td>默认</td> <td>-</td></tr> <tr><td>上下文</td> <td>http、server、location</td></tr></tbody></table> <p>配置允许的最大并发链接数。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">limit_conn_zone</span> <span class="token variable">$binary_remote_addr</span> zone=addr:10m</span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">location</span> /download/</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">limit_conn</span> addr <span class="token number">1</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="limit-conn-status-配置限流时的响应状态码"><a href="#limit-conn-status-配置限流时的响应状态码" class="header-anchor">#</a> limit_conn_status 配置限流时的响应状态码</h3> <table><thead><tr><th>-</th> <th>说明</th></tr></thead> <tbody><tr><td>语法</td> <td><strong>limit_conn_status</strong> code;</td></tr> <tr><td>默认</td> <td>limit_conn_status 503;</td></tr> <tr><td>上下文</td> <td>http、server、location</td></tr></tbody></table> <p>配置限流时响应状态码，我们可以根据状态码跳转到提示页面。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">error_page</span> <span class="token number">503</span> = @limit2</span><span class="token punctuation">;</span>

<span class="token directive"><span class="token keyword">location</span> @limit2</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">add_header</span> Content-Type application/json</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">return</span> <span class="token number">200</span> <span class="token string">&quot;你被限流了,稍后再试&quot;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="基于响应带宽限制"><a href="#基于响应带宽限制" class="header-anchor">#</a> 基于响应带宽限制</h2> <table><thead><tr><th>-</th> <th>说明</th></tr></thead> <tbody><tr><td>语法</td> <td><strong>limit_rate</strong> rate;</td></tr> <tr><td>默认</td> <td><strong>limit_rate</strong> 0；</td></tr> <tr><td>上下文</td> <td>http、server、location、location 中的 if</td></tr></tbody></table> <p>设置为 0 标识不限制响应。rate 为字节/秒为单位。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code>
<span class="token comment"># 每秒 4k 响应</span>
<span class="token directive"><span class="token keyword">set</span> <span class="token variable">$limit_rate</span> <span class="token number">4k</span></span><span class="token punctuation">;</span>

</code></pre></div><h2 id="代理"><a href="#代理" class="header-anchor">#</a> 代理</h2> <p><strong>ngx_http_proxy_module</strong> 允许将一个请求传递给另一个服务器。</p> <p><code>nginx</code> 的代理有一个好处是，它会将客户端的请求信息全部读取之后，客户端的请求信息比较大的话，会放到临时文件中去，读取完之后请求信息之后再转发至代理服务器。这样做的好处是，降低了上游服务器的负载，缺点是延长了响应的时间，多占了内存。</p> <p>比如我们有一个上传文件的功能，直接上传服务器可能比较慢，而且还占用链接，但是我们使用 <code>nginx</code> 代理的话，它会先经过 <code>nginx</code> 上，，读取请求内容根据内容大小是否保存临时文件，然后再通过内容传输到我们的服务器。这样应用服务器的链接占用时间就会比较短（nginx 与上游的代理服务器处于内网）。而 <code>nginx</code> 占用链接的内存比较小，而且处理并发能力更强。</p> <p><code>nginx</code> 收到代理服务器的响应内容会边缓存边发送给客户端。</p> <p>我会列举一些我了解并常用的配置。</p> <h3 id="proxy-buffering"><a href="#proxy-buffering" class="header-anchor">#</a> proxy_buffering</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># 启用代理代理服务器缓冲，默认开启</span>
<span class="token directive"><span class="token keyword">proxy_buffering</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
</code></pre></div><p>启用缓存时，<code>nginx</code> 会尽可能接受来自代理服务器响应，将其保存至 <code>proxy_buffer_size</code> 和 <code>proxy_buffers</code> 指令设置的缓冲区中。内存如果放不下整个响应的话，会将一部分内容写入到临时文件中。</p> <h3 id="proxy-buffer-size"><a href="#proxy-buffer-size" class="header-anchor">#</a> proxy_buffer_size</h3> <table><thead><tr><th>-</th> <th>说明</th></tr></thead> <tbody><tr><td>语法</td> <td><strong>proxy_buffer_size</strong> size;</td></tr> <tr><td>默认</td> <td>proxy_buffer_size 4k | 8k;</td></tr> <tr><td>上下文</td> <td>http、server、location</td></tr></tbody></table> <p>设置从代理服务器读取的响应头的缓冲区大小。默认情况下等于一个系统内存页大小。建议设置成内存页的整数倍，如果响应头比较大，可以修改此部分</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 获取内存页大小</span>
getconf PAGESIZE
</code></pre></div><p>第一次测试，我返回 10m 响应体。响应头很小，低于 4k。服务端的端口为 8087。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code>@GetMapping(&quot;/proxy&quot;)
<span class="token directive"><span class="token keyword">public</span> ResponseEntity&lt;String&gt; proxy()</span><span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">final</span> String collect = Stream.generate(() -&gt;</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">return</span> <span class="token string">&quot;a&quot;</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>).limit(1024*1024*10).collect(Collectors.joining())<span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">return</span> ResponseEntity.status(200).header(<span class="token string">&quot;a&quot;</span>,<span class="token string">&quot;collect1&quot;</span>).body(collect)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>nginx 配置如下，浏览器请求 <code>http://localhost:9092/test/proxy</code>，请求成功。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code>    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">9092</span> default_server</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">location</span> /test/</span> <span class="token punctuation">{</span>
            <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:8087/</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>第二次测试，我返回 10m 响应体，外加大于 4k 的响应头。请求失败。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/proxy&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">proxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> collect <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> collect1 <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span>collect1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>collect<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>将注释打开，才能访问成功</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">9092</span> default_server</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> /test/</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:8087/</span><span class="token punctuation">;</span>
        <span class="token comment">#proxy_buffer_size 8k;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="proxy-buffers"><a href="#proxy-buffers" class="header-anchor">#</a> proxy_buffers</h3> <table><thead><tr><th>-</th> <th>说明</th></tr></thead> <tbody><tr><td>语法</td> <td><strong>proxy_buffers</strong> number size;</td></tr> <tr><td>默认</td> <td>proxy_buffers 8 4k | 8k;</td></tr> <tr><td>上下文</td> <td>http、server、location</td></tr></tbody></table> <p>设置单个连接从代理服务器读取响应的缓冲区的 number (数量)和 size (大小)。</p> <p>默认情况下，缓冲区大小等于一个内存页。为 4K 或 8K，因平台而异。</p> <p>避免设置 number 小，size 大的。比如 <code>proxy_buffers 10 1m;</code></p> <p>只需要满足缓冲区 number 乘 size 可以容纳响应体即可。</p> <p>从上游的代理服务器读取的响应内容，会存到 <code>proxy_buffers</code> 设置的缓冲区中，写满一个缓冲区，继续写下一个。当缓冲区总大小容纳不下的时候，会写到临时文件中去。已经写过的缓冲区 （size）不会被操作，除非发送给客户端。</p> <h3 id="proxy-busy-buffers-size"><a href="#proxy-busy-buffers-size" class="header-anchor">#</a> proxy_busy_buffers_size</h3> <table><thead><tr><th>-</th> <th>说明</th></tr></thead> <tbody><tr><td>语法</td> <td><strong>proxy_busy_buffers_size</strong> size;</td></tr> <tr><td>默认</td> <td>proxy_buffer_size 8k | 16k;</td></tr> <tr><td>上下文</td> <td>http、server、location</td></tr></tbody></table> <p><code>proxy_busy_buffers_size</code> 用于指定缓冲区（<code>proxy_buffers</code> 和 <code>proxy_buffer_size</code>）写入多大内容的时候往客户端发送。默认为 <code>proxy_buffers</code> 中 size 的两倍。</p> <h3 id="proxy-temp-file-write-size-一次写入临时文件的数据大小"><a href="#proxy-temp-file-write-size-一次写入临时文件的数据大小" class="header-anchor">#</a> proxy_temp_file_write_size 一次写入临时文件的数据大小</h3> <table><thead><tr><th>-</th> <th>说明</th></tr></thead> <tbody><tr><td>语法</td> <td><strong>proxy_temp_file_write_size</strong> size;</td></tr> <tr><td>默认</td> <td>proxy_temp_file_write_size 8k | 16k;</td></tr> <tr><td>上下文</td> <td>http、server、location</td></tr></tbody></table> <p>当缓冲区没法容纳从代理服务器返回的响应内容时，需要按照 <code>proxy_temp_file_write_size</code> 配置的 size 写入临时文件中</p> <h3 id="proxy-temp-path-定义临时文件的目录"><a href="#proxy-temp-path-定义临时文件的目录" class="header-anchor">#</a> proxy_temp_path 定义临时文件的目录</h3> <p>需要注意的是，worker 进程要有读写临时目录的权限，否则会丢失数据。</p> <table><thead><tr><th>-</th> <th>说明</th></tr></thead> <tbody><tr><td>语法</td> <td><strong>proxy_temp_path</strong> path [level1 [level2 [level3] ] ]</td></tr> <tr><td>默认</td> <td>proxy_temp_path proxy_temp;</td></tr> <tr><td>上下文</td> <td>http、server、location</td></tr></tbody></table> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">proxy_temp_path</span> /spool/nginx/proxy_temp <span class="token number">1</span> <span class="token number">2</span></span><span class="token punctuation">;</span>
</code></pre></div><h3 id="proxy-pass"><a href="#proxy-pass" class="header-anchor">#</a> proxy_pass</h3> <table><thead><tr><th>-</th> <th>说明</th></tr></thead> <tbody><tr><td>语法</td> <td><strong>proxy_pass</strong> URL;</td></tr> <tr><td>默认</td> <td>-</td></tr> <tr><td>上下文</td> <td>http、server、location</td></tr></tbody></table> <p>默认情况下，反向代理不会转发请求头 <code>Host</code>，如果需要转发需要配置</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
</code></pre></div><p>设置代理的 URL。会将匹配的 location 路径替换成指定的 <code>URL</code>。</p> <p><font color="red">注意这里 <code>proxy_pass</code>  是否以  <code>/</code>  结尾，处理是不一样的。</font></p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> /api/flyyou/</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:8080</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>访问 <code>http://localhost:80/api/flyyou/a</code> 会转发到 <code>http://localhost:8080/api/flyyou/a</code></p> <p><code>proxy_pass</code> 不以 <code>/</code> 结尾，会将匹配的路径追加到代理去。</p> <p>都以 <code>/</code> 就是替换，就是替换处理。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">81</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> /api/flyyou/</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:8081/</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>访问 <code>http://localhost:81/api/flyyou/a</code> 会转发到 <code>http://localhost:8081/a</code></p> <h3 id="proxy-set-header-传递请求头到代理服务器"><a href="#proxy-set-header-传递请求头到代理服务器" class="header-anchor">#</a> proxy_set_header 传递请求头到代理服务器</h3> <table><thead><tr><th>-</th> <th>说明</th></tr></thead> <tbody><tr><td>语法</td> <td>proxy_pass_header name value;</td></tr> <tr><td>默认</td> <td>-</td></tr> <tr><td>上下文</td> <td>http、server、location</td></tr></tbody></table> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">proxy_set_header</span> test1 <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$proxy_host</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">proxy_set_header</span> Connection close</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="proxy-pass-request-body-设置是否传递请求体到代理服务器"><a href="#proxy-pass-request-body-设置是否传递请求体到代理服务器" class="header-anchor">#</a> proxy_pass_request_body 设置是否传递请求体到代理服务器</h3> <table><thead><tr><th>-</th> <th>说明</th></tr></thead> <tbody><tr><td>语法</td> <td>proxy_pass_request_body on | off;</td></tr> <tr><td>默认</td> <td>proxy_pass_request_body on;</td></tr> <tr><td>上下文</td> <td>http、server、location</td></tr></tbody></table> <h3 id="proxy-pass-request-headers-是否将原始请求的请求头传递给代理服务器"><a href="#proxy-pass-request-headers-是否将原始请求的请求头传递给代理服务器" class="header-anchor">#</a> proxy_pass_request_headers 是否将原始请求的请求头传递给代理服务器</h3> <table><thead><tr><th>-</th> <th>说明</th></tr></thead> <tbody><tr><td>语法</td> <td><strong>proxy_pass_request_headers</strong> on | off;</td></tr> <tr><td>默认</td> <td>proxy_pass_request_headers on;</td></tr> <tr><td>上下文</td> <td>http、server、location</td></tr></tbody></table> <h3 id="ngx-http-proxy-module-模块支持内嵌变量"><a href="#ngx-http-proxy-module-模块支持内嵌变量" class="header-anchor">#</a> ngx_http_proxy_module 模块支持内嵌变量</h3> <ul><li><code>$proxy_host</code></li></ul> <p><code>proxy_pass</code> 指令中指定的代理服务器的名称和端口</p> <ul><li><code>$proxy_port</code></li></ul> <p>proxy_pass 指令中指定的代理服务器的端口或协议的默认端口</p> <ul><li><code>$proxy_add_x_forwarded_for</code></li></ul> <p><strong>X-Forwarded-For</strong> 客户端请求头字段，其中附加了 $remote_addr 变量，以逗号分割。</p> <p>如果客户端请求头中不存在 <strong>X-Forwarded-For</strong> 字段，则变量等于 $remote_addr 变量。</p> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <p><code>nginx</code> 作为代理服务器的时候，并发大的时候还是比较占用内存的。但是服务器的内存还要预留一部分给系统调用。</p> <p>以下设置是针对每一个请求的。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># 大于响应头即可，设置为内存页大小的倍数，getconf PAGESIZE 获取内存页大小</span>
<span class="token directive"><span class="token keyword">proxy_buffer_size</span>          <span class="token number">4k</span></span><span class="token punctuation">;</span>
<span class="token comment"># 设置大于响应体内容大小即可，在日志记录中看发送响应大小或估算，注意 size 不要设置的太大</span>
<span class="token directive"><span class="token keyword">proxy_buffers</span>              <span class="token number">32</span> <span class="token number">8k</span></span><span class="token punctuation">;</span>
<span class="token comment"># 设置为 proxy_buffers 中 size 的 2 倍</span>
<span class="token directive"><span class="token keyword">proxy_busy_buffers_size</span>    <span class="token number">16k</span></span><span class="token punctuation">;</span>
<span class="token comment"># 设置和 proxy_busy_buffers_size 一样大小</span>
<span class="token directive"><span class="token keyword">proxy_temp_file_write_size</span> <span class="token number">16k</span></span><span class="token punctuation">;</span>
<span class="token comment"># 为了便于查找文件，可以设置临时文件目录</span>
<span class="token directive"><span class="token keyword">proxy_temp_path</span>            /var/nginx/proxy_temp</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="获取用户真实-ip"><a href="#获取用户真实-ip" class="header-anchor">#</a> 获取用户真实 ip</h2> <p>当我们访问一个资源的时候，可以使用命令 <code>traceroute mflyyou.cn</code> 查看经过了哪些网关。网络运营商不会为每一个用户分配<code>公网 ip</code>，会有一个内网路由将一部分用户的请求分发到一个<code>公网 ip</code> 上去。我们能获取到的就是这个 <code>公网 ip</code>。</p> <p>有的时候我们不单单要知道用户从哪个 ip 访问的，还想知道，中间经过了哪些代理 ip。</p> <p>我使用了两个 <code>nginx</code> 和一个 java 后端服务。</p> <p><code>本地 Nginx</code> =&gt; <code>公网 Nginx</code> =&gt; 后端服务。</p> <p>本地 nginx 配置</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">9092</span> default_server</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> /test/</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://mflyyou.cn/mytest/</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_buffer_size</span> <span class="token number">8k</span></span><span class="token punctuation">;</span>
        <span class="token comment"># 记录的是用户经过了哪些 ip</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>公网 nginx 配置</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code>	<span class="token directive"><span class="token keyword">location</span> /mytest/api/</span><span class="token punctuation">{</span>
    	<span class="token comment"># 记录的是用户建立公网链接时的 ip</span>
		<span class="token directive"><span class="token keyword">proxy_set_header</span>  X-REAL-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
		<span class="token directive"><span class="token keyword">proxy_set_header</span>  X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
		<span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:8087/</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span>
</code></pre></div><p>后端 java 服务</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code>@GetMapping(&quot;/ip&quot;)
<span class="token directive"><span class="token keyword">public</span> IpData getIPData(HttpServletRequest request)</span><span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">final</span> String header = request.getHeader(<span class="token string">&quot;X-Forwarded-For&quot;</span>)</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">final</span> String realIp = request.getHeader(<span class="token string">&quot;X-REAL-IP&quot;</span>)</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">final</span> IpData ipData = new IpData()</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ipData.setXForwardFor(header)</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ipData.setXRealIp(realIp)</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">return</span> ipData</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当我本地访问 <code>http://localhost:9092/test/api/ip</code></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span> <span class="token property">&quot;xforwardFor&quot;</span><span class="token operator">:</span> <span class="token string">&quot;127.0.0.1, 155.10.116.110&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;xrealIp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;155.10.116.110&quot;</span> <span class="token punctuation">}</span>
</code></pre></div><h2 id="基于代理的负载均衡"><a href="#基于代理的负载均衡" class="header-anchor">#</a> 基于代理的负载均衡</h2> <h3 id="简单负载均衡"><a href="#简单负载均衡" class="header-anchor">#</a> 简单负载均衡</h3> <p>nginx 支付的负载均衡策略有：</p> <ul><li>轮询(<strong>round-robin</strong>) - 发送给应用服务器的请求以轮询的方式分发</li> <li>最少连接(<code>least_conn</code>) - 下一个请求被分配给具有最少数量活动连接的服务器</li> <li><strong>ip</strong> 哈希(<code>ip_hash</code>) - 使用哈希函数确定下一个请求应该选择哪一个服务器(基于客户端 的 IP 地址)</li></ul> <p>默认轮训策略。</p> <p>以下配置可以作为研究使用，实际生产不会这样配置的，一般都会转发到不同的服务器上去。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> passserver2</span> <span class="token punctuation">{</span>
    <span class="token comment"># ip_hash;</span>
    <span class="token comment"># least_conn;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8081</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8082</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8083</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">9088</span> default_server</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span> localhost</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://passserver2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">8081</span> default_server</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span> localhost</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> =/api</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">add_header</span> Content-Type application/json</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">return</span> <span class="token number">200</span> <span class="token string">&quot;我是 8081 服务器&quot;</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">8082</span> default_server</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span> localhost</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> =/api</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">add_header</span> Content-Type application/json</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">return</span> <span class="token number">200</span> <span class="token string">&quot;我是 8082 服务器&quot;</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">8083</span> default_server</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span> localhost</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> =/api</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">add_header</span> Content-Type application/json</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">return</span> <span class="token number">200</span> <span class="token string">&quot;我是 8083 服务器&quot;</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="server"><a href="#server" class="header-anchor">#</a> server</h3> <table><thead><tr><th>-</th> <th>说明</th></tr></thead> <tbody><tr><td>语法</td> <td><strong>server</strong> address [parameters];</td></tr> <tr><td>默认</td> <td>-</td></tr> <tr><td>上下文</td> <td>upstream</td></tr></tbody></table> <p>我们也可以通过 <code>parameters</code> 给应用服务器设置更细粒度的控制。</p> <p>有一些参数需要商用 <code>nginx</code> 才能使用，我就没有列出来。</p> <h4 id="weight-控制权重"><a href="#weight-控制权重" class="header-anchor">#</a> weight 控制权重</h4> <p>weight=number;</p> <p>weight 默认为 1。通过设置权重，会让某个服务有更多的概率处理请求。</p> <p>通常可以将服务器配置比较高的服务器设置的权重更大。</p> <p>8081 会有 3/6 的概率。</p> <p>8082 会有 2/6 的概率。</p> <p>8083 会有 1/6 的概率。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> passserver2</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8081 weight=3</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8082 weight=2</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8083</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="max-fails-配置允许的失败次数"><a href="#max-fails-配置允许的失败次数" class="header-anchor">#</a> max_fails 配置允许的失败次数</h4> <p>max_fails=number</p> <p>默认为 1。需要与 <code>fail_timeout</code> 配合使用。表示 <code>fail_timeout</code> 内允许的失败次数，超过之后，就不会分配请求。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> passserver2</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8081 weight=3 max_fails=3 fail_timeout=15</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8082 weight=2</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8083</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="fail-timeout"><a href="#fail-timeout" class="header-anchor">#</a> fail_timeout</h4> <p>fail_timeout=time</p> <p>默认 10 秒。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> passserver2</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8081 weight=3 max_fails=3 fail_timeout=15</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8082 weight=2</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8083</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="backup-设置备用机"><a href="#backup-设置备用机" class="header-anchor">#</a> backup 设置备用机</h3> <p>当别的服务器都挂了之后才会启动服务。</p> <p>8081 和 8082 都挂掉之后，8083 才开始提供服务。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> passserver2</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8081 weight=3 max_fails=3 fail_timeout=15</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8082 weight=2</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8083 backup</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="max-conns-限定服务器的最大连接数"><a href="#max-conns-限定服务器的最大连接数" class="header-anchor">#</a> max_conns 限定服务器的最大连接数</h4> <p>max_conns=number</p> <p>指定某个服务器的最大连接数，超过这个数，不会分配新的请求，除非低于这个数。</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> passserver2</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8081 weight=3 max_fails=3 fail_timeout=15</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8082 weight=2 max_conns=1000</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8083 backup</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/zhangpanqin/mflyyou/edit/main/docs/devops/nginx/nginx-performance.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/3/24 下午12:28:55</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
            ←
            <a href="/devops/nginx/nginx-config.html" class="prev">
                Nginx-性能优化
            </a></span> <span class="next"><a href="/devops/database/mysql/">
                Mysql 基础
            </a>
            →
        </span></p></div> </main> <aside class="right-sidebar"> <div class="right-sidebar-toc-container" style="display:;"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:650px"><div style="font-weight:bold;text-align:center;">Nginx-包教包会-进阶</div> <hr> <div class="toc-box"><ul><li><a href="/devops/nginx/nginx-performance.html#前言" class="toc-sidebar-link">前言</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#本文内容" class="toc-sidebar-link">本文内容</a></li></ul></li><li><a href="/devops/nginx/nginx-performance.html#授权才能访问-nginx-中的资源" class="toc-sidebar-link">授权才能访问 Nginx 中的资源</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#nginx-自带登录验证" class="toc-sidebar-link">Nginx 自带登录验证</a></li><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#第三方授权访问" class="toc-sidebar-link">第三方授权访问</a></li><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#ngx-http-secure-link-module" class="toc-sidebar-link">ngx_http_secure_link_module</a></li></ul></li><li><a href="/devops/nginx/nginx-performance.html#基于请求限流" class="toc-sidebar-link">基于请求限流</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#设置以什么为标识限流" class="toc-sidebar-link">设置以什么为标识限流</a></li><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#设置哪些地方限流" class="toc-sidebar-link">设置哪些地方限流</a></li><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#列子讲解" class="toc-sidebar-link">列子讲解</a></li></ul></li><li><a href="/devops/nginx/nginx-performance.html#基于链接数限流" class="toc-sidebar-link">基于链接数限流</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#limit-conn-zone" class="toc-sidebar-link">limitconnzone</a></li><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#limit-conn-在哪里限制" class="toc-sidebar-link">limit_conn 在哪里限制</a></li><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#limit-conn-status-配置限流时的响应状态码" class="toc-sidebar-link">limitconnstatus 配置限流时的响应状态码</a></li></ul></li><li><a href="/devops/nginx/nginx-performance.html#基于响应带宽限制" class="toc-sidebar-link">基于响应带宽限制</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/devops/nginx/nginx-performance.html#代理" class="toc-sidebar-link">代理</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#proxy-buffering" class="toc-sidebar-link">proxy_buffering</a></li><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#proxy-buffer-size" class="toc-sidebar-link">proxybuffersize</a></li><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#proxy-buffers" class="toc-sidebar-link">proxy_buffers</a></li><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#proxy-busy-buffers-size" class="toc-sidebar-link">proxybusybuffers_size</a></li><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#proxy-temp-file-write-size-一次写入临时文件的数据大小" class="toc-sidebar-link">proxytempfilewritesize 一次写入临时文件的数据大小</a></li><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#proxy-temp-path-定义临时文件的目录" class="toc-sidebar-link">proxytemppath 定义临时文件的目录</a></li><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#proxy-pass" class="toc-sidebar-link">proxy_pass</a></li><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#proxy-set-header-传递请求头到代理服务器" class="toc-sidebar-link">proxysetheader 传递请求头到代理服务器</a></li><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#proxy-pass-request-body-设置是否传递请求体到代理服务器" class="toc-sidebar-link">proxypassrequest_body 设置是否传递请求体到代理服务器</a></li><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#proxy-pass-request-headers-是否将原始请求的请求头传递给代理服务器" class="toc-sidebar-link">proxypassrequest_headers 是否将原始请求的请求头传递给代理服务器</a></li><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#ngx-http-proxy-module-模块支持内嵌变量" class="toc-sidebar-link">ngxhttpproxy_module 模块支持内嵌变量</a></li><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#总结" class="toc-sidebar-link">总结</a></li></ul></li><li><a href="/devops/nginx/nginx-performance.html#获取用户真实-ip" class="toc-sidebar-link">获取用户真实 ip</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/devops/nginx/nginx-performance.html#基于代理的负载均衡" class="toc-sidebar-link">基于代理的负载均衡</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#简单负载均衡" class="toc-sidebar-link">简单负载均衡</a></li><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#server" class="toc-sidebar-link">server</a></li><li class="toc-sidebar-sub-header"><a href="/devops/nginx/nginx-performance.html#backup-设置备用机" class="toc-sidebar-link">backup 设置备用机</a></li></ul></li></ul></div></div></div></div> <div class="right-sidebar-toolbar"><div class="option-box"><img src="/images/system/toc.png" class="nozoom"> <span class="show-txt">目录</span></div> <div class="option-box"><img src="/images/system/toggle.png" width="30px" class="nozoom"> <span class="show-txt">左栏</span></div> <div title="Nginx-性能优化" class="option-box" style="padding-left:2px;text-align:center;"><a href="/devops/nginx/nginx-config.html"><img src="/images/system/pre2.png" width="30px" class="nozoom"> <span class="show-txt">上一篇</span></a></div> <div title="Mysql 基础" class="option-box" style="padding-left:2px;text-align:center;"><a href="/devops/database/mysql/"><img src="/images/system/next2.png" width="30px" class="nozoom"> <span class="show-txt">下一篇</span></a></div></div> </aside></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.c876b023.js" defer></script><script src="/assets/js/5.f1c50b28.js" defer></script><script src="/assets/js/2.85c620a8.js" defer></script><script src="/assets/js/56.1f5db295.js" defer></script><script src="/assets/js/11.66cb8558.js" defer></script>
  </body>
</html>
