<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring Data Jpa | Mflyyou</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="张攀钦的笔记">
    <meta name="theme-color" content="#3eaf7c">
    
    <link rel="preload" href="/assets/css/0.styles.0ce27dc8.css" as="style"><link rel="preload" href="/assets/js/app.c876b023.js" as="script"><link rel="preload" href="/assets/js/5.f1c50b28.js" as="script"><link rel="preload" href="/assets/js/2.85c620a8.js" as="script"><link rel="preload" href="/assets/js/86.8083d1e3.js" as="script"><link rel="preload" href="/assets/js/11.66cb8558.js" as="script"><link rel="prefetch" href="/assets/js/10.9d78016d.js"><link rel="prefetch" href="/assets/js/100.d3ccb03a.js"><link rel="prefetch" href="/assets/js/101.db6336a9.js"><link rel="prefetch" href="/assets/js/102.dff088bb.js"><link rel="prefetch" href="/assets/js/103.87b5352b.js"><link rel="prefetch" href="/assets/js/104.e7e828d9.js"><link rel="prefetch" href="/assets/js/105.a0308ea1.js"><link rel="prefetch" href="/assets/js/106.7da8a737.js"><link rel="prefetch" href="/assets/js/12.2e1232ac.js"><link rel="prefetch" href="/assets/js/13.1fa48f49.js"><link rel="prefetch" href="/assets/js/14.88c327e5.js"><link rel="prefetch" href="/assets/js/15.886666ee.js"><link rel="prefetch" href="/assets/js/16.ff3aceaf.js"><link rel="prefetch" href="/assets/js/17.eadbe78e.js"><link rel="prefetch" href="/assets/js/18.cd8f2138.js"><link rel="prefetch" href="/assets/js/19.b44d07c7.js"><link rel="prefetch" href="/assets/js/20.74e35385.js"><link rel="prefetch" href="/assets/js/21.765405a2.js"><link rel="prefetch" href="/assets/js/22.2f152ee9.js"><link rel="prefetch" href="/assets/js/23.ac30fbae.js"><link rel="prefetch" href="/assets/js/24.711f90e7.js"><link rel="prefetch" href="/assets/js/25.d3d81640.js"><link rel="prefetch" href="/assets/js/26.95e73776.js"><link rel="prefetch" href="/assets/js/27.6a6bee8c.js"><link rel="prefetch" href="/assets/js/28.c23d3233.js"><link rel="prefetch" href="/assets/js/29.e7f501b7.js"><link rel="prefetch" href="/assets/js/3.fd75c0a5.js"><link rel="prefetch" href="/assets/js/30.160d973d.js"><link rel="prefetch" href="/assets/js/31.62e9ec91.js"><link rel="prefetch" href="/assets/js/32.63450723.js"><link rel="prefetch" href="/assets/js/33.6a9fe332.js"><link rel="prefetch" href="/assets/js/34.dc78c409.js"><link rel="prefetch" href="/assets/js/35.819eb997.js"><link rel="prefetch" href="/assets/js/36.6f0dd57b.js"><link rel="prefetch" href="/assets/js/37.97cff2db.js"><link rel="prefetch" href="/assets/js/38.42474606.js"><link rel="prefetch" href="/assets/js/39.22279c24.js"><link rel="prefetch" href="/assets/js/4.1d7c8e50.js"><link rel="prefetch" href="/assets/js/40.c79b3ee7.js"><link rel="prefetch" href="/assets/js/41.95abde40.js"><link rel="prefetch" href="/assets/js/42.1a49cfd4.js"><link rel="prefetch" href="/assets/js/43.d4322a35.js"><link rel="prefetch" href="/assets/js/44.d7f9ac42.js"><link rel="prefetch" href="/assets/js/45.531ba324.js"><link rel="prefetch" href="/assets/js/46.0ae453bf.js"><link rel="prefetch" href="/assets/js/47.5c18d38d.js"><link rel="prefetch" href="/assets/js/48.4df5e318.js"><link rel="prefetch" href="/assets/js/49.faafeee6.js"><link rel="prefetch" href="/assets/js/50.dc72e991.js"><link rel="prefetch" href="/assets/js/51.da69b59a.js"><link rel="prefetch" href="/assets/js/52.18528bef.js"><link rel="prefetch" href="/assets/js/53.090cfc3f.js"><link rel="prefetch" href="/assets/js/54.87b885f3.js"><link rel="prefetch" href="/assets/js/55.d191ddc1.js"><link rel="prefetch" href="/assets/js/56.1f5db295.js"><link rel="prefetch" href="/assets/js/57.4668a9cd.js"><link rel="prefetch" href="/assets/js/58.2459bcea.js"><link rel="prefetch" href="/assets/js/59.45048184.js"><link rel="prefetch" href="/assets/js/6.0b5d6365.js"><link rel="prefetch" href="/assets/js/60.2db0a1a8.js"><link rel="prefetch" href="/assets/js/61.b4db17d2.js"><link rel="prefetch" href="/assets/js/62.4aa9c88c.js"><link rel="prefetch" href="/assets/js/63.687d4393.js"><link rel="prefetch" href="/assets/js/64.da286e35.js"><link rel="prefetch" href="/assets/js/65.0048315d.js"><link rel="prefetch" href="/assets/js/66.842b0f76.js"><link rel="prefetch" href="/assets/js/67.ca23d6c3.js"><link rel="prefetch" href="/assets/js/68.af55b577.js"><link rel="prefetch" href="/assets/js/69.3faac7ab.js"><link rel="prefetch" href="/assets/js/7.c6b9ef78.js"><link rel="prefetch" href="/assets/js/70.10aac9ff.js"><link rel="prefetch" href="/assets/js/71.518c4fa7.js"><link rel="prefetch" href="/assets/js/72.37b67ecc.js"><link rel="prefetch" href="/assets/js/73.7aebaed8.js"><link rel="prefetch" href="/assets/js/74.d44ba387.js"><link rel="prefetch" href="/assets/js/75.938e5d60.js"><link rel="prefetch" href="/assets/js/76.b4c99a45.js"><link rel="prefetch" href="/assets/js/77.a9ba8193.js"><link rel="prefetch" href="/assets/js/78.3cb7672c.js"><link rel="prefetch" href="/assets/js/79.31c9f385.js"><link rel="prefetch" href="/assets/js/8.2e49308c.js"><link rel="prefetch" href="/assets/js/80.076d581b.js"><link rel="prefetch" href="/assets/js/81.56b7bfb0.js"><link rel="prefetch" href="/assets/js/82.1b4546de.js"><link rel="prefetch" href="/assets/js/83.647327e8.js"><link rel="prefetch" href="/assets/js/84.d3e47f47.js"><link rel="prefetch" href="/assets/js/85.e87c4084.js"><link rel="prefetch" href="/assets/js/87.7dcfa72d.js"><link rel="prefetch" href="/assets/js/88.06082791.js"><link rel="prefetch" href="/assets/js/89.ab52b490.js"><link rel="prefetch" href="/assets/js/9.64727c80.js"><link rel="prefetch" href="/assets/js/90.a1265b3f.js"><link rel="prefetch" href="/assets/js/91.05480ab6.js"><link rel="prefetch" href="/assets/js/92.d116ed0a.js"><link rel="prefetch" href="/assets/js/93.74379bdc.js"><link rel="prefetch" href="/assets/js/94.3ca7ca9a.js"><link rel="prefetch" href="/assets/js/95.be2c08bf.js"><link rel="prefetch" href="/assets/js/96.4fde0d8d.js"><link rel="prefetch" href="/assets/js/97.22bb863f.js"><link rel="prefetch" href="/assets/js/98.4eeef762.js"><link rel="prefetch" href="/assets/js/99.ca987746.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0ce27dc8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Mflyyou</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/java/base/java-messy-code.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/go/base/go-command.html" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/springboot/project-sumary/" class="nav-link">
  SpringBoot
</a></div><div class="nav-item"><a href="/tcp-ip/http/http-cors-jsonp/" class="nav-link">
  TCP/IP
</a></div><div class="nav-item"><a href="/dev-tools/asdf/" class="nav-link">
  开发工具
</a></div><div class="nav-item"><a href="/devops/docker/" class="nav-link">
  DevOps
</a></div> <a href="https://github.com/zhangpanqin/mflyyou" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/java/base/java-messy-code.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/go/base/go-command.html" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/springboot/project-sumary/" class="nav-link">
  SpringBoot
</a></div><div class="nav-item"><a href="/tcp-ip/http/http-cors-jsonp/" class="nav-link">
  TCP/IP
</a></div><div class="nav-item"><a href="/dev-tools/asdf/" class="nav-link">
  开发工具
</a></div><div class="nav-item"><a href="/devops/docker/" class="nav-link">
  DevOps
</a></div> <a href="https://github.com/zhangpanqin/mflyyou" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/springboot/project-sumary.html" class="sidebar-link">项目总结</a></li><li><a href="/springboot/externalized-configuration.html" class="sidebar-link">属性配置</a></li><li><a href="/springboot/datasource.html" class="sidebar-link">数据库连接池</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>目前在做的项目使用的是 Spring Data Jpa，以前都是使用 Mybatis ，前段时间研究了 JPA 的使用。</p> <p>目前公司项目的架构许多的技术点是我没有实践过的，所以我这段时间在学习这些东西，从 2021-5-15 开始博客的更新尽量保证一周一篇。</p> <p>下周更新 GraphQL 。</p> <p>本文例子全部在 <a href="https://github.com/zhangpanqin/jpa-study" target="_blank" rel="noopener noreferrer">https://github.com/zhangpanqin/jpa-study<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ,数据库使用的是内存数据库 H2。</p> <h2 id="jpa"><a href="#jpa" class="header-anchor">#</a> JPA</h2> <h3 id="认识-jpa"><a href="#认识-jpa" class="header-anchor">#</a> 认识 JPA</h3> <p><code>JPA</code> 是 <code>Java Persistence API</code> 的简称，定义了 Java 对象与数据库表的映射关系，以及定义运行时期怎么 CRUD 的接口规范。</p> <p><code>Hibernate</code> 提供了 JPA 的实现。除此之外还有别的实现，比如 Open Jpa 等等。</p> <p>Spring Data 为数据访问提供了一个熟悉且一致的，基于 Spring 的编程模型，同时仍保留基础数据存储的特殊特征。</p> <ul><li><p>Spring Data JPA 用于操作关系型数据库</p></li> <li><p>Spring Data MongoDB 用于操作 MongoDB</p></li> <li><p>Spring Data Elasticsearch 用于操作 Es</p></li> <li><p>Spring Data Redis 用于操作 Redis</p></li></ul> <p><code>Spring Data JPA</code> 底层的 JPA 实现采用的是 <code>Hibernate</code> ，也可以说是封装了 <code>Hibernate</code>，提供了 Spring 统一的编程模型。</p> <p>统一的编程模型是指：下面这段代码，可以操作 JPA，ES，Redis 等等，只是 Person 上的注解不一样。</p> <p>又可以通过更换 CrudRepository 接口，提供更细粒度的不同数据库的数据控制。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PersonRepository</span> <span class="token keyword">extends</span> <span class="token class-name">CrudRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByLastname</span><span class="token punctuation">(</span><span class="token class-name">String</span> lastname<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByFirstnameLike</span><span class="token punctuation">(</span><span class="token class-name">String</span> firstname<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="jpa-常用注解介绍"><a href="#jpa-常用注解介绍" class="header-anchor">#</a> JPA 常用注解介绍</h3> <p><font color="red">使用 JPA 的时候不要使用数据库的外键，一是影响性能，二是不利于更换数据库。</font></p> <p><font color="red">不要使用  <code>Hibernate</code>  生成表结构，使用 flyway 组件，通过 SQL 来控制数据库表、索引，字段管理，flyway 灵活性更强</font></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;sys_user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysUserEntity</span> <span class="token keyword">extends</span> <span class="token class-name">BaseEntity</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> nickname<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>

    <span class="token comment">/**
     * name 定义的是关联表字段,referencedColumnName 是当前表中的主键字段
     */</span>
    <span class="token annotation punctuation">@OneToMany</span><span class="token punctuation">(</span>fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span><span class="token constant">EAGER</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token constant">USER_ID</span><span class="token punctuation">,</span>referencedColumnName <span class="token operator">=</span> <span class="token constant">ID</span><span class="token punctuation">,</span>foreignKey <span class="token operator">=</span><span class="token annotation punctuation">@ForeignKey</span><span class="token punctuation">(</span><span class="token constant">NO_CONSTRAINT</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysBlogEntity</span><span class="token punctuation">&gt;</span></span> sysBlogEntities<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="entity"><a href="#entity" class="header-anchor">#</a> @Entity</h4> <p>标记该类是一个 Entity ,被 JPA 管理</p> <h4 id="table"><a href="#table" class="header-anchor">#</a> @Table</h4> <p>指定 Entity 与数据库中的那个表映射</p> <h4 id="joincolumn"><a href="#joincolumn" class="header-anchor">#</a> @JoinColumn</h4> <p>指定了两个关联表之间使用哪两个字段关联</p> <h4 id="column"><a href="#column" class="header-anchor">#</a> @Column</h4> <p>指定了 Entity 字段与表的那个字段关联</p> <h4 id="id"><a href="#id" class="header-anchor">#</a> @Id</h4> <p>指定主键字段</p> <h4 id="generatedvalue"><a href="#generatedvalue" class="header-anchor">#</a> @GeneratedValue</h4> <p>指定主键的生成策略，下文详细介绍</p> <h4 id="transient"><a href="#transient" class="header-anchor">#</a> @Transient</h4> <p>忽略字段与表字段的映射关系</p> <h4 id="onetomany"><a href="#onetomany" class="header-anchor">#</a> @OneToMany</h4> <p>一对多关系指定，当前 Entity 与另一个 Entity 的映射关系。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
  * name 定义的是关联表字段,referencedColumnName 是当前表中的主键字段
  */</span>
<span class="token annotation punctuation">@OneToMany</span><span class="token punctuation">(</span>fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span><span class="token constant">EAGER</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token constant">USER_ID</span><span class="token punctuation">,</span>referencedColumnName <span class="token operator">=</span> <span class="token constant">ID</span><span class="token punctuation">,</span>foreignKey <span class="token operator">=</span><span class="token annotation punctuation">@ForeignKey</span><span class="token punctuation">(</span><span class="token constant">NO_CONSTRAINT</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysBlogEntity</span><span class="token punctuation">&gt;</span></span> sysBlogEntities<span class="token punctuation">;</span>
</code></pre></div><h4 id="manytoone"><a href="#manytoone" class="header-anchor">#</a> @ManyToOne</h4> <p>参考 OneToMany</p> <h4 id="manytomany"><a href="#manytomany" class="header-anchor">#</a> @ManyToMany</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
  * @JoinTable 指定中间表,及中间表中的字段映射
  * @JoinColumn(name = ROLE_ID,referencedColumnName = ID) 指定了中间表的字段(name) 和另一个表那个字段关联(referencedColumnName)
  */</span>
<span class="token annotation punctuation">@ManyToMany</span>
<span class="token annotation punctuation">@JoinTable</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token constant">SYS_USER_ROLE</span><span class="token punctuation">,</span> joinColumns <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token constant">USER_ID</span><span class="token punctuation">,</span> referencedColumnName <span class="token operator">=</span> <span class="token constant">ID</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
           inverseJoinColumns <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token constant">ROLE_ID</span><span class="token punctuation">,</span>referencedColumnName <span class="token operator">=</span> <span class="token constant">ID</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysRoleEntity</span><span class="token punctuation">&gt;</span></span> sysRoleEntities<span class="token punctuation">;</span>
</code></pre></div><h4 id="onetoone"><a href="#onetoone" class="header-anchor">#</a> @OneToOne</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@OneToOne</span><span class="token punctuation">(</span>optional<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;CUSTREC_ID&quot;</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">,</span> updatable<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">CustomerRecord</span> customerRecord<span class="token punctuation">;</span>
</code></pre></div><h4 id="query"><a href="#query" class="header-anchor">#</a> @Query</h4> <p>可以写 SQL 操作数据库</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SysBlogRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysBlogEntity</span><span class="token punctuation">,</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span>nativeQuery <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>value <span class="token operator">=</span> <span class="token string">&quot;select  * from sys_blog where user_id = :userId&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysBlogEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByUserId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span>nativeQuery <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">,</span>value <span class="token operator">=</span> <span class="token string">&quot;select  * from sys_blog where title = :#{#sysBlogDTO.title}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysBlogEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByTitle</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;sysBlogDTO&quot;</span><span class="token punctuation">)</span> <span class="token class-name">SysBlogDTO</span> sysBlogDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="主键生成策略"><a href="#主键生成策略" class="header-anchor">#</a> 主键生成策略</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * strategy 取值
 *
 * AUTO 由程序控制，默认策略。Oracle 默认是 SEQUENCE，Mysql默认是 IDENTITY
 *
 * IDENTITY： 主键自增长，需要在表中定义表字段自增长，Mysql ，PostgreSQL，SQL Server 可以采用）
 *
 * SEQUENCE：使用序列作为主键 ，Oracle、PostgreSQL、DB2 可以使用
 * @GeneratedValue(strategy = GenerationType.SEQUENCE, generator = &quot;emailSeq&quot;)
 * @SequenceGenerator(initialValue = 1, name = &quot;emailSeq&quot;, sequenceName = &quot;EMAIL_SEQUENCE&quot;)
 * private long id;
 * 然后再数据库创建一个序列 create sequence EMAIL_SEQUENCE;
 * 当不在 SequenceGenerator 指定 sequenceName ，默认使用 Hibernate 提供的序列名称为 hibernate_sequence
 *
 * TABLE 一般不适用这一个
 */</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">GeneratedValue</span> <span class="token punctuation">{</span>
    <span class="token class-name">GenerationType</span> <span class="token function">strategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token constant">AUTO</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="主键生成策略例子"><a href="#主键生成策略例子" class="header-anchor">#</a> 主键生成策略例子</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Table</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KeyGeneratorEntity</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>generator <span class="token operator">=</span> <span class="token string">&quot;system-uuid&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GenericGenerator</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;system-uuid&quot;</span><span class="token punctuation">,</span>strategy <span class="token operator">=</span> <span class="token string">&quot;uuid&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">KeyGeneratorRepositoryTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">KeyGeneratorRepository</span> keyGeneratorRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">KeyGeneratorEntity</span> keyGeneratorEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KeyGeneratorEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keyGeneratorEntity<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keyGeneratorRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>keyGeneratorEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KeyGeneratorEntity</span><span class="token punctuation">&gt;</span></span> all <span class="token operator">=</span> keyGeneratorRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// [KeyGeneratorEntity(id=ff808081796f260c01796f2616aa0000, username=2021-05-15T16:30:37.722)]</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>all<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>hibernate 提供了以下主键生成策略</p> <p>当 <code>@GeneratedValue(strategy = GenerationType.SEQUENCE)</code> 使用的是 <code>SequenceStyleGenerator.class</code> 控制主键生成。</p> <p>当 <code>@GenericGenerator(name = &quot;system-uuid&quot;,strategy = &quot;uuid&quot;)</code> ，使用的是 <code>UUIDHexGenerator.class</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultIdentifierGeneratorFactory</span>
		<span class="token keyword">implements</span> <span class="token class-name">MutableIdentifierGeneratorFactory</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span><span class="token punctuation">,</span> <span class="token class-name">ServiceRegistryAwareService</span> <span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&gt;</span></span> generatorStrategyToClassNameMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;deprecation&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">DefaultIdentifierGeneratorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">register</span><span class="token punctuation">(</span> <span class="token string">&quot;uuid2&quot;</span><span class="token punctuation">,</span> <span class="token class-name">UUIDGenerator</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">register</span><span class="token punctuation">(</span> <span class="token string">&quot;guid&quot;</span><span class="token punctuation">,</span> <span class="token class-name">GUIDGenerator</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// can be done with UUIDGenerator + strategy</span>
		<span class="token function">register</span><span class="token punctuation">(</span> <span class="token string">&quot;uuid&quot;</span><span class="token punctuation">,</span> <span class="token class-name">UUIDHexGenerator</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// &quot;deprecated&quot; for new use</span>
		<span class="token function">register</span><span class="token punctuation">(</span> <span class="token string">&quot;uuid.hex&quot;</span><span class="token punctuation">,</span> <span class="token class-name">UUIDHexGenerator</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">// uuid.hex is deprecated</span>
		<span class="token function">register</span><span class="token punctuation">(</span> <span class="token string">&quot;assigned&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Assigned</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">register</span><span class="token punctuation">(</span> <span class="token string">&quot;identity&quot;</span><span class="token punctuation">,</span> <span class="token class-name">IdentityGenerator</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">register</span><span class="token punctuation">(</span> <span class="token string">&quot;select&quot;</span><span class="token punctuation">,</span> <span class="token class-name">SelectGenerator</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">register</span><span class="token punctuation">(</span> <span class="token string">&quot;sequence&quot;</span><span class="token punctuation">,</span> <span class="token class-name">SequenceStyleGenerator</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">register</span><span class="token punctuation">(</span> <span class="token string">&quot;seqhilo&quot;</span><span class="token punctuation">,</span> <span class="token class-name">SequenceHiLoGenerator</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">register</span><span class="token punctuation">(</span> <span class="token string">&quot;increment&quot;</span><span class="token punctuation">,</span> <span class="token class-name">IncrementGenerator</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">register</span><span class="token punctuation">(</span> <span class="token string">&quot;foreign&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ForeignGenerator</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">register</span><span class="token punctuation">(</span> <span class="token string">&quot;sequence-identity&quot;</span><span class="token punctuation">,</span> <span class="token class-name">SequenceIdentityGenerator</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">register</span><span class="token punctuation">(</span> <span class="token string">&quot;enhanced-sequence&quot;</span><span class="token punctuation">,</span> <span class="token class-name">SequenceStyleGenerator</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">register</span><span class="token punctuation">(</span> <span class="token string">&quot;enhanced-table&quot;</span><span class="token punctuation">,</span> <span class="token class-name">TableGenerator</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">String</span> strategy<span class="token punctuation">,</span> <span class="token class-name">Class</span> generatorClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debugf</span><span class="token punctuation">(</span> <span class="token string">&quot;Registering IdentifierGenerator strategy [%s] -&gt; [%s]&quot;</span><span class="token punctuation">,</span> strategy<span class="token punctuation">,</span> generatorClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token class-name">Class</span> previous <span class="token operator">=</span> generatorStrategyToClassNameMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span> strategy<span class="token punctuation">,</span> generatorClass <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span> previous <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debugf</span><span class="token punctuation">(</span> <span class="token string">&quot;    - overriding [%s]&quot;</span><span class="token punctuation">,</span> previous<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="lazy-需要在一个事务内执行"><a href="#lazy-需要在一个事务内执行" class="header-anchor">#</a> Lazy 需要在一个事务内执行</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order1</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> description<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@OneToMany</span><span class="token punctuation">(</span>fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span><span class="token constant">LAZY</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;order_id&quot;</span><span class="token punctuation">,</span>referencedColumnName <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>foreignKey <span class="token operator">=</span><span class="token annotation punctuation">@ForeignKey</span><span class="token punctuation">(</span><span class="token constant">NO_CONSTRAINT</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItem</span><span class="token punctuation">&gt;</span></span> orderItemList<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//    @Transactional(readOnly = true)</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order1</span><span class="token punctuation">&gt;</span></span> <span class="token function">listOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;---------------------开始查询---------------------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order1</span><span class="token punctuation">&gt;</span></span> all <span class="token operator">=</span> orderRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;---------------------开始懒加载---------------------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>all<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> all<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当数据需要懒加载的时候，JPA 不会查询 <code>Lazy</code> 的数据，只有在使用的时候才会查询，但是使用的时候需要和原来的查询在同一个事务中,不然会抛出以下异常</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>hibernate<span class="token punctuation">.</span></span>LazyInitializationException</span><span class="token operator">:</span> failed <span class="token keyword">to</span> <span class="token namespace">lazily</span> initialize a collection of role<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mflyyou<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span>n1<span class="token punctuation">.</span></span>Order1</span><span class="token punctuation">.</span>orderItemList<span class="token punctuation">,</span> could not initialize proxy <span class="token operator">-</span> no <span class="token class-name">Session</span>
</code></pre></div><p>由于没有开启事务，orderRepository.findAll() 执行之后这个查询事务就关闭了，所以获取 Order1.orderItemList 的时候报错。</p> <p>当添加事务注解 <code>@Transactional</code> ，整个方法在一个事务内执行，就不会报错了。</p> <h3 id="n-1-问题"><a href="#n-1-问题" class="header-anchor">#</a> N+1 问题</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;order1&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order1</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> description<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@OneToMany</span><span class="token punctuation">(</span>fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span><span class="token constant">LAZY</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;order_id&quot;</span><span class="token punctuation">,</span>referencedColumnName <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>foreignKey <span class="token operator">=</span><span class="token annotation punctuation">@ForeignKey</span><span class="token punctuation">(</span><span class="token constant">NO_CONSTRAINT</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItem</span><span class="token punctuation">&gt;</span></span> orderItemList<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>readOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Order1</span> <span class="token function">findOne</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;---------------------开始查询---------------------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order1</span><span class="token punctuation">&gt;</span></span> byId <span class="token operator">=</span> orderRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;---------------------开始懒加载---------------------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>byId<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> byId<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当查询 <code>Order1</code> 的时候，实际上不会查询 <code>orderItemList</code> ,当使用 <code>orderItemList</code> 的时候在查询一次。</p> <p>当 <code>Order1</code> 有 N 个关联属性的时候，就会查询 N 次来获取对应的数据。</p> <p>当数据都处于 <code>FetchType.LAZY</code> 获取数据，就会产生懒加载问题</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>开始查询<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>开始查询<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token class-name">Hibernate</span><span class="token operator">:</span>
    select
        order1x0_<span class="token punctuation">.</span>id as id1_2_0_<span class="token punctuation">,</span>
        order1x0_<span class="token punctuation">.</span>description as descript2_2_0_
    from
        order1 order1x0_
    where
        order1x0_<span class="token punctuation">.</span>id<span class="token operator">=</span><span class="token operator">?</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>开始懒加载<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token class-name">Hibernate</span><span class="token operator">:</span>
    select
        orderiteml0_<span class="token punctuation">.</span>order_id as order_id3_3_0_<span class="token punctuation">,</span>
        orderiteml0_<span class="token punctuation">.</span>id as id1_3_0_<span class="token punctuation">,</span>
        orderiteml0_<span class="token punctuation">.</span>id as id1_3_1_<span class="token punctuation">,</span>
        orderiteml0_<span class="token punctuation">.</span>name as name2_3_1_<span class="token punctuation">,</span>
        orderiteml0_<span class="token punctuation">.</span>order_id as order_id3_3_1_<span class="token punctuation">,</span>
        orderiteml0_<span class="token punctuation">.</span>price as price4_3_1_
    from
        order_item orderiteml0_
    where
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;测试2021-05-15T17:35:50.349&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;orderItemList&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ceshi2021-05-15T17:35:50.423&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;orderId&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ceshi2021-05-15T17:35:50.423&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;orderId&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ceshi2021-05-15T17:35:50.423&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;orderId&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ceshi2021-05-15T17:35:50.423&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;orderId&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ceshi2021-05-15T17:35:50.423&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;orderId&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">10</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>解决办法呢，可以使用 <code>@OneToMany(fetch = FetchType.EAGER)</code> 。</p> <p>查询一次获取了全部数据</p> <div class="language-txt extra-class"><pre class="language-txt"><code>Hibernate:
    select
        order1x0_.id as id1_2_0_,
        order1x0_.description as descript2_2_0_,
        orderiteml1_.order_id as order_id3_3_1_,
        orderiteml1_.id as id1_3_1_,
        orderiteml1_.id as id1_3_2_,
        orderiteml1_.name as name2_3_2_,
        orderiteml1_.order_id as order_id3_3_2_,
        orderiteml1_.price as price4_3_2_
    from
        order1 order1x0_
    left outer join
        order_item orderiteml1_
            on order1x0_.id=orderiteml1_.order_id
    where
        order1x0_.id=?
</code></pre></div><p>当出现 orderItemList 和 orderItemList2 的时候，@OneToMany(fetch = FetchType.EAGER) 会报错</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order1</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> description<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@OneToMany</span><span class="token punctuation">(</span>fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span><span class="token constant">EAGER</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;order_id&quot;</span><span class="token punctuation">,</span>referencedColumnName <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>foreignKey <span class="token operator">=</span><span class="token annotation punctuation">@ForeignKey</span><span class="token punctuation">(</span><span class="token constant">NO_CONSTRAINT</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItem</span><span class="token punctuation">&gt;</span></span> orderItemList<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@OneToMany</span><span class="token punctuation">(</span>fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span><span class="token constant">EAGER</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;order_id&quot;</span><span class="token punctuation">,</span>referencedColumnName <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>foreignKey <span class="token operator">=</span><span class="token annotation punctuation">@ForeignKey</span><span class="token punctuation">(</span><span class="token constant">NO_CONSTRAINT</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItem2</span><span class="token punctuation">&gt;</span></span> orderItemList2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>@NamedEntityGraph</code> 和 <code>@EntityGraph</code> 可以解决 N+1 问题。又可以解决级联查询的时候，查询哪些成员变量，不查询哪些成员变量。让我们可以根据业务有更高的自由度查询数据。</p> <h3 id="entitygraph"><a href="#entitygraph" class="header-anchor">#</a> EntityGraph</h3> <p><code>@NamedEntityGraph</code> 定义查询的时候查询哪些数据，<code>@EntityGraph</code> 用于标记 Repository 使用哪个 <code>NamedEntityGraph</code> 。</p> <p><img src="/blog/20210516132930.png?author=zhangpanqin" alt="image-20210516132930802"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;order1&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NamedEntityGraph</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;searchOrderGraphItem&quot;</span><span class="token punctuation">,</span>
        attributeNodes <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@NamedAttributeNode</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;orderGraphItemList&quot;</span><span class="token punctuation">,</span> subgraph <span class="token operator">=</span> <span class="token string">&quot;OrderGraphItem_productGraphs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        subgraphs <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@NamedSubgraph</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;OrderGraphItem_productGraphs&quot;</span><span class="token punctuation">,</span> attributeNodes <span class="token operator">=</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@NamedAttributeNode</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;productGraphs&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderGraph1</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> description<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@OneToMany</span><span class="token punctuation">(</span>fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span><span class="token constant">EAGER</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;order_id&quot;</span><span class="token punctuation">,</span> referencedColumnName <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> foreignKey <span class="token operator">=</span> <span class="token annotation punctuation">@ForeignKey</span><span class="token punctuation">(</span><span class="token constant">NO_CONSTRAINT</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderGraphItem</span><span class="token punctuation">&gt;</span></span> orderGraphItemList<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@OneToMany</span><span class="token punctuation">(</span>fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span><span class="token constant">EAGER</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;order_id&quot;</span><span class="token punctuation">,</span> referencedColumnName <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> foreignKey <span class="token operator">=</span> <span class="token annotation punctuation">@ForeignKey</span><span class="token punctuation">(</span><span class="token constant">NO_CONSTRAINT</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderGraphItem2</span><span class="token punctuation">&gt;</span></span> orderGraphItemList2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderGraphRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderGraph1</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@EntityGraph</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;searchOrderGraphItem&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">EntityGraph<span class="token punctuation">.</span>EntityGraphType</span><span class="token punctuation">.</span><span class="token constant">FETCH</span><span class="token punctuation">)</span>
    <span class="token class-name">OrderGraph1</span> <span class="token function">findByIdEquals</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">OrderGraph1</span> orderGraph1s <span class="token operator">=</span> orderGraphService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertThat</span><span class="token punctuation">(</span>orderGraph1s<span class="token punctuation">,</span> <span class="token function">notNullValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>@EntityGraph</code> 中指定的的 <code>type</code> 可以取值 <code>FETCH</code>与 <code>LOAD</code></p> <ul><li>FETCH 对于 <code>NamedEntityGraph</code> 定义的 <code>attributeNodes</code> 使用 eager，未声明的使用 lazy</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EntityGraph</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;searchOrderGraphItem&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">EntityGraph<span class="token punctuation">.</span>EntityGraphType</span><span class="token punctuation">.</span><span class="token constant">FETCH</span><span class="token punctuation">)</span>
<span class="token class-name">OrderGraph1</span> <span class="token function">findByIdEquals</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>只会查询出 OrderGraph1 对应表中的字段和 orderGraphItemList。orderGraphItemList2 当用的时候才会查询。</p> <ul><li>LOAD 对于 <code>NamedEntityGraph</code> 定义的 <code>attributeNodes</code> 使用 eager，未声明的属性使用属性配置的 <code>FetchType</code></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EntityGraph</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;searchOrderGraphItem&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">EntityGraph<span class="token punctuation">.</span>EntityGraphType</span><span class="token punctuation">.</span><span class="token constant">LOAD</span><span class="token punctuation">)</span>
<span class="token class-name">OrderGraph1</span> <span class="token function">findByIdEquals</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这个会查询出 OrderGraph1 对应表中的字段和 orderGraphItemList。orderGraphItemList2 属性由于配置的是 <code>FetchType.EAGER</code> ,也会直接查出来。</p> <p>orderGraphItemList2 属性如果配置的是 <code>FetchType.Lazy</code> ,orderGraphItemList2 使用的时候才会被查出来</p> <h3 id="审计功能"><a href="#审计功能" class="header-anchor">#</a> 审计功能</h3> <p>一般表中都会有，主键 id ,创建时间 ，更新事件，谁创建，谁更新，再加上乐观锁。</p> <p>实现 <code>AuditorAware</code>，填充用户 id。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@MappedSuperclass</span>
<span class="token annotation punctuation">@EntityListeners</span><span class="token punctuation">(</span><span class="token class-name">AuditingEntityListener</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BaseEntity</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 创建时间
     */</span>
    <span class="token annotation punctuation">@CreatedDate</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;create_date&quot;</span><span class="token punctuation">,</span> updatable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Instant</span> createDate<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 修改时间
     */</span>
    <span class="token annotation punctuation">@LastModifiedDate</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;update_date&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Instant</span> updateDate<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 被谁创建
     */</span>
    <span class="token annotation punctuation">@CreatedBy</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;create_by&quot;</span><span class="token punctuation">,</span> updatable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> createBy<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 被谁修改
     */</span>
    <span class="token annotation punctuation">@LastModifiedBy</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;update_by&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> updateBy<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 乐观锁
     */</span>
    <span class="token annotation punctuation">@Version</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;version&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> version <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyAuditorAware</span> <span class="token keyword">implements</span> <span class="token class-name">AuditorAware</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 获取当前登录的 id
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCurrentAuditor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 在请求头获取登录标识,再查询用户主键 id</span>
        <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>乐观锁，更新的 version 必须等于数据库中的版本，否则更新会抛出异常。也可以使用 <code>Spring-retry</code> 捕获 <code>ObjectOptimisticLockingFailureException</code> 重试更新。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;sys_user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysUserEntity</span> <span class="token keyword">extends</span> <span class="token class-name">BaseEntity</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> nickname<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">JpaStudyApplicationTests</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> <span class="token constant">USER_ID_EQUALS_1</span> <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> <span class="token constant">USER_ID_EQUALS_2</span> <span class="token operator">=</span> <span class="token number">2L</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> <span class="token constant">USER_ID_EQUALS_3</span> <span class="token operator">=</span> <span class="token number">3L</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">SysUserRepository</span> sysUserRepository<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">SysUserEntity</span> saveSysUserEntity<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">SysUserEntity</span> saveSysUserEntity2<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">SysUserEntity</span> saveSysUserEntity3<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        saveSysUserEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SysUserEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        saveSysUserEntity<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        saveSysUserEntity<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token constant">USER_ID_EQUALS_1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        saveSysUserEntity<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token string">&quot;测试&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        saveSysUserEntity<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        saveSysUserEntity2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SysUserEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        saveSysUserEntity2<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        saveSysUserEntity2<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token constant">USER_ID_EQUALS_2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        saveSysUserEntity2<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token string">&quot;测试&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        saveSysUserEntity2<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        saveSysUserEntity3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SysUserEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        saveSysUserEntity3<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        saveSysUserEntity3<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token constant">USER_ID_EQUALS_3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        saveSysUserEntity3<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token string">&quot;测试&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        saveSysUserEntity3<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">should_update_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sysUserRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>saveSysUserEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUserEntity</span><span class="token punctuation">&gt;</span></span> byId <span class="token operator">=</span> sysUserRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token constant">USER_ID_EQUALS_1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>byId<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">is</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">SysUserEntity</span> sysUserEntity <span class="token operator">=</span> byId<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置版本 2 也报错</span>
<span class="token comment">//        sysUserEntity.setVersion(2L);</span>
        sysUserEntity<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token number">12L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sysUserEntity<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token string">&quot;乐观锁更新&quot;</span> <span class="token operator">+</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Executable</span> executable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> sysUserRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>sysUserEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThrows</span><span class="token punctuation">(</span><span class="token class-name">ObjectOptimisticLockingFailureException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> executable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">should_update_success</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sysUserRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>saveSysUserEntity2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUserEntity</span><span class="token punctuation">&gt;</span></span> byId <span class="token operator">=</span> sysUserRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token constant">USER_ID_EQUALS_2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>byId<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">is</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SysUserEntity</span> sysUserEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SysUserEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sysUserEntity<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token constant">USER_ID_EQUALS_2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sysUserEntity<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sysUserEntity<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token string">&quot;乐观锁更新&quot;</span> <span class="token operator">+</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SysUserEntity</span> save <span class="token operator">=</span> sysUserRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>sysUserEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>save<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">is</span><span class="token punctuation">(</span><span class="token number">11L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/zhangpanqin/mflyyou/edit/main/docs/springboot/jpa/jpa.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/3/24 下午12:28:55</span></div></footer> <!----> </main> <aside class="right-sidebar"> <div class="right-sidebar-toc-container" style="display:;"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:650px"><div style="font-weight:bold;text-align:center;">Spring Data Jpa</div> <hr> <div class="toc-box"><ul><li><a href="/springboot/jpa/jpa.html#前言" class="toc-sidebar-link">前言</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/springboot/jpa/jpa.html#jpa" class="toc-sidebar-link">JPA</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/springboot/jpa/jpa.html#认识-jpa" class="toc-sidebar-link">认识 JPA</a></li><li class="toc-sidebar-sub-header"><a href="/springboot/jpa/jpa.html#jpa-常用注解介绍" class="toc-sidebar-link">JPA 常用注解介绍</a></li><li class="toc-sidebar-sub-header"><a href="/springboot/jpa/jpa.html#lazy-需要在一个事务内执行" class="toc-sidebar-link">Lazy 需要在一个事务内执行</a></li><li class="toc-sidebar-sub-header"><a href="/springboot/jpa/jpa.html#n-1-问题" class="toc-sidebar-link">N+1 问题</a></li><li class="toc-sidebar-sub-header"><a href="/springboot/jpa/jpa.html#entitygraph" class="toc-sidebar-link">EntityGraph</a></li><li class="toc-sidebar-sub-header"><a href="/springboot/jpa/jpa.html#审计功能" class="toc-sidebar-link">审计功能</a></li></ul></li></ul></div></div></div></div> <div class="right-sidebar-toolbar"><div class="option-box"><img src="/images/system/toc.png" class="nozoom"> <span class="show-txt">目录</span></div> <div class="option-box"><img src="/images/system/toggle.png" width="30px" class="nozoom"> <span class="show-txt">左栏</span></div> <!----> <!----></div> </aside></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.c876b023.js" defer></script><script src="/assets/js/5.f1c50b28.js" defer></script><script src="/assets/js/2.85c620a8.js" defer></script><script src="/assets/js/86.8083d1e3.js" defer></script><script src="/assets/js/11.66cb8558.js" defer></script>
  </body>
</html>
