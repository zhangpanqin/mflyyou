(window.webpackJsonp=window.webpackJsonp||[]).push([[56],{407:function(t,a,s){"use strict";s.r(a);var e=s(9),n=Object(e.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),a("p",[a("code",[t._v("Nginx")]),t._v(" 作为 "),a("code",[t._v("web 服务器")]),t._v(" 以低内存，高扩展，并且轻松单机支持 "),a("code",[t._v("1-3w")]),t._v(" （据说可以单机 10w，但没有看到具体的机器配置）的并发链接的特性广受开发人员的青睐。")]),t._v(" "),a("p",[t._v("推荐在 "),a("code",[t._v("linux")]),t._v(" 系统上使用 "),a("code",[t._v("Nginx")]),t._v(" ，这会充分利用 "),a("code",[t._v("linux")]),t._v(" 的特性，性能比在 "),a("code",[t._v("windows")]),t._v(" 上会更好。")]),t._v(" "),a("p",[t._v("本文主要内容：")]),t._v(" "),a("ul",[a("li",[t._v("Nginx 简单配置")]),t._v(" "),a("li",[t._v("root 和 alias 的区别")]),t._v(" "),a("li",[t._v("location 的优先级及验证")]),t._v(" "),a("li",[t._v("Nginx 内置变量介绍")]),t._v(" "),a("li",[t._v("if")]),t._v(" "),a("li",[t._v("rewrite 转发")]),t._v(" "),a("li",[t._v("try_files")]),t._v(" "),a("li",[t._v("配置 gzip")]),t._v(" "),a("li",[t._v("协商缓存和强缓存的介绍和配置")])]),t._v(" "),a("p",[t._v("后续章节，我会使用 "),a("code",[t._v("ab")]),t._v(" 压测来一步一步优化 "),a("code",[t._v("Nginx")]),t._v(" 的配置，Nginx 知道原理，懂得常用配置即可。有的性能优化需要了解 "),a("code",[t._v("linux 内核")]),t._v(" 、"),a("code",[t._v("http")]),t._v("、"),a("code",[t._v("tcp")]),t._v(" 相关的东西，如果你不想了解，可以记录一份自己的配置即可，不必纠结为什么。")]),t._v(" "),a("p",[t._v("本文内容在 "),a("code",[t._v("nginx 1.16.1")]),t._v(" 上测试，"),a("code",[t._v("Centos 7")]),t._v(" 4 核 8g 内存的虚拟机。")]),t._v(" "),a("h2",{attrs:{id:"nginx-安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx-安装"}},[t._v("#")]),t._v(" Nginx 安装")]),t._v(" "),a("h3",{attrs:{id:"docker"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker"}},[t._v("#")]),t._v(" docker")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" pull nginx:1.25.0-alpine3.17-slim\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" ~/docker-nginx/html "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" ~/docker-nginx/nginx/conf.d\n\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" run "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-it")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" mflyyou-nginx "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\nnginx:1.25.0-alpine3.17-slim\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" mflyyou-nginx:/etc/nginx/conf.d/default.conf ~/docker-nginx/nginx/conf.d/default.conf\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" mflyyou-nginx:/etc/nginx/nginx.conf ~/docker-nginx/nginx/nginx.conf\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" mflyyou-nginx:/usr/share/nginx/html ~/docker-nginx/\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" container stop mflyyou-nginx\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" container "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" mflyyou-nginx\n\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" run "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-it")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" mflyyou-nginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(":80 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" ~/docker-nginx/nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" ~/docker-nginx/nginx/nginx.conf:/etc/nginx/nginx.conf "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" ~/docker-nginx/html:/usr/share/nginx/html "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\nnginx:1.25.0-alpine3.17-slim\n\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-it")]),t._v(" mflyyou-nginx "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sh")]),t._v("\n")])])]),a("h3",{attrs:{id:"nginx-安装步骤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx-安装步骤"}},[t._v("#")]),t._v(" Nginx 安装步骤")]),t._v(" "),a("p",[t._v("根据 "),a("a",{attrs:{href:"https://developer.aliyun.com/mirror/centos",target:"_blank",rel:"noopener noreferrer"}},[t._v("阿里 CentOS 镜像"),a("OutboundLink")],1),t._v(" 配置 "),a("code",[t._v("yum")]),t._v(" 源，提高下载速度。")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://developer.aliyun.com/mirror/epel",target:"_blank",rel:"noopener noreferrer"}},[t._v("阿里 epel 镜像"),a("OutboundLink")],1),t._v(" 配置我们常用软件的包，"),a("code",[t._v("Nginx")]),t._v(" 也在其中。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 运行一下命令，更新 yum 源")]),t._v("\nyum clean all\nyum makecache\n")])])]),a("p",[t._v("刷新 "),a("code",[t._v("yum")]),t._v(" 仓库信息之后，运行以下命令就可以找到 "),a("code",[t._v("nginx")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("yum list "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" nginx\n")])])]),a("p",[t._v("安装 "),a("code",[t._v("nginx")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" yum "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" nginx\n")])])]),a("p",[t._v("配置 "),a("code",[t._v("nginx")]),t._v(" 开机启动")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" nginx\n")])])]),a("p",[t._v("启动 "),a("code",[t._v("nginx")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl start nginx\n")])])]),a("p",[t._v("检查 "),a("code",[t._v("nginx")]),t._v(" 是否启动")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl status nginx\n")])])]),a("p",[a("img",{attrs:{src:"/blog/20200327220547.png?author=zhangpanqin",alt:"image-20200327220547818"}})]),t._v(" "),a("p",[t._v("如果想查看 "),a("code",[t._v("nginx")]),t._v("包都安装了哪些文件，可以使用")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("rpm")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-qvl")]),t._v(" nginx\n")])])]),a("p",[a("img",{attrs:{src:"/blog/20200327221058.png?author=zhangpanqin",alt:"image-20200327221058643"}})]),t._v(" "),a("h3",{attrs:{id:"nginx-命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx-命令"}},[t._v("#")]),t._v(" Nginx 命令")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 强制立即关闭，不建议做")]),t._v("\nnginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-s")]),t._v(" stop\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 正常关闭，会处理已经接到的请求，但不会接受新的请求")]),t._v("\nnginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-s")]),t._v(" quit\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 重新加载配置文件")]),t._v("\nnginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-s")]),t._v(" reload\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  重新打开日志文件")]),t._v("\nnginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-s")]),t._v(" reopen\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 检查配置文件是否有误")]),t._v("\nnginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-t")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 检查配置文件是否有误，会将配置文件内容打印")]),t._v("\nnginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-T")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看 nginx 版本")]),t._v("\nnginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看 nginx 版本和编译配置致残")]),t._v("\nnginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-V")]),t._v("\n")])])]),a("h3",{attrs:{id:"系统开启、关闭、重启、查看-nginx-命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#系统开启、关闭、重启、查看-nginx-命令"}},[t._v("#")]),t._v(" 系统开启、关闭、重启、查看 nginx 命令")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" nginx\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl start nginx\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl restart nginx\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl stop nginx\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl status nginx\n")])])]),a("h2",{attrs:{id:"nginx-简单配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx-简单配置"}},[t._v("#")]),t._v(" Nginx 简单配置")]),t._v(" "),a("h3",{attrs:{id:"nginx-介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx-介绍"}},[t._v("#")]),t._v(" Nginx 介绍")]),t._v(" "),a("p",[t._v("部署的 "),a("code",[t._v("Nginx")]),t._v(" 使用一个 "),a("code",[t._v("master")]),t._v(" 进程管理多个 "),a("code",[t._v("worker")]),t._v(" 进程。"),a("code",[t._v("master")]),t._v(" 进程不处理请求，提供管理服务，包括启动、停止、重载配置文件等服务，通常以 "),a("code",[t._v("root")]),t._v(" 用户启动， "),a("code",[t._v("worker")]),t._v(" 进程进行请求的处理，一般用非管理员账户启用，"),a("code",[t._v("worker")]),t._v(" 进程数量和 cpu 核心设置一直，降低进程切换带来的 "),a("code",[t._v("cpu")]),t._v(" 切换。")]),t._v(" "),a("p",[a("img",{attrs:{src:"/blog/20200327222127.png?author=zhangpanqin",alt:"image-20200327222127446"}})]),t._v(" "),a("p",[a("code",[t._v("http")]),t._v(" 上下文中的配置是我们重点需要知道的，其余的了解会配置即可。")]),t._v(" "),a("h3",{attrs:{id:"server-配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#server-配置"}},[t._v("#")]),t._v(" Server 配置")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("http")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("include")]),t._v(" /etc/nginx/mime.types")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default_type")]),t._v(" application/octet-stream")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v(" _")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" /usr/share/nginx/html")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[a("code",[t._v("Server")]),t._v(" 既配置一个服务。")]),t._v(" "),a("p",[a("code",[t._v("listen 80")]),t._v(" 用于配置监听 "),a("code",[t._v("80")]),t._v(" 端口的服务。")]),t._v(" "),a("p",[a("code",[t._v("root")]),t._v(" 指定静态资源存放的位置。")]),t._v(" "),a("p",[t._v("location 进行资源匹配。"),a("code",[t._v("location / {}")]),t._v(" 匹配所有的资源。")]),t._v(" "),a("h3",{attrs:{id:"listen-和-server-name-配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#listen-和-server-name-配置"}},[t._v("#")]),t._v(" "),a("code",[t._v("listen")]),t._v(" 和 "),a("code",[t._v("server_name")]),t._v(" 配置")]),t._v(" "),a("p",[t._v("匹配规则：")]),t._v(" "),a("ul",[a("li",[t._v("先匹配 "),a("code",[t._v("listen")]),t._v(" 再匹配 "),a("code",[t._v("server_name")])]),t._v(" "),a("li",[a("code",[t._v("server_name")]),t._v(" 匹配请求头中的 "),a("code",[t._v("Host")])]),t._v(" "),a("li",[t._v("当都没有匹配成功，由配置"),a("code",[t._v("default_server")]),t._v(" 的处理")]),t._v(" "),a("li",[t._v("以上都没有匹配成功，由第一个配置处理")])]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9099")]),t._v(" default_server")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"localhost"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"server_name 为 localhost"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9099")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v(" 127.0.0.1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    \t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"server_name 为 127.0.0.1"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9099")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"localhost77"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    \t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"server_name 为 localhost77"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("在 "),a("code",[t._v("Postman")]),t._v("中设置请求头 "),a("code",[t._v("Host")]),t._v(" 模拟访问。")]),t._v(" "),a("p",[a("code",[t._v("http://localhost:9099")]),t._v(" Host:"),a("code",[t._v("127.0.0.1")]),t._v(" 返回 "),a("code",[t._v("server_name 为 127.0.0.1")])]),t._v(" "),a("p",[a("code",[t._v("http://localhost:9099")]),t._v(" Host:"),a("code",[t._v("localhost")]),t._v(" 返回 "),a("code",[t._v("server_name 为 localhost")])]),t._v(" "),a("p",[a("code",[t._v("http://localhost:9099")]),t._v(" Host:"),a("code",[t._v("localhost77")]),t._v(" 返回 "),a("code",[t._v("server_name 为 localhost77")])]),t._v(" "),a("p",[a("code",[t._v("http://localhost:9099")]),t._v(" Host:"),a("code",[t._v("localhost779")]),t._v(" 返回 "),a("code",[t._v("server_name 为 localhost")])]),t._v(" "),a("p",[t._v("再添加一个配置")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v(" localhost:9099 default_server")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"localhost"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"server_name 为 localhost:9099"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("当 "),a("code",[t._v("listen")]),t._v(" 访问 "),a("code",[t._v("localhost:9099")]),t._v(" 的时候，返回 "),a("code",[t._v("server_name 为 localhost:9099")]),t._v(" ，因为只有这一个匹配上了。")]),t._v(" "),a("p",[t._v("如果想禁止没有 "),a("code",[t._v("Host")]),t._v(" 请求头的访问。")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 表示 nginx 会关闭连接")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("444")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"return-配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#return-配置"}},[t._v("#")]),t._v(" "),a("code",[t._v("return")]),t._v(" 配置")]),t._v(" "),a("p",[a("code",[t._v("return")]),t._v(" 用于定义返回的状态码，或者内容。")]),t._v(" "),a("p",[t._v("介绍 "),a("code",[t._v("return")]),t._v(" 主要是为了好描述 "),a("code",[t._v("location")]),t._v(" 配置")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("-")]),t._v(" "),a("th",[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("语法")]),t._v(" "),a("td",[t._v("return code [text];"),a("br"),t._v("return code URL;"),a("br"),t._v("return URL ;")])]),t._v(" "),a("tr",[a("td",[t._v("默认")]),t._v(" "),a("td",[t._v("-")])]),t._v(" "),a("tr",[a("td",[t._v("上下文")]),t._v(" "),a("td",[t._v("server、location、if")])])])]),t._v(" "),a("p",[a("code",[t._v("code")]),t._v(" 为状态码。"),a("code",[t._v("text")]),t._v(" 为字符串。")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /a")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default_type")]),t._v(" application/json")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"访问 9088/a"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 重定向")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" = /b")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("301")]),t._v(" http://www.baidu.com")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"location-配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#location-配置"}},[t._v("#")]),t._v(" "),a("code",[t._v("location")]),t._v(" 配置")]),t._v(" "),a("p",[a("code",[t._v("location")]),t._v(" 用于匹配资源。")]),t._v(" "),a("p",[a("font",{attrs:{color:"red"}},[t._v("数字越小，优先级越高。")])],1),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("规则符号")]),t._v(" "),a("th",[t._v("描述")]),t._v(" "),a("th",[t._v("优先级")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("location "),a("code",[t._v("=")]),t._v(" /a{}")]),t._v(" "),a("td",[t._v("精准完全匹配，匹配到之后")]),t._v(" "),a("td",[t._v("1")])]),t._v(" "),a("tr",[a("td",[t._v("location "),a("code",[t._v("^~")]),t._v(" /a{}")]),t._v(" "),a("td",[t._v("前缀匹配，匹配到之后")]),t._v(" "),a("td",[t._v("2")])]),t._v(" "),a("tr",[a("td",[t._v("location ~ /a.*{}")]),t._v(" "),a("td",[t._v("正则匹配，区分大小写，检查到之后，还会检查有没有优先级跟高的")]),t._v(" "),a("td",[t._v("3")])]),t._v(" "),a("tr",[a("td",[t._v("location ~_ /a._")]),t._v(" "),a("td",[t._v("正则匹配，不区分字母大小写，检查到之后，还会检查有没有优先级跟高的")]),t._v(" "),a("td",[t._v("4")])]),t._v(" "),a("tr",[a("td",[t._v("location /a {}")]),t._v(" "),a("td",[t._v("也表示前缀匹配，但是优先级低于 正则匹配。 "),a("code",[t._v("/a")]),t._v(" 和 "),a("code",[t._v("^~/a")]),t._v(" 会冲突，报错")]),t._v(" "),a("td",[t._v("5")])]),t._v(" "),a("tr",[a("td",[t._v("location / {}")]),t._v(" "),a("td",[t._v("任何没有匹配成功的，都会匹配这里处理")]),t._v(" "),a("td",[t._v("6")])])])]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9088")]),t._v(" default_server")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v(" _")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" = /a")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default_type")]),t._v(" application/json")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"= /a,优先级第一"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" ^~ /a")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default_type")]),t._v(" application/json")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"^~ /a 匹配 /a 开头的路径,优先级第二"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" ~ /a\\.*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default_type")]),t._v(" application/json")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('" /a\\.* 匹配 /a...路径,优先级第三"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" ~* /a\\.*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default_type")]),t._v(" application/json")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"~* /a\\.* 匹配 /a...路径,优先级第四"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    \t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# /a 会和 ^~ /a 冲突")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /a/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default_type")]),t._v(" application/json")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/a/ 匹配 /a/...路径,优先级第五"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("访问 "),a("code",[t._v("http://localhost:9088/a")]),t._v(" ，依次注释优先级较高的，可以验证这个规律。")]),t._v(" "),a("p",[t._v("还有一类特殊的 "),a("code",[t._v("location")]),t._v(" 用于配置跳转的，以 "),a("code",[t._v("@")]),t._v(" 开头")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" @pass")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"add-header-添加响应头"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#add-header-添加响应头"}},[t._v("#")]),t._v(" add_header 添加响应头")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("-")]),t._v(" "),a("th",[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("语法")]),t._v(" "),a("td",[t._v("add_header name value [always];")])]),t._v(" "),a("tr",[a("td",[t._v("默认")]),t._v(" "),a("td",[t._v("-")])]),t._v(" "),a("tr",[a("td",[t._v("上下文")]),t._v(" "),a("td",[t._v("http、server、location、location 中的 if")])])])]),t._v(" "),a("p",[t._v("如果响应代码等于 200、201、204、206、301、302、303、304、307 或 308，则将指定的字段添加到响应报头中。")]),t._v(" "),a("p",[t._v("加上 "),a("code",[t._v("always")]),t._v(" 不管什么状态码都加上。")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" ~ /a\\.*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default_type")]),t._v(" application/json")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_header")]),t._v(" test1 "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"asdfasdf"')]),t._v(" always")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('" /a\\.* 匹配 /a...路径,优先级第三"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"error-page"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#error-page"}},[t._v("#")]),t._v(" error_page")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("-")]),t._v(" "),a("th",[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("语法")]),t._v(" "),a("td",[a("code",[t._v("error_page code …[=[response code]] uri;")])])]),t._v(" "),a("tr",[a("td",[t._v("默认")]),t._v(" "),a("td",[t._v("-")])]),t._v(" "),a("tr",[a("td",[t._v("上下文")]),t._v(" "),a("td",[t._v("http、server、location、location 中的 if")])])])]),t._v(" "),a("p",[t._v("配置错误状态码跳转页面。")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("error_page")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("404")]),t._v(" /404.html")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("error_page")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("500")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("502")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("503")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("504")]),t._v(" /50x.html")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("以上不会改变响应状态码。")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 改变响应状态吗。")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("error_page")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("404")]),t._v(" =200 /404.html")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n       "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("error_page")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("404")]),t._v(" =  @ops-coffee")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" @ops-coffee")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n       "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rewrite")]),t._v("  .*  / permanent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"root-和-alias-的区别"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#root-和-alias-的区别"}},[t._v("#")]),t._v(" root 和 alias 的区别")]),t._v(" "),a("p",[a("code",[t._v("alias")]),t._v(" 理解为：路径替换，location 以 "),a("code",[t._v("/")]),t._v(" 结尾，alias 必须以 "),a("code",[t._v("/")]),t._v(" 结尾。严格匹配。"),a("code",[t._v("alias")]),t._v(" 替换掉 "),a("code",[t._v("location")]),t._v(" 路径。")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# /bieming/     替换  /usr/local/var/www/alias2/")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 访问 /bieming/1.jpg 去寻找 /usr/local/var/www/alias2/1.jpg")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /bieming/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("alias")]),t._v(" /usr/local/var/www/alias2/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[a("code",[t._v("root")]),t._v(" 理解为：root 路径加上 + "),a("code",[t._v("location")]),t._v(" 路径。会将两个或更多个 "),a("code",[t._v("/")]),t._v(" 压缩成一个。")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 当 location 和 root 路径的最后一部分匹配时，更好的方式是使用 root")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## 以下配置都可以。")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 访问 /data2/1.jpg   去寻找  /usr/local/var/www/data2/1.jpg")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /data2/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" /usr/local/var/www")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /data2/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" /usr/local/var/www/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /data2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" /usr/local/var/www")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /data2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" /usr/local/var/www/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /data2/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" /usr/local/var/www////")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"内置变量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#内置变量"}},[t._v("#")]),t._v(" 内置变量")]),t._v(" "),a("p",[t._v("通过内置变量，我们可以通过判断请求头、"),a("code",[t._v("query string")]),t._v(" 等值来转发或者拒绝访问。")]),t._v(" "),a("h3",{attrs:{id:"arg-name-获取请求参数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#arg-name-获取请求参数"}},[t._v("#")]),t._v(" "),a("code",[t._v("$arg_name")]),t._v(" 获取请求参数")]),t._v(" "),a("p",[t._v("获取请求"),a("code",[t._v("query string")]),t._v(" 中的 "),a("code",[t._v("name")]),t._v(" 参数。")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /arg/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default_type")]),t._v(" application/json")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$arg_q1")]),t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[a("code",[t._v("/arg/a?q1=334")]),t._v(" 返回的内容为 "),a("code",[t._v("334")]),t._v("。")]),t._v(" "),a("h3",{attrs:{id:"args-获取请求-query-string-参数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#args-获取请求-query-string-参数"}},[t._v("#")]),t._v(" "),a("code",[t._v("$args")]),t._v(" 获取请求 "),a("code",[t._v("query_string")]),t._v(" 参数")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /arg/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default_type")]),t._v(" application/json")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$arg_q1")]),t._v(" _ "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$args")]),t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("浏览器访问 "),a("code",[t._v("/arg/a?q1=3334&aa=2&bb=33")]),t._v(" 返回的内容为 "),a("code",[t._v("3334 _ q1=3334&aa=2&bb=33")])]),t._v(" "),a("h3",{attrs:{id:"cookie-name-获取-cookie-的值"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cookie-name-获取-cookie-的值"}},[t._v("#")]),t._v(" "),a("code",[t._v("$cookie_name")]),t._v(" 获取 cookie 的值")]),t._v(" "),a("p",[t._v("获取请求中的名称为 "),a("code",[t._v("name")]),t._v(" 的 cookie。")]),t._v(" "),a("h3",{attrs:{id:"http-name-获取请求头"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#http-name-获取请求头"}},[t._v("#")]),t._v(" "),a("code",[t._v("$http_name")]),t._v(" 获取请求头")]),t._v(" "),a("p",[a("code",[t._v("name")]),t._v(" 为请求头中的字段名称，请求头名称全部小写，并将破折号"),a("code",[t._v("-")]),t._v(" 替换为下划线 "),a("code",[t._v("_")])]),t._v(" "),a("p",[a("code",[t._v("$http_user_agent")]),t._v(" 获取请求头中的 "),a("code",[t._v("User-Agent")]),t._v(" 字段。")]),t._v(" "),a("h3",{attrs:{id:"uri-获取请求路径中的-path"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#uri-获取请求路径中的-path"}},[t._v("#")]),t._v(" "),a("code",[t._v("$uri")]),t._v(" 获取请求路径中的 "),a("code",[t._v("path")])]),t._v(" "),a("p",[a("code",[t._v("path")]),t._v(" 为端口后面的路径，不包括 "),a("code",[t._v("query string")]),t._v("。优化之后的路径，特殊字符转译及 "),a("code",[t._v("/")]),t._v(" 压缩。")]),t._v(" "),a("p",[a("code",[t._v("http://localhost:8888/arg/a?q1=q1canshu&bb=2323")]),t._v(" 中的 "),a("code",[t._v("path")]),t._v(" 为 "),a("code",[t._v("/arg/a")])]),t._v(" "),a("h3",{attrs:{id:"host-获取请求的-ip"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#host-获取请求的-ip"}},[t._v("#")]),t._v(" "),a("code",[t._v("$host")]),t._v(" 获取请求的 "),a("code",[t._v("ip")])]),t._v(" "),a("p",[t._v("首先会获取请求头 "),a("code",[t._v("Host")]),t._v(" ，如果没有请求头中没有 "),a("code",[t._v("Host")]),t._v(" 请求头，那么获取的是 "),a("code",[t._v("url")]),t._v(" 中的 "),a("code",[t._v("ip")]),t._v("。")]),t._v(" "),a("h3",{attrs:{id:"request-uri-获取-path-和-query-string"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#request-uri-获取-path-和-query-string"}},[t._v("#")]),t._v(" "),a("code",[t._v("$request_uri")]),t._v(" 获取 "),a("code",[t._v("path")]),t._v(" 和 "),a("code",[t._v("query string")])]),t._v(" "),a("p",[t._v("访问 "),a("code",[t._v("http://localhost:8888/arg/a/?q1=q1canshu&bb=2323")])]),t._v(" "),a("p",[a("code",[t._v("$request_uri")]),t._v(" 为"),a("code",[t._v("/arg/a/?q1=q1canshu&bb=2323")])]),t._v(" "),a("h3",{attrs:{id:"scheme-获取请求协议"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#scheme-获取请求协议"}},[t._v("#")]),t._v(" "),a("code",[t._v("$scheme")]),t._v(" 获取请求协议")]),t._v(" "),a("p",[t._v("值为 "),a("code",[t._v("http")]),t._v(" 或 "),a("code",[t._v("https")])]),t._v(" "),a("h3",{attrs:{id:"request-method-获取请求方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#request-method-获取请求方法"}},[t._v("#")]),t._v(" "),a("code",[t._v("$request_method")]),t._v(" 获取请求方法")]),t._v(" "),a("p",[t._v("获得的值字母全大写。GET,POST,DELETE,PUT 等")]),t._v(" "),a("h3",{attrs:{id:"其他变量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#其他变量"}},[t._v("#")]),t._v(" 其他变量")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("-")]),t._v(" "),a("th",[t._v("描述")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[a("code",[t._v("$content_length")])]),t._v(" "),a("td",[t._v("获取 "),a("code",[t._v("Content-Length")]),t._v(" 请求头字段。")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("$content_type")])]),t._v(" "),a("td",[t._v("获取 "),a("code",[t._v("Content-Type")]),t._v(" 请求头字段")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("$https")])]),t._v(" "),a("td",[t._v("如果连接以 SSL 模式运行，则为 on ，否则为空字符串")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("$is_args")])]),t._v(" "),a("td",[t._v("如果请求行有参数则为 ? ，否则为空字符串")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("$pid")])]),t._v(" "),a("td",[t._v("获取处理当前请求的 "),a("code",[t._v("worker")]),t._v(" pid")])]),t._v(" "),a("tr",[a("td",[a("code",[t._v("$nginx_version")])]),t._v(" "),a("td",[t._v("获取 nginx 的版本")])]),t._v(" "),a("tr",[a("td"),t._v(" "),a("td")])])]),t._v(" "),a("h2",{attrs:{id:"if"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#if"}},[t._v("#")]),t._v(" if")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("-")]),t._v(" "),a("th",[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("语法")]),t._v(" "),a("td",[t._v("if ("),a("code",[t._v("condition")]),t._v("){}")])]),t._v(" "),a("tr",[a("td",[t._v("默认")]),t._v(" "),a("td",[t._v("-")])]),t._v(" "),a("tr",[a("td",[t._v("上下文")]),t._v(" "),a("td",[t._v("server、location")])])])]),t._v(" "),a("p",[t._v("指定的 condition 求值之后，如果为 true ，则执行在大括号内指定的该模块的指令，并在 if 指令内为该请求分配配置。 if 指令内的配置继承自上一层的配置级别。")]),t._v(" "),a("p",[t._v("condition 可以是以下任何一种:")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("变量名，如果变量的值为空字符串或 0 ，则为 false")])]),t._v(" "),a("li",[a("p",[t._v("使用 = 和 != 运算符比较变量和字符串")])]),t._v(" "),a("li",[a("p",[t._v("使用 ~ (区分大小写的匹配)和 ~* (不区分大小写的匹配)运算符，变量将与正则表达式进行匹配。正则表达式可以包含可供以后在 "),a("code",[t._v("$1")]),t._v(".."),a("code",[t._v("$9")]),t._v(" 变量中重用的捕获。")])]),t._v(" "),a("li",[a("p",[t._v("反操作符 !~ 和 !~* 也可用。如果正则表达式包含 } 或 ; 字符，则整个表达式应使用单引号 或双引号包围起来。")])]),t._v(" "),a("li",[a("p",[t._v("使用 -f 和 !-f 运算符检查文件是否存在")])]),t._v(" "),a("li",[a("p",[t._v("使用 -d 和 !-d 运算符检查目录是否存在")])]),t._v(" "),a("li",[a("p",[t._v("使用 -e 和 !-e 运算符检查文件、目录或符号链接是否存在")])]),t._v(" "),a("li",[a("p",[t._v("使用 -x 和 !-x 运算符检查是否为可执行文件")])])]),t._v(" "),a("p",[a("font",{attrs:{color:"red"}},[a("code",[t._v("if")]),t._v(" 与小括号之间需要有空格")])],1),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" = /a")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default_type")]),t._v(" application/json")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" ("),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$request_uri")]),t._v(" ~* "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/(a).*"')]),t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"正则表达式捕获的值:'),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$1")]),t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"= /a,优先级第一"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"rewrite"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rewrite"}},[t._v("#")]),t._v(" rewrite")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("-")]),t._v(" "),a("th",[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("语法")]),t._v(" "),a("td",[t._v("rewrite regex replacement [flag];")])]),t._v(" "),a("tr",[a("td",[t._v("默认")]),t._v(" "),a("td",[t._v("-")])]),t._v(" "),a("tr",[a("td",[t._v("上下文")]),t._v(" "),a("td",[t._v("server、location、if")])])])]),t._v(" "),a("p",[a("code",[t._v("flag")]),t._v(" 可选参数：")]),t._v(" "),a("ul",[a("li",[t._v("last")])]),t._v(" "),a("p",[t._v("停止匹配，发送一个新的请求去匹配 "),a("code",[t._v("location")]),t._v("。")]),t._v(" "),a("ul",[a("li",[t._v("break")])]),t._v(" "),a("p",[t._v("停止匹配，在当前 "),a("code",[t._v("location")]),t._v(" 去搜索资源。")]),t._v(" "),a("ul",[a("li",[t._v("redirect")])]),t._v(" "),a("p",[t._v("临时重定向。返回状态码 "),a("code",[t._v("302")]),t._v("。")]),t._v(" "),a("ul",[a("li",[t._v("permanent")])]),t._v(" "),a("p",[t._v("永久重定向。返回状态码 "),a("code",[t._v("301")]),t._v(" 。")]),t._v(" "),a("p",[t._v("指定的 "),a("code",[t._v("regex")]),t._v(" 能匹配，uri 将根据 "),a("code",[t._v("replacement")]),t._v(" 来处理。")]),t._v(" "),a("h3",{attrs:{id:"验证-break-和-last"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#验证-break-和-last"}},[t._v("#")]),t._v(" 验证 break 和 last")]),t._v(" "),a("p",[t._v("以下三张图片都存在，但是内容不一样。")]),t._v(" "),a("p",[t._v("/Users/zhangpanqin/stduy_app/break2/test/1.jpg")]),t._v(" "),a("p",[t._v("/Users/zhangpanqin/stduy_app/last2/test/1.jpg")]),t._v(" "),a("p",[t._v("/Users/zhangpanqin/stduy_app/test/1.jpg")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /break2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" /Users/zhangpanqin/stduy_app/break2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rewrite")]),t._v(" /break2/(.*) /test/"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$1")]),t._v(" break")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /last2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" /Users/zhangpanqin/stduy_app/last2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rewrite")]),t._v(" /last2/(.*) /test/"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$1")]),t._v(" last")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /test/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" /Users/zhangpanqin/stduy_app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("当访问 "),a("code",[t._v("/break2/1.jpg")]),t._v(" 实际匹配第一个 "),a("code",[t._v("location")]),t._v("，然后在当前上下文处理 。")]),t._v(" "),a("p",[a("code",[t._v("/break2/1.jpg")]),t._v(" 被替换为 "),a("code",[t._v("/test/1.jpg")]),t._v(" 来处理了，然后和 "),a("code",[t._v("root")]),t._v(" 指定的路径相结合，返回 "),a("code",[t._v("/Users/zhangpanqin/stduy_app/break2/test/1.jpg")]),t._v(" 数据。")]),t._v(" "),a("p",[t._v("当访问 "),a("code",[t._v("/last2/1.jpg")]),t._v(" ,uri 被替换为 "),a("code",[t._v("/test/1.jpg")]),t._v(" 去匹配新的 location 进行处理。")]),t._v(" "),a("p",[t._v("返回 "),a("code",[t._v("/Users/zhangpanqin/stduy_app/test/1.jpg")]),t._v(" 的内容。")]),t._v(" "),a("h3",{attrs:{id:"验证-redirect-和-permanent"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#验证-redirect-和-permanent"}},[t._v("#")]),t._v(" 验证 "),a("code",[t._v("redirect")]),t._v(" 和 "),a("code",[t._v("permanent")])]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /redirect2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rewrite")]),t._v(" ^/redirect2 http://www.baidu.com redirect")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /permanent2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rewrite")]),t._v(" ^/permanent2 http://www.baidu.com permanent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("二者匹配成功之后，都会改变浏览器地址栏地址。浏览器根据响应头 "),a("code",[t._v("Location")]),t._v(" 跳转对应地址。")]),t._v(" "),a("p",[t._v("二者的区别在于，永久重定向 （"),a("code",[t._v("permanent")]),t._v("），浏览器会保存记录，当再访问 "),a("code",[t._v("http://localhost:9088/permanent2")]),t._v(" 而不会询问 "),a("code",[t._v("nginx")]),t._v(" 直接跳转。")]),t._v(" "),a("p",[t._v("临时重定向，浏览器每次都要询问 "),a("code",[t._v("nginx")]),t._v(" 需要跳转到哪里。可以关闭 "),a("code",[t._v("nginx")]),t._v(" 就知道验证结果了。")]),t._v(" "),a("p",[a("img",{attrs:{src:"/blog/20200328181255.png?author=zhangpanqin",alt:"image-20200328181255172"}})]),t._v(" "),a("h2",{attrs:{id:"try-files"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#try-files"}},[t._v("#")]),t._v(" try_files")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("-")]),t._v(" "),a("th",[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("语法")]),t._v(" "),a("td",[t._v("try_files "),a("code",[t._v("file … uri;")]),a("br"),t._v("try_files "),a("code",[t._v("file … =code")]),t._v(";")])]),t._v(" "),a("tr",[a("td",[t._v("默认")]),t._v(" "),a("td",[t._v("-")])]),t._v(" "),a("tr",[a("td",[t._v("上下文")]),t._v(" "),a("td",[t._v("server、location")])])])]),t._v(" "),a("p",[t._v("以指定顺序检查文件是否存在，并使用第一个找到的文件进行请求处理。如果找不到内容内部转发到最后一个参数 "),a("code",[t._v("uri")]),t._v(" 。文件位置为 "),a("code",[t._v("root")]),t._v(" + "),a("code",[t._v("file")]),t._v("。")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /try/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v(" /usr/local/var/www/data2/data2/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try_files")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$uri")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$uri")]),t._v("/ @pass2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" @pass2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default_type")]),t._v(" application/json")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"没到到页面代理的数据"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("访问 "),a("code",[t._v("/try/1.jpg")]),t._v(" 时，"),a("code",[t._v("$uri")]),t._v(" 为 "),a("code",[t._v("/try/1.jpg")]),t._v(" 。")]),t._v(" "),a("p",[a("code",[t._v("root")]),t._v(" + "),a("code",[t._v("$uri")]),t._v(" 为 "),a("code",[t._v("/usr/local/var/www/data2/data2/try/1.jpg")]),t._v(" 找到返回，没有找到继续匹配返回。都没有匹配内部转发至 "),a("code",[t._v("@pass2")]),t._v("。")]),t._v(" "),a("p",[t._v("如想验证跳转使用 "),a("code",[t._v("/try/test")]),t._v(" 之类的，不要使用后缀名，因为使用后缀名的话，浏览器会返回"),a("code",[t._v("content-type")]),t._v("，导致内容与解析不一致，图片出不来。")]),t._v(" "),a("h2",{attrs:{id:"配置-gzip"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置-gzip"}},[t._v("#")]),t._v(" 配置 gzip")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 开启 gzip")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("on")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 在响应头中增加，Vary: Accept-Encoding")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_vary")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("on")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# gzip压缩级别1-9，数字越大压缩效果越好，压缩所用时间也就越长，占用CPU越高")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_comp_level")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 申请内存时大小，如果源文件 9k，超过了 8K，那会申请 16*8K。")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_buffers")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8k")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_min_length")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2K")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_proxied")]),t._v(" any")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_disable")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"msie6"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_http_version")]),t._v(" 1.1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 文本（js、text、css、xml、json）压缩比较好，图片已经进行过压缩，在压缩，效果不是很明显，还浪费 cpu")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_types")]),t._v(" text/plain text/css text/xml text/javascript application/javascript application/json application/xml+rss application/rss+xml application/atom+xml image/svg+xml")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])])]),a("p",[t._v("gzip 压缩对文本效果比较好，推荐只对文本之类的压缩。")]),t._v(" "),a("h2",{attrs:{id:"配置缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置缓存"}},[t._v("#")]),t._v(" 配置缓存")]),t._v(" "),a("p",[t._v("为了减轻服务器压力，节省带宽，可以配置缓存。")]),t._v(" "),a("p",[a("img",{attrs:{src:"/blog/20200328185716.png?author=zhangpanqin",alt:"image-20200328185715962"}})]),t._v(" "),a("p",[a("code",[t._v("memory cache")]),t._v(":它是将资源文件缓存到内存中，缓存有效直接从内存加载。")]),t._v(" "),a("p",[a("code",[t._v("disk cache")]),t._v(": 它是将资源文件缓存到硬盘中，缓存有效直接从硬盘中加载。")]),t._v(" "),a("p",[t._v("先从 "),a("code",[t._v("memory cache")]),t._v(" 找，找不到从 "),a("code",[t._v("disk cache")]),t._v(" 找，再找不到，请求网络资源。")]),t._v(" "),a("p",[t._v("缓存分为 "),a("code",[t._v("协商缓存")]),t._v(" 和 "),a("code",[t._v("强缓存")]),t._v("。")]),t._v(" "),a("p",[a("code",[t._v("协商缓存")]),t._v(" 每次都要去服务器询问缓存是否过期，没有过期使用本地的缓存。")]),t._v(" "),a("p",[a("code",[t._v("强缓存")]),t._v(" 会有缓存过期时间，在有效期内不会去服务端校验缓存，直接使用本地缓存。")]),t._v(" "),a("p",[t._v("现在的 "),a("code",[t._v("webpack")]),t._v(" 可以根据文件内容的 "),a("code",[t._v("hash")]),t._v(" 生产类似 "),a("code",[t._v("app.asdfa21342.js")]),t._v(" 这样的文件。其实就是想使用强缓存，当网站更新，新的页面会解析加载不一样的资源，从而降低缓存校验对服务器性能的损耗。")]),t._v(" "),a("h3",{attrs:{id:"协商缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#协商缓存"}},[t._v("#")]),t._v(" 协商缓存")]),t._v(" "),a("p",[t._v("协商缓存有："),a("code",[t._v("ETag/if-None-Match")]),t._v(" 和 "),a("code",[t._v("Last-Modified/if-Modify-Since")]),t._v(" 两种。")]),t._v(" "),a("p",[t._v("http 协议规定，当这两种响应头都存在的时候，必须都要满足，才能使用缓存。")]),t._v(" "),a("h4",{attrs:{id:"etag-if-none-match"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#etag-if-none-match"}},[t._v("#")]),t._v(" "),a("code",[t._v("ETag/if-None-Match")])]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("-")]),t._v(" "),a("th",[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("语法")]),t._v(" "),a("td",[t._v("etag on|off;")])]),t._v(" "),a("tr",[a("td",[t._v("默认")]),t._v(" "),a("td",[t._v("etag on;")])]),t._v(" "),a("tr",[a("td",[t._v("上下文")]),t._v(" "),a("td",[t._v("http、server、location")])])])]),t._v(" "),a("p",[a("code",[t._v("nginx")]),t._v(" 有个 etag 配置属性，会给每个静态资源生成 "),a("code",[t._v("Etag")]),t._v(" 响应头，值为文件内容 "),a("code",[t._v("hash")]),t._v("。")]),t._v(" "),a("p",[t._v("当浏览器第一次访问资源的时候，返回的响应头中携带 "),a("code",[t._v("Etag")]),t._v(" 。")]),t._v(" "),a("p",[t._v("后续的正常访问（不强制刷新缓存）相同的资源，都会带上请求头 "),a("code",[t._v("if-None-Match")]),t._v(" ,值为 "),a("code",[t._v("Etag")]),t._v(" 去 "),a("code",[t._v("nginx")]),t._v(" 校验是否一样，一样说明缓存没有过期，返回状态码 "),a("code",[t._v("304")]),t._v("，直接访问浏览器中的缓存，否则从浏览器返回资源，返回状态码 200。")]),t._v(" "),a("h3",{attrs:{id:"last-modified-if-modify-since"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#last-modified-if-modify-since"}},[t._v("#")]),t._v(" "),a("code",[t._v("Last-Modified/if-Modify-Since")])]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("-")]),t._v(" "),a("th",[t._v("说明")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("语法")]),t._v(" "),a("td",[t._v("if_modified_since off|exact|before;")])]),t._v(" "),a("tr",[a("td",[t._v("默认")]),t._v(" "),a("td",[t._v("if_modified_since exact；")])]),t._v(" "),a("tr",[a("td",[t._v("上下文")]),t._v(" "),a("td",[t._v("http、server、location")])])])]),t._v(" "),a("p",[t._v("指定如何比较文件的修改时间与请求头 "),a("strong",[t._v("If-Modified-Since")]),t._v(" 进行比较:")]),t._v(" "),a("ul",[a("li",[t._v("off")])]),t._v(" "),a("p",[t._v("忽略 "),a("strong",[t._v("If-Modified-Since")]),t._v(" 请求头字段(0.7.34)")]),t._v(" "),a("ul",[a("li",[t._v("exact")])]),t._v(" "),a("p",[t._v("完全匹配")]),t._v(" "),a("ul",[a("li",[t._v("before")])]),t._v(" "),a("p",[t._v("资源的修改时间小于或等于 "),a("strong",[t._v("If-Modified-Since")]),t._v(" 请求头字段中的时间")]),t._v(" "),a("p",[t._v("浏览器第一次访问一个资源的时候，响应头 "),a("code",[t._v("Last-Modified")]),t._v(" 返回，标识文件的最后修改时间。")]),t._v(" "),a("p",[t._v("当浏览器再次正常访问（不强制刷新资源）相同资源，请求头会加上 "),a("code",[t._v("If-Modified-Since")]),t._v("，该值为之前返回的 "),a("code",[t._v("Last-Modified")]),t._v(" 。"),a("code",[t._v("nginx")]),t._v(" 收到 "),a("code",[t._v("If-Modified-Since")]),t._v(" 后，根据配置 "),a("code",[t._v("if_modified_since")]),t._v(" 属性比较资源的最后修改时间("),a("code",[t._v("Last-Modified")]),t._v(")和该值"),a("code",[t._v("If-Modified-Since")]),t._v("进行比较，匹配成功，则命中缓存，返回 304，否则返回 资源，状态码为 200，并更新缓存时间。")]),t._v(" "),a("h3",{attrs:{id:"强制缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#强制缓存"}},[t._v("#")]),t._v(" 强制缓存")]),t._v(" "),a("h4",{attrs:{id:"expires"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#expires"}},[t._v("#")]),t._v(" Expires")]),t._v(" "),a("p",[a("code",[t._v("Expires")]),t._v(" 是 "),a("code",[t._v("http1.0")]),t._v(" 的规范，它的值是一个绝对时间的 GMT 格式的时间字符串。这个时间代表的该资源的失效时间，如果在该时间之前请求的话，则都是从缓存里面读取的。如果服务端和客户端时区不一致会导致判断不准确。")]),t._v(" "),a("h4",{attrs:{id:"cache-control"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cache-control"}},[t._v("#")]),t._v(" Cache-Control")]),t._v(" "),a("p",[a("code",[t._v("Cache-Control")]),t._v(" 是 "),a("code",[t._v("http1.1")]),t._v(" 的规范，它是利用该字段 "),a("code",[t._v("max-age")]),t._v(" 值进行判断的。该值是一个相对时间，比如 "),a("code",[t._v("Cache-Control: max-age=3600")]),t._v(" 代表该资源的有效期是 3600 秒。除了该字段外，我们还有如下字段可以设置：")]),t._v(" "),a("p",[a("strong",[t._v("no-cache:")]),t._v(" 需要进行协商缓存，发送请求到服务器确认是否使用缓存。")]),t._v(" "),a("p",[t._v("**no-store：**禁止使用缓存，每一次都要重新请求数据。")]),t._v(" "),a("p",[t._v("**public：**可以被所有的用户缓存，包括终端用户和 CDN 等中间代理服务器。")]),t._v(" "),a("p",[t._v("**private：**只能被终端用户的浏览器缓存，不允许 CDN 等中继缓存服务器对其缓存。")]),t._v(" "),a("h3",{attrs:{id:"配置缓存-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置缓存-2"}},[t._v("#")]),t._v(" 配置缓存")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" ~* \\.(css|js|png|jpg|jpeg|gif|gz|svg|mp4|mp3|ogg|ogv|webm|htc|xml|woff)$")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 关闭访问日志记录")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("access_log")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("off")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 强缓存，时间为一年，浏览器和 cdn 中间件可以缓存")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_header")]),t._v(" Cache-Control "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"max-age=31536000"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"推荐资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#推荐资料"}},[t._v("#")]),t._v(" 推荐资料")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/DocsHome/nginx-docs",target:"_blank",rel:"noopener noreferrer"}},[t._v("nginx 中文翻译"),a("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=n.exports}}]);