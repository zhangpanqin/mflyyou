(window.webpackJsonp=window.webpackJsonp||[]).push([[55],{403:function(t,s,a){"use strict";a.r(s);var e=a(9),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"前言"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),s("p",[t._v("这篇关于 "),s("code",[t._v("Nginx")]),t._v(" 的性能优化，是我查阅资料研究所成，并没有用于实际生产环境，"),s("font",{attrs:{color:"red"}},[t._v("如若你想用于实践，请谨慎测试之后使用。")])],1),t._v(" "),s("p",[s("code",[t._v("Nginx")]),t._v(" 性能优化，主要是减少"),s("code",[t._v("磁盘 io")]),t._v("。")]),t._v(" "),s("ul",[s("li",[t._v("请求头、请求体、响应体都在缓冲区操作。")]),t._v(" "),s("li",[t._v("文件信息的读取")])]),t._v(" "),s("p",[t._v("减少网络 io。")]),t._v(" "),s("ul",[s("li",[t._v("gzip 压缩。前端资源也可以提前进行 "),s("code",[t._v("gzip")]),t._v(" 压缩，这样请求的时候就不用再压缩了，减少对 "),s("code",[t._v("cpu")]),t._v(" 的损耗。")]),t._v(" "),s("li",[t._v("强缓存。减少对后端的静态资源的请求。")])]),t._v(" "),s("p",[s("code",[t._v("http")]),t._v(" 链接的尽快释放，减少请求的堆积。")]),t._v(" "),s("p",[s("code",[t._v("linux")]),t._v(" 内核优化。这部分主要是查阅资料加上自己的理解。内容来自 《深入理解 Nginx 模块开发与架构设计》。")]),t._v(" "),s("p",[t._v("调账参数之后可以使用 "),s("code",[t._v("ab")]),t._v(" 和 "),s("code",[t._v("jmeter")]),t._v(" 进行压测，根据实际效果来进行调优。")]),t._v(" "),s("p",[s("code",[t._v("Nginx")]),t._v(" 一定要在安全的情况下做性能优化。不然 tcp 攻击就能给你服务器搞挂了，能用才是王道。安全访问第一，性能第二。")]),t._v(" "),s("p",[t._v("调优之后，一定记得要做限流哦。")]),t._v(" "),s("p",[t._v("下个系列准备写 "),s("code",[t._v("Mysql")]),t._v(" 相关，已经在做准备了。")]),t._v(" "),s("h2",{attrs:{id:"linux-内核优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#linux-内核优化"}},[t._v("#")]),t._v(" linux 内核优化")]),t._v(" "),s("p",[t._v("可以修改 "),s("code",[t._v("/etc/sysctl.conf")]),t._v(" 来修改内核参数。"),s("font",{attrs:{color:"red"}},[t._v("这部分优化慎重")])],1),t._v(" "),s("ul",[s("li",[t._v("查看 tcp 相关系统参数")])]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sysctl")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-a")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'net.ipv4.tcp'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v("\n")])])]),s("div",{staticClass:"language-properties extra-class"},[s("pre",{pre:!0,attrs:{class:"language-properties"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("fs.file-max")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("999999")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("net.ipv4.tcp_tw_reuse")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("1")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("net.ipv4.tcp_keepalive_time")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("15")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("net.ipv4.tcp_fin_timeout")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("15")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("net.ipv4.tcp_max_tw_buckets")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("5000")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("net.ipv4.ip_local_port_range")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("1024 65000")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("net.ipv4.tcp_rmem")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("4096 32768 262144")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("net.ipv4.tcp_wmem")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("4096 32768 262144")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("net.ipv4.tcp_max_orphans")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("262144")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("net.core.netdev_max_backlog")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("262144")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("net.core.rmem_default")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("262144")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("net.core.wmem_default")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("262144")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("net.core.rmem_max")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("2097152")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("net.core.wmem_max")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("2097152")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("net.core.somaxconn")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("262144")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("net.ipv4.tcp_syncookies")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("1")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("net.ipv4.tcp_max_syn_backlog")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("262144")]),t._v("\n")])])]),s("p",[t._v("修改之后执行以下命令，使配置生效。")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sysctl")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v("\n")])])]),s("p",[t._v("上面的参数意义解释如下：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("fs.file-max：999999")]),t._v(" "),s("blockquote",[s("p",[t._v("这个参数表示进程（比如一个 worker 进程）可以同时打开的最大句柄数，这 个参数直接限制最大并发连接数，需根据实际情况配置。")])])]),t._v(" "),s("li",[s("p",[t._v("net.ipv4.tcp_tw_reuse：")]),t._v(" "),s("blockquote",[s("p",[t._v("这个参数设置为 1，表示允许将 TIME-WAIT 状态的 socket 重新用于新的 TCP 连接，这对于服务器来说很有意义，因为服务器上总会有大量 TIME-WAIT 状态的连接。")])])]),t._v(" "),s("li",[s("p",[t._v("net.ipv4.tcp_keepalive_time：")]),t._v(" "),s("blockquote",[s("p",[t._v("这个参数表示当 keepalive 启用时，TCP 发送 keepalive 消息的频度。 默认是 2 小时，若将其设置得小一些，可以更快地清理无效的连接。")])])]),t._v(" "),s("li",[s("p",[t._v("net.ipv4.tcp_fin_timeout：")]),t._v(" "),s("blockquote",[s("p",[t._v("这个参数表示当服务器主动关闭连接时，socket 保持在 FIN-WAIT-2 状态的最大时间。")])])]),t._v(" "),s("li",[s("p",[t._v("net.ipv4.tcp_max_tw_buckets：")]),t._v(" "),s("blockquote",[s("p",[t._v("这个参数表示操作系统允许 TIME_WAIT 套接字数量的最大值， 如果超过这个数字，TIME_WAIT 套接字将立刻被清除并打印警告信息。该参数默认为 180000，过多的 TIME_WAIT 套接字会使 Web 服务器变慢。")])])]),t._v(" "),s("li",[s("p",[t._v("net.ipv4.ip_local_port_range：")]),t._v(" "),s("blockquote",[s("p",[t._v("这个参数定义了在 UDP 和 TCP 连接中本地（不包括连接的远端） 端口的取值范围。")])])]),t._v(" "),s("li",[s("p",[t._v("net.ipv4.tcp_rmem：")]),t._v(" "),s("blockquote",[s("p",[t._v("这个参数定义了 TCP 接收缓存（用于 TCP 接收滑动窗口）的最小 值、默认值、最大值。")])])]),t._v(" "),s("li",[s("p",[t._v("net.ipv4.tcp_wmem：")]),t._v(" "),s("blockquote",[s("p",[t._v("这个参数定义了 TCP 发送缓存（用于 TCP 发送滑动窗口）的最小 值、默认值、最大值。")])])]),t._v(" "),s("li",[s("p",[t._v("net.ipv4.tcp_max_orphans")]),t._v(" "),s("blockquote",[s("p",[t._v("选项用于记录那些尚未收到客户端确认信息的连接请求的最大值。对于有 128MB 内存的系统而言，此参数的默认值是 1024，对小内存的系统则是 128。")])])]),t._v(" "),s("li",[s("p",[t._v("net.core.netdev_max_backlog：")]),t._v(" "),s("blockquote",[s("p",[t._v("当网卡接收数据包的速度大于内核处理的速度时，会有一个队列 保存这些数据包。这个参数表示该队列的最大值。")])])]),t._v(" "),s("li",[s("p",[t._v("net.core.net.core.rmem_default：")]),t._v(" "),s("blockquote",[s("p",[t._v("这个参数表示内核套接字接收缓存区默认的大小。")])])]),t._v(" "),s("li",[s("p",[t._v("net.core.wmem_default：")]),t._v(" "),s("blockquote",[s("p",[t._v("这个参数表示内核套接字发送缓存区默认的大小。")])])]),t._v(" "),s("li",[s("p",[t._v("net.core.rmem_max：")]),t._v(" "),s("blockquote",[s("p",[t._v("这个参数表示内核套接字接收缓存区的最大大小。")])])]),t._v(" "),s("li",[s("p",[t._v("net.core.wmem_max：")]),t._v(" "),s("blockquote",[s("p",[t._v("这个参数表示内核套接字发送缓存区的最大大小。")])])])]),t._v(" "),s("p",[t._v("滑动窗口的大小与套接字缓存区会在一定程度上影响并发连接的数目。")]),t._v(" "),s("p",[t._v("每个 TCP 连接都会为维护 TCP 滑动窗口而消耗内存，这个窗口会根据服务器的处理速度收缩或扩 张。")]),t._v(" "),s("p",[t._v("参数 wmem_max 的设置，需要平衡物理内存的总大小、Nginx 并发处理的最大连接数量 （由 nginx.conf 中的 worker_processes 和 worker_connections 参数决定）而确定。")]),t._v(" "),s("p",[t._v("当然，如果仅仅 为了提高并发量使服务器不出现 Out Of Memory 问题而去降低滑动窗口大小，那么并不合 适，因为滑动窗口过小会影响大数据量的传输速度。")]),t._v(" "),s("p",[t._v("rmem_default、wmem_default、 rmem_max、wmem_max 这 4 个参数的设置需要根据我们的业务特性以及实际的硬件成本来综 合考虑。")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("net.core.somaxconn")]),t._v(" "),s("blockquote",[s("p",[t._v("选项表示当每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许发送到队列的数据包的最大数目。")])])]),t._v(" "),s("li",[s("p",[t._v("net.ipv4.tcp_syncookies：")]),t._v(" "),s("blockquote",[s("p",[t._v("设置为 1。该参数与性能无关，用于解决 TCP 的 SYN 攻击。")])])]),t._v(" "),s("li",[s("p",[t._v("net.ipv4.tcp_max_syn_backlog：")]),t._v(" "),s("blockquote",[s("p",[t._v("这个参数表示 TCP 三次握手建立阶段接收 SYN 请求队列的最大 长度，默认为 1024，将其设置得大一些可以使出现 Nginx 繁忙来不及 accept 新连接的情况时， Linux 不至于丢失客户端发起的连接请求。")])])])]),t._v(" "),s("h2",{attrs:{id:"内存及磁盘资料优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#内存及磁盘资料优化"}},[t._v("#")]),t._v(" 内存及磁盘资料优化")]),t._v(" "),s("h3",{attrs:{id:"client-header-buffer-size-1k"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#client-header-buffer-size-1k"}},[t._v("#")]),t._v(" client_header_buffer_size 1k;")]),t._v(" "),s("blockquote",[s("p",[t._v("作为静态资源访问 1k 足够了。")]),t._v(" "),s("p",[t._v("客户端请求头部的缓冲区大小，默认 1k，当请求接口的时候，根据请求头数据设置 4k 整数倍。")]),t._v(" "),s("p",[t._v("4k 为系统内存页大小，命令 getconf PAGESIZE 内存页大小")])]),t._v(" "),s("h3",{attrs:{id:"large-client-header-buffers"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#large-client-header-buffers"}},[t._v("#")]),t._v(" large_client_header_buffers")]),t._v(" "),s("p",[s("img",{attrs:{src:"/blog/20200412191248.png?author=zhangpanqin",alt:"image-20200329190558284"}})]),t._v(" "),s("h3",{attrs:{id:"client-body-in-single-buffer"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#client-body-in-single-buffer"}},[t._v("#")]),t._v(" client_body_in_single_buffer")]),t._v(" "),s("p",[t._v("设置为 on，http 包一律写入到内存 buffer 中，如果包体超过 "),s("code",[t._v("client_body_buffer_size")]),t._v(" 的大小，还是会写入到磁盘文件中。")]),t._v(" "),s("h3",{attrs:{id:"client-body-buffer-size"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#client-body-buffer-size"}},[t._v("#")]),t._v(" client_body_buffer_size")]),t._v(" "),s("p",[t._v("x64 默认 16K。定义接受请求体内存缓冲区大小，请求先写入到缓存区，超过在写入临时文件中。")]),t._v(" "),s("h3",{attrs:{id:"client-max-body-size-100m"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#client-max-body-size-100m"}},[t._v("#")]),t._v(" client_max_body_size 100m;")]),t._v(" "),s("p",[t._v("设置客户端请求体最大允许大小，默认 1m。检查的是 Content-Length。设置为 0 不检查。针对具体 location 配置。防止被请求攻击，在需要调大的地方设置，不要全局设置。")]),t._v(" "),s("h3",{attrs:{id:"sendflie-on"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#sendflie-on"}},[t._v("#")]),t._v(" sendflie on;")]),t._v(" "),s("p",[t._v("文件内容读取减少了内核态到用户态的拷贝，直接从内核态到网卡设备，提高了发送效率。")]),t._v(" "),s("h3",{attrs:{id:"open-file-cache"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#open-file-cache"}},[t._v("#")]),t._v(" open_file_cache")]),t._v(" "),s("p",[t._v("缓存文件的存储信息。max 表示最大存储数量，超过这个数量，采用 LRU 淘汰")]),t._v(" "),s("p",[t._v("inactive 指定时间段，该时间段内没有被访问过的元素，会被淘汰")]),t._v(" "),s("p",[t._v("open_file_cache max=65535 inactive=20s;")]),t._v(" "),s("h3",{attrs:{id:"open-file-cache-min-uses"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#open-file-cache-min-uses"}},[t._v("#")]),t._v(" open_file_cache_min_uses")]),t._v(" "),s("p",[t._v("默认为 1。与 open_file_cache 的 inactive 配合使用，如果在 inactive 指定的时间内，访问次数超过 open_file_cache_min_uses 指定的次数，不会淘汰缓存。")]),t._v(" "),s("h3",{attrs:{id:"调大文件句柄限制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#调大文件句柄限制"}},[t._v("#")]),t._v(" 调大文件句柄限制")]),t._v(" "),s("p",[s("code",[t._v("linux")]),t._v(" 一切皆文件，但是进程打开的文件数会有限制。可针对用户和进程来限制文件句柄数。")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("文件句柄，可以针对用户，进程设置")]),t._v(" "),s("ul",[s("li",[t._v("全局设置 /etc/security/limits.conf")])])])]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[t._v("* hard nofile 65535\n* soft nofile 65535\nroot hard nofile 65535\n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[t._v("- nginx 进程配置\n")])])]),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("worker_rlimit_nofile")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("20480")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h2",{attrs:{id:"日志优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#日志优化"}},[t._v("#")]),t._v(" 日志优化")]),t._v(" "),s("p",[t._v("可适当减少日志操作。比如访问静态资料的日志记录，如果你感觉不重要，可以取消日志记录。这样请求资源的时候就会减少日志的磁盘 io。")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 关闭日志")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("access_log")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("off")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 禁用文件未找到的错误到日志中去")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("log_not_found")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("off")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h3",{attrs:{id:"反向代理优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#反向代理优化"}},[t._v("#")]),t._v(" 反向代理优化")]),t._v(" "),s("p",[t._v("如果你用 "),s("code",[t._v("nginx")]),t._v(" 作为代理服务器，也要减少磁盘 io 的读取。")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_buffering")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("on")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_buffer_size")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4k")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_buffers")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("64k")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_busy_buffers_size")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("128k")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_temp_file_write_size")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("128k")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" Host "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$http_host")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" X-REAL-IP "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_addr")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" X-Forwarded-For "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$proxy_add_x_forwarded_for")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h2",{attrs:{id:"nginx-优化配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx-优化配置"}},[t._v("#")]),t._v(" Nginx 优化配置")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 配置 worker 进程所属用户,用户组")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("user")]),t._v(" nginx nginx")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 配置 worker 进程数量，为避免 cpu 切换损耗，配置和系统内核数一样即可,或者 auto")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("worker_processes")]),t._v(" auto")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 配置 cpu 亲和,auto 代表自动绑定")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("worker_cpu_affinity")]),t._v(" auto")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# nginx 进程打开文件描述符数目，此值覆盖 ulimit -n 的值。")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("worker_rlimit_nofile")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("65535")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("events")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 用这个模型来高效处理异步事件")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("use")]),t._v(" epoll")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置为 on worker 进程轮流接受新链接,官方推荐设置为 off.高负载的情况下设置为 on.")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("accept_mutex")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("on")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# worker进程是否同时接受连接所有新请求。默认为off，表示一次只接受一个新的请求。官方推荐 off")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("multi_accept")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("on")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 配置 一个 woker 进程处理的连接数")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("worker_connections")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("65535")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("http")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 关闭日志")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("access_log")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("off")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 隐藏响应头中的有关操作系统和web server（Nginx）版本号的信息，这样对于安全性是有好处的。")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_tokens")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("off")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sendfile")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("on")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置为非零值时，可限制单个 sendfile() 调用时传输的数据量。如果没有限制，一个快速 连接可能会完全占用工作进程。")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sendfile_max_chunk")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5m")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# tcp_nopush 和 tcp_nodeny 可以一起生效")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 等数据包累计到一定大小发送，启用 sendfile 生效")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("tcp_nopush")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("on")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 该选项仅在连接转换到 keep-alive ，长连接状态时启用。让 tcp 尽快发包。")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("tcp_nodelay")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("on")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 为了尽快释放连接,可以设置小点. 15 至 30")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("keepalive_timeout")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 客户端请求头部的缓冲区大小，默认 1k，当请求接口的时候需要设置 4k 整数倍.内存设置为系统内存页大小，命令 getconf PAGESIZE 内存页大小")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("client_header_buffer_size")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4k")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("large_client_header_buffers")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8k")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 根据需求设置,接口请求可以设置大些")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("client_body_buffer_size")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("128k")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置客户端请求体最大允许大小，默认 1m。检查的是 Content-Length。设置为 0 不检查。针对具体 location 配置")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("client_max_body_size")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1m")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 下面这个参数将为打开文件指定缓存，默认是没有启用的，max指定缓存数量，建议和打开文件数一致，")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# inactive是指经过多长时间文件没被请求后删除缓存。")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("open_file_cache")]),t._v(" max=262140 inactive=20s")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 下面这个是指多长时间检查一次缓存的有效信息。")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("open_file_cache_valid")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("30s")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# open_file_cache指令中的inactive参数时间内文件的最少访问次数，低于这个数,缓存清除")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("open_file_cache_min_uses")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("open_file_cache_errors")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("on")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("reset_timedout_connection")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("on")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("client_body_timeout")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("send_timeout")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 限制每个 ip 的连接数")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("limit_conn_zone")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$binary_remote_addr")]),t._v(" zone=conn_limit_per_ip:10m")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 限制每个 ip 每秒的请求数")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("limit_req_zone")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$binary_remote_addr")]),t._v(" zone=req_limit_per_ip:10m rate=10r/s")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("on")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 在响应头中增加，Vary: Accept-Encoding")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_vary")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("on")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# gzip压缩级别1-9，数字越大压缩效果越好，压缩时间也就越长CPU越高")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_comp_level")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 申请内存时大小，如果源文件 9k，超过了 8K，那会申请 16*8K。")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_buffers")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("128k")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_min_length")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5K")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_proxied")]),t._v(" any")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_disable")]),t._v(" msie6")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_http_version")]),t._v(" 1.1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 文本（js、text、css、xml、json）压缩比较好，图片已经进行过压缩，在压缩，效果不是很明显，还浪费 cpu")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("gzip_types")]),t._v(" text/plain text/css text/xml text/javascript application/javascript application/json application/xml+rss application/rss+xml application/atom+xml image/svg+xml")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安全相关 header")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_header")]),t._v(" X-Frame-Options "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"SAMEORIGIN"')]),t._v(" always")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_header")]),t._v(" Feature-Policy "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"autoplay 'none'; camera 'none'\"")]),t._v(" always")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_header")]),t._v(" X-XSS-Protection "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1; mode=block"')]),t._v(" always")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_header")]),t._v(" X-Content-Type-Options "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"nosniff"')]),t._v(" always")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_header")]),t._v(" Referrer-Policy "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"no-referrer-when-downgrade"')]),t._v(" always")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_header")]),t._v(" Content-Security-Policy "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"default-src 'self' http: https: data: blob: 'unsafe-inline'\"")]),t._v(" always")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_header")]),t._v(" Strict-Transport-Security "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"max-age=31536000; includeSubDomains; preload"')]),t._v(" always")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(" backlog=262144")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("limit_conn")]),t._v(" conn_limit_per_ip "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("limit_req")]),t._v(" zone=req_limit_per_ip burst=10 nodelay")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# assets, media")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" ~* \\.(?:css(\\.map)?|js(\\.map)?|jpe?g|png|gif|ico|cur|heic|webp|tiff?|mp3|m4a|aac|ogg|midi?|wav|mp4|mov|webm|mpe?g|avi|ogv|flv|wmv)$")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 强缓存，时间为一年，浏览器和 cdn 中间件可以缓存")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_header")]),t._v(" Cache-Control "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"max-age=31536000"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("etag")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("off")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("access_log")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("off")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 禁用文件未找到的错误到日志中去")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("log_not_found")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("off")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# svg, fonts")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" ~* \\.(?:svgz?|ttf|ttc|otf|eot|woff2?)$")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 强缓存，时间为一年，浏览器和 cdn 中间件可以缓存")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("add_header")]),t._v(" Cache-Control "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"max-age=31536000"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("etag")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("off")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("access_log")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("off")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 禁用文件未找到的错误到日志中去")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("log_not_found")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("off")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"资料参考"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#资料参考"}},[t._v("#")]),t._v(" 资料参考")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://www.keycdn.com/blog/http-security-headers",target:"_blank",rel:"noopener noreferrer"}},[t._v("http-security-headers"),s("OutboundLink")],1)]),t._v(" "),s("p",[s("a",{attrs:{href:"https://www.nginx.com/blog/performance-tuning-tips-tricks/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Nginx Performance Tuning – Tips & Tricks"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("《深入理解 Nginx 模块开发与架构设计》。")])])}),[],!1,null,null,null);s.default=n.exports}}]);