<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>你需要知道的TCP/IP | Mflyyou</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="张攀钦的笔记">
    <meta name="theme-color" content="#3eaf7c">
    
    <link rel="preload" href="/assets/css/0.styles.0ce27dc8.css" as="style"><link rel="preload" href="/assets/js/app.9063a2a7.js" as="script"><link rel="preload" href="/assets/js/3.a2cf49c7.js" as="script"><link rel="preload" href="/assets/js/2.b18ee37c.js" as="script"><link rel="preload" href="/assets/js/88.09bd150d.js" as="script"><link rel="preload" href="/assets/js/7.f81fa904.js" as="script"><link rel="prefetch" href="/assets/js/10.eb6d8b92.js"><link rel="prefetch" href="/assets/js/100.19912b69.js"><link rel="prefetch" href="/assets/js/101.856ea470.js"><link rel="prefetch" href="/assets/js/102.3102257f.js"><link rel="prefetch" href="/assets/js/103.90c7e07d.js"><link rel="prefetch" href="/assets/js/104.136fa880.js"><link rel="prefetch" href="/assets/js/11.24f40608.js"><link rel="prefetch" href="/assets/js/12.ea9da3c7.js"><link rel="prefetch" href="/assets/js/13.cac51d66.js"><link rel="prefetch" href="/assets/js/14.d3ef3ad4.js"><link rel="prefetch" href="/assets/js/15.452f0997.js"><link rel="prefetch" href="/assets/js/16.084ff694.js"><link rel="prefetch" href="/assets/js/17.5f564f33.js"><link rel="prefetch" href="/assets/js/18.52b4a43b.js"><link rel="prefetch" href="/assets/js/19.8f553865.js"><link rel="prefetch" href="/assets/js/20.39cdc1e8.js"><link rel="prefetch" href="/assets/js/21.59327323.js"><link rel="prefetch" href="/assets/js/22.fdc2b370.js"><link rel="prefetch" href="/assets/js/23.115b96f3.js"><link rel="prefetch" href="/assets/js/24.d67c7de6.js"><link rel="prefetch" href="/assets/js/25.568b5010.js"><link rel="prefetch" href="/assets/js/26.955bc611.js"><link rel="prefetch" href="/assets/js/27.59775561.js"><link rel="prefetch" href="/assets/js/28.3144828a.js"><link rel="prefetch" href="/assets/js/29.c1fcfaf9.js"><link rel="prefetch" href="/assets/js/30.c98e1d22.js"><link rel="prefetch" href="/assets/js/31.3fe1aff6.js"><link rel="prefetch" href="/assets/js/32.eeedfa58.js"><link rel="prefetch" href="/assets/js/33.2fd4c4a5.js"><link rel="prefetch" href="/assets/js/34.db2ddcd5.js"><link rel="prefetch" href="/assets/js/35.469ef364.js"><link rel="prefetch" href="/assets/js/36.9a8ecc3e.js"><link rel="prefetch" href="/assets/js/37.bd1c542c.js"><link rel="prefetch" href="/assets/js/38.0c3a87cd.js"><link rel="prefetch" href="/assets/js/39.8621ed93.js"><link rel="prefetch" href="/assets/js/4.172fe702.js"><link rel="prefetch" href="/assets/js/40.a30932f3.js"><link rel="prefetch" href="/assets/js/41.7d217427.js"><link rel="prefetch" href="/assets/js/42.c9a49e70.js"><link rel="prefetch" href="/assets/js/43.71aa35cf.js"><link rel="prefetch" href="/assets/js/44.d841d19d.js"><link rel="prefetch" href="/assets/js/45.a19ede26.js"><link rel="prefetch" href="/assets/js/46.906e285f.js"><link rel="prefetch" href="/assets/js/47.10c5a8ca.js"><link rel="prefetch" href="/assets/js/48.761c5188.js"><link rel="prefetch" href="/assets/js/49.7ff096d3.js"><link rel="prefetch" href="/assets/js/5.bc8ead88.js"><link rel="prefetch" href="/assets/js/50.91baf706.js"><link rel="prefetch" href="/assets/js/51.2889eabe.js"><link rel="prefetch" href="/assets/js/52.cfd59763.js"><link rel="prefetch" href="/assets/js/53.ec2b1458.js"><link rel="prefetch" href="/assets/js/54.fe5324f4.js"><link rel="prefetch" href="/assets/js/55.1c8a21ea.js"><link rel="prefetch" href="/assets/js/56.dba32333.js"><link rel="prefetch" href="/assets/js/57.76bd3a1b.js"><link rel="prefetch" href="/assets/js/58.4ca04372.js"><link rel="prefetch" href="/assets/js/59.5ef32f3e.js"><link rel="prefetch" href="/assets/js/6.579be253.js"><link rel="prefetch" href="/assets/js/60.6ab8599f.js"><link rel="prefetch" href="/assets/js/61.7c8bc316.js"><link rel="prefetch" href="/assets/js/62.8254d6a8.js"><link rel="prefetch" href="/assets/js/63.372f1ef3.js"><link rel="prefetch" href="/assets/js/64.9e7a0a69.js"><link rel="prefetch" href="/assets/js/65.8404ea2d.js"><link rel="prefetch" href="/assets/js/66.ca8c1521.js"><link rel="prefetch" href="/assets/js/67.188642b8.js"><link rel="prefetch" href="/assets/js/68.3446bdd7.js"><link rel="prefetch" href="/assets/js/69.1c4a4093.js"><link rel="prefetch" href="/assets/js/70.5c7dd73d.js"><link rel="prefetch" href="/assets/js/71.cda81ae5.js"><link rel="prefetch" href="/assets/js/72.287835b9.js"><link rel="prefetch" href="/assets/js/73.6adf879c.js"><link rel="prefetch" href="/assets/js/74.806e9e79.js"><link rel="prefetch" href="/assets/js/75.6763e52e.js"><link rel="prefetch" href="/assets/js/76.3f51a8f2.js"><link rel="prefetch" href="/assets/js/77.cd06ed98.js"><link rel="prefetch" href="/assets/js/78.7c870450.js"><link rel="prefetch" href="/assets/js/79.dcb8ff45.js"><link rel="prefetch" href="/assets/js/8.44113c74.js"><link rel="prefetch" href="/assets/js/80.8b5672ac.js"><link rel="prefetch" href="/assets/js/81.47a8e842.js"><link rel="prefetch" href="/assets/js/82.5a330af6.js"><link rel="prefetch" href="/assets/js/83.1928728d.js"><link rel="prefetch" href="/assets/js/84.7b0a8415.js"><link rel="prefetch" href="/assets/js/85.0526fa24.js"><link rel="prefetch" href="/assets/js/86.682b020c.js"><link rel="prefetch" href="/assets/js/87.773527c4.js"><link rel="prefetch" href="/assets/js/89.983ab36b.js"><link rel="prefetch" href="/assets/js/9.54a2a8e1.js"><link rel="prefetch" href="/assets/js/90.74e82ca3.js"><link rel="prefetch" href="/assets/js/91.2210fdbb.js"><link rel="prefetch" href="/assets/js/92.bd9b03cc.js"><link rel="prefetch" href="/assets/js/93.e322527d.js"><link rel="prefetch" href="/assets/js/94.1b8344d6.js"><link rel="prefetch" href="/assets/js/95.7b8a2981.js"><link rel="prefetch" href="/assets/js/96.f345feee.js"><link rel="prefetch" href="/assets/js/97.3fc0f4be.js"><link rel="prefetch" href="/assets/js/98.302d5747.js"><link rel="prefetch" href="/assets/js/99.e9f28656.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0ce27dc8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Mflyyou</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/java/base/java-messy-code.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/go/base/go-command.html" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/springboot/project-sumary/" class="nav-link">
  SpringBoot
</a></div><div class="nav-item"><a href="/tcp-ip/http/http-cors-jsonp/" class="nav-link">
  TCP/IP
</a></div><div class="nav-item"><a href="/dev-tools/asdf/" class="nav-link">
  开发工具
</a></div><div class="nav-item"><a href="/devops/docker/" class="nav-link">
  DevOps
</a></div> <a href="https://github.com/zhangpanqin/mflyyou" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/java/base/java-messy-code.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/go/base/go-command.html" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/springboot/project-sumary/" class="nav-link">
  SpringBoot
</a></div><div class="nav-item"><a href="/tcp-ip/http/http-cors-jsonp/" class="nav-link">
  TCP/IP
</a></div><div class="nav-item"><a href="/dev-tools/asdf/" class="nav-link">
  开发工具
</a></div><div class="nav-item"><a href="/devops/docker/" class="nav-link">
  DevOps
</a></div> <a href="https://github.com/zhangpanqin/mflyyou" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>HTTP</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/tcp-ip/http/http-caching.html" class="sidebar-link">HTTP 缓存</a></li><li><a href="/tcp-ip/http/http-cors-jsonp.html" class="sidebar-link">跨域</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>TCP/IP</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/tcp-ip/tcp-ip.html" aria-current="page" class="active sidebar-link">TCP/IP 三次握手，四次挥手</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#本文内容" class="sidebar-link">本文内容</a></li></ul></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#交换机与路由器" class="sidebar-link">交换机与路由器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#交换机" class="sidebar-link">交换机</a></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#路由器" class="sidebar-link">路由器</a></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#交互机和路由器的区别" class="sidebar-link">交互机和路由器的区别</a></li></ul></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#tcp-ip-通信" class="sidebar-link">TCP/IP 通信</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#数据链路层" class="sidebar-link">数据链路层</a></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#网络层" class="sidebar-link">网络层</a></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#icmp" class="sidebar-link">ICMP</a></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#arp" class="sidebar-link">ARP</a></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#通信过程分析" class="sidebar-link">通信过程分析</a></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#ip-数据格式" class="sidebar-link">IP 数据格式</a></li></ul></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#传输层-tcp" class="sidebar-link">传输层 TCP</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#tcp-数据格式" class="sidebar-link">TCP 数据格式</a></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#源端口号-source-port" class="sidebar-link">源端口号（Source Port）</a></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#目的端口号-destination-port" class="sidebar-link">目的端口号（Destination Port）</a></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#控制位-control-flag" class="sidebar-link">控制位（Control Flag）</a></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#序列号-sequence-number" class="sidebar-link">序列号（Sequence Number）</a></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#确认应答号-acknowledgement-number" class="sidebar-link">确认应答号（Acknowledgement Number）</a></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#窗口大小-window-size" class="sidebar-link">窗口大小（Window Size）</a></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#校验和-checksum" class="sidebar-link">校验和 (Checksum)</a></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#tcp-中-mss" class="sidebar-link">TCP 中 MSS</a></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#tcp-三次握手建立连接" class="sidebar-link">TCP 三次握手建立连接</a></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#tcp-四次挥手断开连接" class="sidebar-link">TCP 四次挥手断开连接</a></li></ul></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#网络抓包" class="sidebar-link">网络抓包</a></li><li class="sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#参考资料" class="sidebar-link">参考资料</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p><code>TCP/IP 协议</code> 是网络通信的基石，<code>TCP/IP 协议</code> 不是只有 <code>TCP</code> 和 <code>IP</code> 协议，它是整个网络通信中所有协议的简称。</p> <p><a href="%5Bhttps://zh.wikipedia.org/wiki/TCP/IP%E5%8D%8F%E8%AE%AE%E6%97%8F%5D(https://zh.wikipedia.org/wiki/TCP/IP%E5%8D%8F%E8%AE%AE%E6%97%8F)">维基百科：TCP/IP 协议簇</a></p> <p><a href="https://zh.wikipedia.org/wiki/OSI%E6%A8%A1%E5%9E%8B" target="_blank" rel="noopener noreferrer">维基百科：OSI 模型<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># TCP/IP 参考模型维基百科</span>
https://zh.wikipedia.org/wiki/TCP/IP%E5%8D%8F%E8%AE%AE%E6%97%8F
<span class="token comment"># OIS 参考模型维基百科</span>
https://zh.wikipedia.org/wiki/OSI%E6%A8%A1%E5%9E%8B
</code></pre></div><img src="/blog/20200801104517.png?author=zhangpanqin" alt="image-20200801104517510" style="zoom:50%;"> <blockquote><p>图片来自 《图解 TCP/IP 与 OSI 参考模型》 中 TCP/IP 协议分层模型</p></blockquote> <p><code>OSI 参考模型</code> （七层）是个理论模型，实际我们用的是 <code>TCP/IP</code> （四层）模型。不过我们可以通过 <code>OSI 参考模型</code> 来学习 <code>TCP/IP</code> 模型。</p> <p>应用层：应用程序通信细节的协议，比如常用的 <code>HTTP</code>。</p> <p>传输层：主要是负责两个节点之间数据传输，通信标识是 <code>port</code> 端口号。</p> <p>网络层：地址管理和路由选择，在两点之间找到一条最佳的通信路线，通信标识是 <code>IP</code></p> <p>数据链路层：负责物理层面链接的通信（同一个网段内）。也就是局域网中通过交换机链接的节点。通信标识是 <code>Mac 地址</code>，网卡出厂自带的标识。</p> <p>物理层：将链路层的数据帧（字节流）转换为电压或光信号传播。</p> <p>网络通信可以做什么呢？</p> <p><code>redisson</code> （一个操作 redis 的 java 库），就是使用的 <code>netty</code> 来做网络通信连接 redis 服务的。</p> <p>微服务中的服务发现和通信，就需要你熟悉网络通信。</p> <p>你要是在通信行业，那就不是了解了，你连协议的规范都得很清楚，不然路由器你都整不出来，还说什么 <code>5G</code> 。</p> <p>作为一个 Java 后端开发，主要是开发偏应用层面的程序，离底层相对比较远，熟练掌握即可，如果以后做通信行业的时候，你也一定会进一步学习的相关细节的。</p> <p><code>TCP/IP</code> 你不了解，也不会有多大问题，<code>CRUD</code> 还是没有问题的。但是你了解了之后，日常开发定位和解决问题方面有很大助力，总之学习 <code>TCP/IP</code> 是一个重要不紧急的事情，根据自己目标和层次安排。</p> <h3 id="本文内容"><a href="#本文内容" class="header-anchor">#</a> 本文内容</h3> <ul><li>局域网中各节点怎么通信</li> <li>介绍 IP,ICMP,ARP 协议在网络层的作用及路由表的作用，及网段划分，子网掩码、网关的作用</li> <li>介绍交换机和路由器的作用</li> <li>介绍 TCP/IP 三次握手和四次挥手，TCP 中通信状态的作用，滑动窗口</li> <li>介绍 tcp 包格式，ip 包格式，链路层 <code>帧</code> 数据格式</li></ul> <h2 id="交换机与路由器"><a href="#交换机与路由器" class="header-anchor">#</a> 交换机与路由器</h2> <h3 id="交换机"><a href="#交换机" class="header-anchor">#</a> 交换机</h3> <p><a href="%5Bhttps://zh.wikipedia.org/wiki/%E7%B6%B2%E8%B7%AF%E4%BA%A4%E6%8F%9B%E5%99%A8%5D(https://zh.wikipedia.org/wiki/%E7%B6%B2%E8%B7%AF%E4%BA%A4%E6%8F%9B%E5%99%A8)">维基百科：交换机</a></p> <p><img src="/blog/20200801151356.jpg?author=zhangpanqin" alt=""></p> <p>交换机上有多个端口（不是 port）供计算机连接，交换机会维护端口与连接这个端口的 PC 的 Mac 地址映射表。当交换机接受到数据的时候，会根据目的 Mac 地址，发送到对应的端口上，然后经过网线发送到目的 PC。</p> <p>交换机链接多个电脑组成一个局域网，交换机链接交换机又可以组成一个更大的局域网。</p> <p>比如 A、B 交换机各有 100 个端口，A 链接了 99 个 PC，然后 B 交换机链接 99 个，再将其中的一个端口 A/B 之间相互连接组成一个更大的局域网。</p> <h3 id="路由器"><a href="#路由器" class="header-anchor">#</a> 路由器</h3> <p><a href="%5Bhttps://zh.wikipedia.org/wiki/%E8%B7%AF%E7%94%B1%E5%99%A8%5D(https://zh.wikipedia.org/wiki/%E8%B7%AF%E7%94%B1%E5%99%A8)">维基百科：路由器</a></p> <p>路由器工作在网络层，主要用于将一个网段数据包转发到另一个网段内。路由器上也会有个几个 <code>LAN</code> 口 (Local Area Network，局域网)，用于建立局域网。还会有一个 <code>WAN</code>（Wide Area Network，广域网），连接运营商的网络。</p> <p>路由器也具有交换机的功能，只是 LAN 口 比较少，可以接入的电脑比较少。</p> <p>当 <code>PC</code> 或者 <code>手机</code> 连接无线路由器时也会给 <code>PC</code> 分配一个<code>局域网 IP</code>，子网掩码，网关等。</p> <p>我住的地方的网络拓扑图如下：<img src="/blog/20200801165520.png?author=zhangpanqin" alt="未命名文件"></p> <p>当手机与电脑通信的时候，实际通过 <code>LAN</code> 口走局域网通信。</p> <p>当手机访问 <code>维基百科</code> 时，实际是通过路由器跳入到光猫网段，再通过光猫跳入到小区运营商的网络，… 到维基百科的服务器上。</p> <p>只要需要有 IP 地址的设备（光猫，路由器，PC，手机）都需要有网卡，网卡出厂自带有 Mac 地址。IP 和 Mac 地址的作用后文中会介绍。</p> <p><img src="/blog/20200801144243.png?author=zhangpanqin" alt="image-20200801144243065"></p> <h3 id="交互机和路由器的区别"><a href="#交互机和路由器的区别" class="header-anchor">#</a> 交互机和路由器的区别</h3> <p><font color="red">这部分内容是我自己的理解，我没有在网上找到资料佐证，请谨慎对待</font></p> <p>其实交换机和路由器硬件差别不大，只是硬件上的软件决定了它能做什么。</p> <p>2 层交换机上的软件（只有数据链路层）可能只做解析帧，拿到 mac 地址，然后查找当前交换机的端口对应的 mac 地址，然后从对应的端口传递过去。</p> <p>路由器（有网络层和数据链路层），当拿到数据包的时候，发现目的 mac 地址不是自己，就会将数据包通过 LAN 口发送出去。</p> <p>当发送的数据包的 <code>目的 MAC 地址</code> 是当前路由器上 <code>MAC地址</code> ，路由器就会对其解包，拿到数据包 <code>目的 IP</code> ，然后根据 <code>目的 IP</code> 匹配下一跳 mac 地址，封包为新的帧数据发送出去。</p> <h2 id="tcp-ip-通信"><a href="#tcp-ip-通信" class="header-anchor">#</a> TCP/IP 通信</h2> <p><img src="/blog/20200801175145.svg?author=zhangpanqin" alt="TCP_IP 同一以太网 (2)"></p> <p>从发送端发送数据的时候，数据经过每层的封包，经物理层传送到接收端。接收端收到数据包，一层一层进行拆包，然后将数据数据发送给我接收端的应用层的应用程序。</p> <p>通常我们说的第一层就是 <code>物理层</code> ，第二层是 <code>链路层</code> …...</p> <h3 id="数据链路层"><a href="#数据链路层" class="header-anchor">#</a> 数据链路层</h3> <p><img src="/blog/20200801220255.png?author=zhangpanqin" alt="image-20200801220255714"></p> <p><code>源 MAC 地址</code> 就是发送端的 <code>MAC 地址</code>，目标 MAC 地址不是最终的 MAC 地址，是下一跳节点的 MAC 地址。</p> <p><code>类型</code> 指的是这个以太网帧中的 <code>数据</code> 是何种类型的数据，比如 IPV4，IPV6。然后调用对应的接口进行处理。</p> <p>数据链路层传输的帧是有大小限制的（64-1518 字节），能传输的数据的最大值就是 <code>最大传输单元</code>，简称 <code>MTU</code>，<code>Maximum Transmission Unit</code>。这个值在以太网中通常是 1500。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 查看网卡对应的 MTU</span>
<span class="token function">ifconfig</span> <span class="token parameter variable">-a</span>
<span class="token function">netstat</span> <span class="token parameter variable">-i</span>
</code></pre></div><h3 id="网络层"><a href="#网络层" class="header-anchor">#</a> 网络层</h3> <p>网络层主要以 <code>IP</code> 协议为主，也有 <code>ICMP</code>，ARP（在 <code>TCP\IP 模型</code> 中，<code>arp</code> 属于网络层。在 <code>osi 七层模型</code>，<code>arp</code> 数据链路层。）。</p> <h4 id="dns"><a href="#dns" class="header-anchor">#</a> DNS</h4> <p><code>IP</code> 是网络层通信的标识。但是 <code>IP</code> 不容易记忆，所以出现了 <code>域名</code>。</p> <p>访问 <code>DNS</code> 可以将域名解析为 <code>IP</code> 。</p> <p>可以在本地配置 <code>host</code> ,定义域名和 IP 对应关系，这样就不用解析了。</p> <p>也可以在电脑配置 DNS 解析时访问的 ip，这样域名解析时就会访问这个服务。</p> <img src="/blog/20200801182357.png?author=zhangpanqin" alt="image-20200801182357581" style="zoom:50%;"> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 解析域名的 ip</span>
<span class="token function">dig</span> www.mflyyou.cn
</code></pre></div><h4 id="ip-基础"><a href="#ip-基础" class="header-anchor">#</a> IP 基础</h4> <p><code>IP 地址</code> 又可以分为 <code>IPV4</code> 和 <code>IPV6</code>，目前使用比较广的是 <code>IPV4</code> ，所以只介绍 <code>IPV4</code>。</p> <p><code>IP 地址</code> 由 32 （2 进制）位组成，32 位被 <code>.</code> 分为了四组。每组 8 位，十进制表示就是 xxx.xxx.xxx.xxx（xxx 取值在 0-255）。</p> <p><code>IP 地址</code> 由 <code>网络地址</code> （网段） 和 <code>主机号</code> 。</p> <p>同一个网段的电脑用 2 层交互机相连，然后就可以局域网通信了。</p> <p>同一个网段内，主机号不能重复，重复主机号的电脑不能上网。</p> <p>为了便于区分出 IP 在那个网段，引入了<code>子网掩码</code> （netmask）。IP 地址与子网掩码按位与计算可以得出网段，32 位 中取出网段所在的位，剩余就是主机号能取得值。</p> <p>IP 中主机号全为 0 就是网段，全为 1 就是广播地址。这两个是不能被分配给电脑的。</p> <p>IP：192.168.202.116</p> <p>子网掩码：255.255.252.0</p> <p>网段为：192.168.200.0</p> <p>广播地址为：192.168.203.255</p> <p>IP：192.168.201.56</p> <p>子网掩码：255.255.252.0</p> <p>网段为：192.168.200.0</p> <p>广播地址为：192.168.203.255</p> <h3 id="icmp"><a href="#icmp" class="header-anchor">#</a> ICMP</h3> <p>网络层是不可靠传输，发送失败的数据包，网络层是不会再发一次数据包，但是会有 <code>ICMP</code> 包回复告诉你发包到底是什么问题。<code>传输层</code> 可以根据 <code>ICMP</code> 来判断是否需要重发包。</p> <h3 id="arp"><a href="#arp" class="header-anchor">#</a> ARP</h3> <p><code>ARP</code> 用于 IP 的 对应的 MAC 地址。</p> <p>目的 IP 在路由表中查询下一跳的 IP,在查询这个 IP 对应的 mac 地址</p> <p>查询的这个 <code>IP</code> 是当前网段内的 ip，它会通过广播地址发送给当前网段内所有主机，收到这个协议的主机会判断是否是当前主机，是的话就会恢复当前 ip 对应的 MAC 地址。</p> <p><img src="/blog/20200801223925.png?author=zhangpanqin" alt="image-20200801223925086"></p> <h3 id="通信过程分析"><a href="#通信过程分析" class="header-anchor">#</a> 通信过程分析</h3> <p><img src="/blog/20200801165520.png?author=zhangpanqin" alt="未命名文件"></p> <p>当我在浏览器输入 <code>wwww.mflyyou.cn</code> 的时候：</p> <p>1、先解析域名（DNS） <code>www.mflyyou.cn</code> 为 <code>IP</code> （目的 IP: 47.104.168.20）</p> <p>2、将目的 IP 与本地路由表中的子网掩码进行按位与，计算出网段与 Destination 匹配，看哪个匹配度更高，走哪个条目。都没有匹配到走默认条目（0.0.0.0）</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 查看路由表</span>
route <span class="token parameter variable">-n</span>
</code></pre></div><div class="language-txt extra-class"><pre class="language-txt"><code>Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.31.1    0.0.0.0         UG    100    0        0 eth0
</code></pre></div><p>3、然后用 arp 查询（有缓存可不查，走缓存）192.168.31.1 对应的 mac 地址</p> <p>4、数据链路层封装以太网帧数据包中的目的 MAC 地址址就是 <code>192.168.31.1</code> 对应的 mac 地址，然后将数据帧发送到下一个节点（这也就常说的下一跳，数据包发送只是找到当前接节点的下一个节点）</p> <p>5、到下一个路由器节点，路由器解包，看是发给自己的数据包（根据帧中的目的 MAC 地址与自己的 MAC 地址比较），不是就丢弃了；是的话就会解包拿到 <code>目的 IP</code> (47.104.168.20)，然后在当前路由器上根据路由表查询下一跳，发送给下一个节点；。。。。 直到目的服务器，或者发送的包 <code>TTL</code> 为 0</p> <p>6、发到目的服务器的网卡上，网卡将数据复制到内核缓冲区，应用程序从缓冲区中读取数据</p> <h3 id="ip-数据格式"><a href="#ip-数据格式" class="header-anchor">#</a> IP 数据格式</h3> <p><font color="red">IPv4 数据结构</font></p> <img src="/blog/20200802000153.png?author=zhangpanqin" alt="image-20200802000153692" style="zoom:50%;"> <blockquote><p>图来自《图解 TCP/IP》</p></blockquote> <ul><li><p>版本（Version）：4 bit 构成，代表当前 IP 包是哪个版本，IPv4 或者 IPv6，为 4 时表示当前是 IPv4。</p></li> <li><p>首部长度（Internet Header Length）：由 4 bit 构成，一般 20 字节大小。</p></li> <li><p>标识（Identification）：用于分片重组用，值相同的属于同一个 IP 数据包</p></li> <li><p>标志（Flags）：用于判断是否还有分片。</p></li> <li><p>总长度（Total Length）：16 个字节，IP 数据包总的长度，最长可为 65525 字节。</p></li> <li><p>分段偏移（Fragment Offset）：表示这个包在原来 IP 包中的位置。</p></li> <li><p>生存时间 TTL（Time To Live）: IP 包在路由转发中存活的时间，被路由转发一次，次数减 1，为 0 时，数据包被丢弃。</p></li> <li><p>挂载协议标识 （Protocol）：记录数据包中 <code>Data</code>（实际发送的数据）是什么类型的数据，1 标识 ICMP, 4 标识 IP, 6 标识 TCP, 17 标识 UDP。根据这个挂载协议程序就知道调用哪些接口来进行后续的处理了。</p></li></ul> <p>数据链路层中 <code>以太网数据帧</code> 的 <code>MTU</code> 是 1500 字节，限定了 IP 数据包最大为 1500 字节。然后去掉 IP 包首部 20 字节，一般 IP 数据包发送的数据为 1480 字节。</p> <p>当我们发送一个 3058 字节的 IP 数据包时，这显然大于了数据链路层的 MTU （1500 字节）。所以网络层会对大于链路层 MTU 的数据包进行分片。拆分一个一个的 1500 的数据包发送接收端，接收端接收到这三个包，在汇聚成一个完成的，在调用传输层接口。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 会发送 3050 字节数据与 8 字节的 ICMP 首部，这个命令会总共发送 ip 数据大小 3058 字节。</span>
<span class="token function">ping</span> <span class="token parameter variable">-s</span> <span class="token number">3050</span> www.mflyyou.cn
</code></pre></div><p><img src="/blog/20200801230015.png?author=zhangpanqin" alt="image-20200801230015436"></p> <img src="/blog/20200801230141.png?author=zhangpanqin" alt="image-20200801230141070" style="zoom:50%;"> <img src="/blog/20200801230528.png?author=zhangpanqin" alt="image-20200801230528418" style="zoom:50%;"> <img src="/blog/20200801230423.png?author=zhangpanqin" alt="image-20200801230423653" style="zoom:50%;"> <p>通过 <code>wireshark</code> 抓包可以看到，IP 数据包的首部长度占了 20 字节，实际每次发送数据为 1480 字节，最后一次发送了 98 字节。</p> <p>从 Fragment 和 Identification 可以看到这三个包属于同一个 IP 数据包，并且从 <code>Fragment offset</code> 能将这三个包合成一个完成的网络层数据包。</p> <h2 id="传输层-tcp"><a href="#传输层-tcp" class="header-anchor">#</a> 传输层 TCP</h2> <p><code>TCP</code> 是面向链接的，可靠的，全双工协议。</p> <p>面向连接就是发送之前，需要建立一个链接通道，数据都是在这个链接中发送。</p> <p><code>网络层</code> 是不可靠协议，数据发送失败是不会重发的。</p> <p><code>TCP</code> 协议中发送端会记录发送的那些数据包被客户端收到了。接收端接受数据之后，会回复一个 <code>ACK</code> 包（由数据格式中的控制位决定），确认应答号告诉发送端哪些数据包接收到了。</p> <p><code>发送端</code> 发送了数据包之后，这个包会有一个重发倒计时，在这个倒计时内没有收到<code>接收端</code> 回复 <code>ACK</code> 包，就会再重发一个数据包。如果是 <code>HTTP 请求</code> ，就相当于同样的数据请求了两次。</p> <p>我们知道支付接口都要求幂等性，有一部分原因是因为这个超时重发。发送端发送了请求，接收端处理好业务之后回复的 <code>ACK</code> 包超时，发送端超时重发这个请求。如果不保证接口的幂等性，那么扣钱就会扣两次。</p> <p>我们要做的就是保证这个重发 n+1 次不再扣用户的钱，一般会用一个 token 来判断是不是重复请求，重复就不走扣款处理了，直接返回已经支付，保证接口的幂等性。或者用一个账单流水来保证幂等性。</p> <p>连接既然需要建立，那么也会有连接断开。断开连接需双方协商好之后断开连接，不能单方面关闭而不管对方。因为建立连接之后占用的计算机资源需要释放掉。你单方面强制断开连接释放了资源，但是对方不知道需要断开连接，分配的计算机资源一直占用那就是不可靠协议了。所以 <code>TCP</code> 有四次挥手断开连接。</p> <p>全双工就是连接两边都可以主动发送接受数据，而不是轮训访问有没有数据到达。</p> <h3 id="tcp-数据格式"><a href="#tcp-数据格式" class="header-anchor">#</a> TCP 数据格式</h3> <p>首先我们要先了解 <code>TCP</code> 数据格式，才能更容易知道 TCP 的工作原理。</p> <img src="/blog/20200802000246.png?author=zhangpanqin" alt="image-20200802000246545" style="zoom:50%;"> <h3 id="源端口号-source-port"><a href="#源端口号-source-port" class="header-anchor">#</a> 源端口号（Source Port）</h3> <p>占用 2 个字节。标识 <code>发送端</code> 程序的端口号，当接收端需要回复消息的时候，需要带上这个端口号。</p> <h3 id="目的端口号-destination-port"><a href="#目的端口号-destination-port" class="header-anchor">#</a> 目的端口号（Destination Port）</h3> <p>占用 2 个字节。标识 <code>接收端</code> 程序的端口号，可以传递给监听在这个端口的程序</p> <h3 id="控制位-control-flag"><a href="#控制位-control-flag" class="header-anchor">#</a> 控制位（Control Flag）</h3> <p>占用 6 位，不满一个字节。标识当前 <code>TCP</code> 包是什么包，在通信过程中有一些特殊作用。</p> <h4 id="syn"><a href="#syn" class="header-anchor">#</a> <code>SYN</code></h4> <p>表示希望建立三次握手链接，并初始化序列号。</p> <h4 id="ack"><a href="#ack" class="header-anchor">#</a> <code>ACK</code></h4> <p>对收到数据包的应答确认。接收端接受数据之后，会回复 <code>ACK</code> 包，发送端从其上 <code>确认应答号</code> 知道接收端哪些数据已经接受了。</p> <h4 id="fin"><a href="#fin" class="header-anchor">#</a> <code>FIN</code></h4> <p>表示没有数据发送了，希望断开连接</p> <h4 id="pash"><a href="#pash" class="header-anchor">#</a> <code>PASH</code></h4> <p>接收端接收到这个数据包需要立刻传递给应用层，不能等待接收更多的数据包</p> <h4 id="ret"><a href="#ret" class="header-anchor">#</a> <code>RET</code></h4> <p>链接出现异常，需要强制断开连接</p> <h4 id="urg"><a href="#urg" class="header-anchor">#</a> <code>URG</code></h4> <p>表示包中有需要紧急处理的数据</p> <h3 id="序列号-sequence-number"><a href="#序列号-sequence-number" class="header-anchor">#</a> 序列号（Sequence Number）</h3> <p>占用 4 个字节。<code>TCP</code> 三次握手的时候，发送端和接收端各自初始化（随机的）自己的 `序列号。</p> <p>我们可以这样理解，发送端发送的数据就是一个字节数组，这个数组中每个字节都有一个 <code>序列号</code>。</p> <p>发送端和接收端都有自己的序列号，并且不相同，在三次握手的时候自己初始化，然后告知对方。</p> <h3 id="确认应答号-acknowledgement-number"><a href="#确认应答号-acknowledgement-number" class="header-anchor">#</a> 确认应答号（Acknowledgement Number）</h3> <p>占用 4 个字节。<code>确认应答号</code> 也是指的序列号，指的是期望发送端下次发送的序列号，这个序列号（确认应答号）之前的数据已经接受处理了。</p> <p>下图是我抓包建立三次链接，然后我发送三次 <code>1\n</code> 数据。</p> <p>三次握手，发送端通过发送 <code>SYN</code> 包，发送自己的初始化序列号（893189542），然后发送的每个字节都会有一个序列号。</p> <p>接收端发送 <code>ACK</code> 包中的 <code>确认应答号</code>，指明这个序列号之前的数据我已经接受了。</p> <img src="/blog/20200802205000.png?author=zhangpanqin" alt="image-20200802205000890" style="zoom:50%;"> <h3 id="窗口大小-window-size"><a href="#窗口大小-window-size" class="header-anchor">#</a> 窗口大小（Window Size）</h3> <p>窗口大小适用于流控的。发送端不能一直发送消息，需要根据我的接受能力来调整发包的速率。</p> <p><img src="/blog/20200809131931.svg?author=zhangpanqin" alt="未命名文件"></p> <p>内核会为每个 <code>TCP/IP</code> 分配读写缓冲区，网卡会从这些读写缓冲区中把数据取走，然后发送。数据大致可以分为这几类。</p> <p><code>TCP/IP</code> 是可靠连接，所以它需要记录哪些数据发送已被对方接受了（由确认应答号可以知道），接受的数据会被淘汰掉，节省内存空间。</p> <p>窗口大小作用：接收端会通过 <code>ACK</code> 告诉 <code>发送端</code> 调整窗口大小。</p> <p>当窗口中的数据全都是 <code>已发送未确认数据</code> 时，发送端不能再发送新的数据，必须等待窗口空出位置来。</p> <p><img src="/blog/20200809132819.svg?author=zhangpanqin" alt="未命名文件 (2)"></p> <p>当有一个数据包被确认了，发送端就可以发送新的数据包。<code>已发送未确认数据</code> 会在超时的时候重新发包。</p> <p><a href="%5Bhttps://baike.baidu.com/item/%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%5D(https://baike.baidu.com/item/%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3)">滑动窗口百度百科</a></p> <h3 id="校验和-checksum"><a href="#校验和-checksum" class="header-anchor">#</a> 校验和 (Checksum)</h3> <p>占用 2 个字节。<code>校验和</code> 用于校验数据包是否损坏。每个数据包都一个 <code>校验和</code> ，<code>接收端</code> 接收到数据之后，使用相同的算法对数据计算出一个值，然后和 <code>校验和</code>比较，不一样说明数据在传输过程中损坏了，<code>接收端</code> 会丢弃这个包，等待 <code>发送端</code> 重新发这个包。</p> <h3 id="tcp-中-mss"><a href="#tcp-中-mss" class="header-anchor">#</a> TCP 中 MSS</h3> <p>链路层能发送的最大以太网帧为 1500 字节，MTU 为 1500。</p> <p>IP 数据包能发送的最大数据 = MTU - IP 首部大小（一般 20 字节），IP 数据包超过这个 1500 字节会分片</p> <p>TCP 传输数据以段 （Segment） 为单位。</p> <p>TCP 为了避免分片，会主动将数据分片之后交给网络层。 TCP 能传输的最大分段（只是数据不包括首部）称之为 Max Segment Size，简称为 MSS。</p> <blockquote><p>MSS = MTU - IP 首部大小 - TCP 首部大小</p></blockquote> <p>在以太网中 TCP 的 MSS = 1500（MTU） - 20（一般 IP 首部大小） - 20（一般 TCP 首部大小）= 1460，这个值需要根据首部计算</p> <p><img src="/blog/20200802211639.png?author=zhangpanqin" alt="image-20200802211639395"></p> <p>MSS 值在三次握手时，会通过 MTU 计算的。</p> <h3 id="tcp-三次握手建立连接"><a href="#tcp-三次握手建立连接" class="header-anchor">#</a> TCP 三次握手建立连接</h3> <img src="/blog/20200802212532.png?author=zhangpanqin" alt="image-20200802212532628" style="zoom:33%;"> <blockquote><p>图片来自 码出高效：Java 开发手册</p></blockquote> <p>为什么是三次握手建立连接呢？很多面试官也会问。这其实是可靠连接的最少握手次数。</p> <img src="/blog/20200802212808.png?author=zhangpanqin" alt="image-20200802212808724" style="zoom:50%;"> <blockquote><p>图片来自 码出高效：Java 开发手册</p></blockquote> <p>这里还有个 <a href="https://mp.weixin.qq.com/s/W2E90sVT_wDArKMNxoQ0Mw" target="_blank" rel="noopener noreferrer">全连接队列和半链接队列<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的知识点</p> <h3 id="tcp-四次挥手断开连接"><a href="#tcp-四次挥手断开连接" class="header-anchor">#</a> TCP 四次挥手断开连接</h3> <img src="/blog/20200802213247.png?author=zhangpanqin" alt="image-20200802213247725" style="zoom:33%;"> <blockquote><p>图片来自 码出高效：Java 开发手册</p></blockquote> <p><code>CLOSE_WAIT</code> 是收到对方 <code>FIN</code> 包之后，回复 <code>ACK</code> 之后进入的状态。之后不会接受数据了，进行已收数据的业务处理之后，在发送一个 <code>ACK+FIN</code>，进入 <code>LASK_ACK</code>，然后等待对方发送 <code>ACK</code>，超时没有等到，会重试发送（内核可以配置重试发送次数）。当你发现服务端有大量的 <code>CLOSE_WAIT</code> 链接，服务端的代码有问题，需要排查。</p> <p><code>TIME_WAIT</code> 的链接多的话，服务端可以优化，不然这个链接会占用很长时间，在高并发的时候，会导致没有资源释放的慢。</p> <p>MSL 为 Maximum Segment Lifetime，在 centos 中默认值为 60s</p> <div class="language-txt extra-class"><pre class="language-txt"><code># sysctl -a | grep tcp_fin_timeout
# 推荐小于 30，也不能太小，15-30
net.ipv4.tcp_fin_timeout = 60
</code></pre></div><p>说明 A 机器链接会在 120 s 之后才能释放。这个是为了保证 B 机器 能接收到最后一个 <code>ACK</code>，当处于 <code>LAST_ACK</code> 的超时没有收到 A 发来的 <code>ACK</code> 的话，会重试发送一个 <code>FIN+ACK</code>。这个 2MSL 也是为了最大限度保证 B 机器正常关闭。</p> <p><code>三次握手建立连接</code> 和 <code>四次挥手断开连接</code> 需要结合抓包工具自己分析一下，理解会更深刻。</p> <h2 id="网络抓包"><a href="#网络抓包" class="header-anchor">#</a> 网络抓包</h2> <p><code>Wireshark</code> 抓包分析是很厉害的，<code>mac os</code> 和 <code>linux</code> 都有命令行程序 <code>tshark</code>，可以在服务器用 <code>tshark</code> 抓包，拿到本地来分析。</p> <p>抓包的时候一定要指定抓什么包，什么包都抓的话，一会你的电脑内存就飙升好多（别问我为啥知道，问就是 30g 内存都让它吃了）。</p> <p><code>Wireshark</code> 有个 <code>抓包过滤器</code> 和 <code>显示过滤器</code>。抓包的时候指定抓什么包这是 <code>抓包过滤器的作用</code>，抓包之后显示显示那些内容那是 <code>显示过滤器的作用</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># -i 指定那个网卡</span>
<span class="token comment"># -f 指定抓包过滤器</span>
<span class="token comment"># -Y 显示过滤器</span>
<span class="token comment"># -w 指定抓包数据到文件，没有 -w 输出屏幕</span>
<span class="token comment"># -V 显示 TCP/IP 每层包的详细信息，建议将抓包的文件在图形化界面中查看，不指定 -V</span>
tshark  <span class="token parameter variable">-i</span> en0 <span class="token parameter variable">-f</span> <span class="token string">&quot;tcp&quot;</span> <span class="token parameter variable">-Y</span> <span class="token string">&quot;http&quot;</span>

<span class="token comment"># 抓取访问 www.mflyyou.cn 的包</span>
tshark  <span class="token parameter variable">-i</span> en0 <span class="token parameter variable">-w</span> a.pcap <span class="token parameter variable">-f</span> <span class="token string">&quot;host www.mflyyou.cn&quot;</span>

<span class="token comment"># 指定抓那个协议 tcp,ip,icmp,arp,udp</span>
tshark  <span class="token parameter variable">-i</span> en0 <span class="token parameter variable">-f</span> <span class="token string">&quot;tcp&quot;</span>


<span class="token comment"># host 指定域名或者 ip</span>
<span class="token comment"># port 指定端口</span>
<span class="token comment"># 访问 www.mflyyou.cn 的包，或者 icmp. ping www.baidu.com 也会被抓到</span>
tshark  <span class="token parameter variable">-i</span> en0 <span class="token parameter variable">-f</span> <span class="token string">&quot;host www.mflyyou.cn || icmp&quot;</span>
tshark  <span class="token parameter variable">-i</span> en0 <span class="token parameter variable">-f</span> <span class="token string">&quot;port 80&quot;</span>

<span class="token comment"># 条件之间支持逻辑运算符 || &amp;&amp; !</span>
<span class="token comment"># 抓取 ssh 链接的包</span>
tshark  <span class="token parameter variable">-i</span> en0 <span class="token parameter variable">-f</span> <span class="token string">&quot;host www.mflyyou.cn &amp;&amp; port 22&quot;</span>
</code></pre></div><h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <p>《图解 TCP/IP》</p> <p><a href="https://man7.org/linux/man-pages/man7/tcp.7.html" target="_blank" rel="noopener noreferrer">linux-tcp 说明<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://cn.linux.vbird.org/linux_server/0110network_basic.php" target="_blank" rel="noopener noreferrer">鸟哥私房菜：基础网络的概念<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/zhangpanqin/mflyyou/edit/main/docs/tcp-ip/tcp-ip.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/3/23 下午1:18:45</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
            ←
            <a href="/tcp-ip/http/http-cors-jsonp.html" class="prev">
                跨域
            </a></span> <!----></p></div> </main> <aside class="right-sidebar"> <div class="right-sidebar-toc-container" style="display:;"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:650px"><div style="font-weight:bold;text-align:center;">你需要知道的TCP/IP</div> <hr> <div class="toc-box"><ul><li><a href="/tcp-ip/tcp-ip.html#前言" class="toc-sidebar-link">前言</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#本文内容" class="toc-sidebar-link">本文内容</a></li></ul></li><li><a href="/tcp-ip/tcp-ip.html#交换机与路由器" class="toc-sidebar-link">交换机与路由器</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#交换机" class="toc-sidebar-link">交换机</a></li><li class="toc-sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#路由器" class="toc-sidebar-link">路由器</a></li><li class="toc-sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#交互机和路由器的区别" class="toc-sidebar-link">交互机和路由器的区别</a></li></ul></li><li><a href="/tcp-ip/tcp-ip.html#tcp-ip-通信" class="toc-sidebar-link">TCP/IP 通信</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#数据链路层" class="toc-sidebar-link">数据链路层</a></li><li class="toc-sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#网络层" class="toc-sidebar-link">网络层</a></li><li class="toc-sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#icmp" class="toc-sidebar-link">ICMP</a></li><li class="toc-sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#arp" class="toc-sidebar-link">ARP</a></li><li class="toc-sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#通信过程分析" class="toc-sidebar-link">通信过程分析</a></li><li class="toc-sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#ip-数据格式" class="toc-sidebar-link">IP 数据格式</a></li></ul></li><li><a href="/tcp-ip/tcp-ip.html#传输层-tcp" class="toc-sidebar-link">传输层 TCP</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#tcp-数据格式" class="toc-sidebar-link">TCP 数据格式</a></li><li class="toc-sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#源端口号-source-port" class="toc-sidebar-link">源端口号（Source Port）</a></li><li class="toc-sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#目的端口号-destination-port" class="toc-sidebar-link">目的端口号（Destination Port）</a></li><li class="toc-sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#控制位-control-flag" class="toc-sidebar-link">控制位（Control Flag）</a></li><li class="toc-sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#序列号-sequence-number" class="toc-sidebar-link">序列号（Sequence Number）</a></li><li class="toc-sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#确认应答号-acknowledgement-number" class="toc-sidebar-link">确认应答号（Acknowledgement Number）</a></li><li class="toc-sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#窗口大小-window-size" class="toc-sidebar-link">窗口大小（Window Size）</a></li><li class="toc-sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#校验和-checksum" class="toc-sidebar-link">校验和 (Checksum)</a></li><li class="toc-sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#tcp-中-mss" class="toc-sidebar-link">TCP 中 MSS</a></li><li class="toc-sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#tcp-三次握手建立连接" class="toc-sidebar-link">TCP 三次握手建立连接</a></li><li class="toc-sidebar-sub-header"><a href="/tcp-ip/tcp-ip.html#tcp-四次挥手断开连接" class="toc-sidebar-link">TCP 四次挥手断开连接</a></li></ul></li><li><a href="/tcp-ip/tcp-ip.html#网络抓包" class="toc-sidebar-link">网络抓包</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/tcp-ip/tcp-ip.html#参考资料" class="toc-sidebar-link">参考资料</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div> <div class="right-sidebar-toolbar"><div class="option-box"><img src="/images/system/toc.png" class="nozoom"> <span class="show-txt">目录</span></div> <div class="option-box"><img src="/images/system/toggle.png" width="30px" class="nozoom"> <span class="show-txt">左栏</span></div> <div title="跨域" class="option-box" style="padding-left:2px;text-align:center;"><a href="/tcp-ip/http/http-cors-jsonp.html"><img src="/images/system/pre2.png" width="30px" class="nozoom"> <span class="show-txt">上一篇</span></a></div> <!----></div> </aside></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.9063a2a7.js" defer></script><script src="/assets/js/3.a2cf49c7.js" defer></script><script src="/assets/js/2.b18ee37c.js" defer></script><script src="/assets/js/88.09bd150d.js" defer></script><script src="/assets/js/7.f81fa904.js" defer></script>
  </body>
</html>
