<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>从锁升级的角度理解 synchronized | Mflyyou</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/mflyyou/favicon.ico">
    <meta name="description" content="张攀钦的笔记">
    <meta name="theme-color" content="#3eaf7c">
    
    <link rel="preload" href="/mflyyou/assets/css/0.styles.69128c36.css" as="style"><link rel="preload" href="/mflyyou/assets/js/app.0c7751fa.js" as="script"><link rel="preload" href="/mflyyou/assets/js/4.ec17e064.js" as="script"><link rel="preload" href="/mflyyou/assets/js/2.2ab84419.js" as="script"><link rel="preload" href="/mflyyou/assets/js/79.6faa50b1.js" as="script"><link rel="preload" href="/mflyyou/assets/js/12.60b8c9aa.js" as="script"><link rel="prefetch" href="/mflyyou/assets/js/10.71771dad.js"><link rel="prefetch" href="/mflyyou/assets/js/100.d4b7bfdd.js"><link rel="prefetch" href="/mflyyou/assets/js/101.01e93d9e.js"><link rel="prefetch" href="/mflyyou/assets/js/102.46613db8.js"><link rel="prefetch" href="/mflyyou/assets/js/103.2fcd8af3.js"><link rel="prefetch" href="/mflyyou/assets/js/104.bf311d2d.js"><link rel="prefetch" href="/mflyyou/assets/js/105.0b08c279.js"><link rel="prefetch" href="/mflyyou/assets/js/106.7d4e891c.js"><link rel="prefetch" href="/mflyyou/assets/js/107.fd860e32.js"><link rel="prefetch" href="/mflyyou/assets/js/108.eee8f360.js"><link rel="prefetch" href="/mflyyou/assets/js/109.3e863dae.js"><link rel="prefetch" href="/mflyyou/assets/js/11.09b8531d.js"><link rel="prefetch" href="/mflyyou/assets/js/110.fe54b70a.js"><link rel="prefetch" href="/mflyyou/assets/js/111.40d6949e.js"><link rel="prefetch" href="/mflyyou/assets/js/13.6a4881ad.js"><link rel="prefetch" href="/mflyyou/assets/js/14.63e74f99.js"><link rel="prefetch" href="/mflyyou/assets/js/15.ff0d92a8.js"><link rel="prefetch" href="/mflyyou/assets/js/16.588c1feb.js"><link rel="prefetch" href="/mflyyou/assets/js/17.d7b70f01.js"><link rel="prefetch" href="/mflyyou/assets/js/18.8238ccdb.js"><link rel="prefetch" href="/mflyyou/assets/js/19.4112adb5.js"><link rel="prefetch" href="/mflyyou/assets/js/20.72811bd0.js"><link rel="prefetch" href="/mflyyou/assets/js/21.31258db4.js"><link rel="prefetch" href="/mflyyou/assets/js/22.111044cd.js"><link rel="prefetch" href="/mflyyou/assets/js/23.9685277f.js"><link rel="prefetch" href="/mflyyou/assets/js/24.8b332282.js"><link rel="prefetch" href="/mflyyou/assets/js/25.2d72c5e4.js"><link rel="prefetch" href="/mflyyou/assets/js/26.acafd3ae.js"><link rel="prefetch" href="/mflyyou/assets/js/27.5c9391b9.js"><link rel="prefetch" href="/mflyyou/assets/js/28.a797684e.js"><link rel="prefetch" href="/mflyyou/assets/js/29.6120b352.js"><link rel="prefetch" href="/mflyyou/assets/js/3.a15d2cd4.js"><link rel="prefetch" href="/mflyyou/assets/js/30.72a75ae8.js"><link rel="prefetch" href="/mflyyou/assets/js/31.ea895aad.js"><link rel="prefetch" href="/mflyyou/assets/js/32.cabbf8f2.js"><link rel="prefetch" href="/mflyyou/assets/js/33.c22b6ef7.js"><link rel="prefetch" href="/mflyyou/assets/js/34.118a8f29.js"><link rel="prefetch" href="/mflyyou/assets/js/35.7dea91c9.js"><link rel="prefetch" href="/mflyyou/assets/js/36.2b1418da.js"><link rel="prefetch" href="/mflyyou/assets/js/37.5fea3731.js"><link rel="prefetch" href="/mflyyou/assets/js/38.ac4ccd84.js"><link rel="prefetch" href="/mflyyou/assets/js/39.71cba9ce.js"><link rel="prefetch" href="/mflyyou/assets/js/40.d11c705d.js"><link rel="prefetch" href="/mflyyou/assets/js/41.9cc92f08.js"><link rel="prefetch" href="/mflyyou/assets/js/42.b0378352.js"><link rel="prefetch" href="/mflyyou/assets/js/43.7cc4c727.js"><link rel="prefetch" href="/mflyyou/assets/js/44.607141d7.js"><link rel="prefetch" href="/mflyyou/assets/js/45.b6d64035.js"><link rel="prefetch" href="/mflyyou/assets/js/46.d8ea00dd.js"><link rel="prefetch" href="/mflyyou/assets/js/47.42893905.js"><link rel="prefetch" href="/mflyyou/assets/js/48.1636bffb.js"><link rel="prefetch" href="/mflyyou/assets/js/49.172a52c9.js"><link rel="prefetch" href="/mflyyou/assets/js/5.e9d85935.js"><link rel="prefetch" href="/mflyyou/assets/js/50.3634166d.js"><link rel="prefetch" href="/mflyyou/assets/js/51.4a68ee66.js"><link rel="prefetch" href="/mflyyou/assets/js/52.ecf03a3d.js"><link rel="prefetch" href="/mflyyou/assets/js/53.0bf43b16.js"><link rel="prefetch" href="/mflyyou/assets/js/54.61fe004b.js"><link rel="prefetch" href="/mflyyou/assets/js/55.042fc13c.js"><link rel="prefetch" href="/mflyyou/assets/js/56.a5ffdebe.js"><link rel="prefetch" href="/mflyyou/assets/js/57.23c8504d.js"><link rel="prefetch" href="/mflyyou/assets/js/58.c2817095.js"><link rel="prefetch" href="/mflyyou/assets/js/59.c661ea23.js"><link rel="prefetch" href="/mflyyou/assets/js/6.49873bca.js"><link rel="prefetch" href="/mflyyou/assets/js/60.dae65c33.js"><link rel="prefetch" href="/mflyyou/assets/js/61.15af6a15.js"><link rel="prefetch" href="/mflyyou/assets/js/62.4a73cb4a.js"><link rel="prefetch" href="/mflyyou/assets/js/63.4ad72a00.js"><link rel="prefetch" href="/mflyyou/assets/js/64.cb057bdf.js"><link rel="prefetch" href="/mflyyou/assets/js/65.389d85fd.js"><link rel="prefetch" href="/mflyyou/assets/js/66.74c7a091.js"><link rel="prefetch" href="/mflyyou/assets/js/67.4ee35fdf.js"><link rel="prefetch" href="/mflyyou/assets/js/68.ab448e96.js"><link rel="prefetch" href="/mflyyou/assets/js/69.32f2c42c.js"><link rel="prefetch" href="/mflyyou/assets/js/7.b3070f80.js"><link rel="prefetch" href="/mflyyou/assets/js/70.7bc80c52.js"><link rel="prefetch" href="/mflyyou/assets/js/71.d666e2e3.js"><link rel="prefetch" href="/mflyyou/assets/js/72.48d54577.js"><link rel="prefetch" href="/mflyyou/assets/js/73.072fe402.js"><link rel="prefetch" href="/mflyyou/assets/js/74.b439919d.js"><link rel="prefetch" href="/mflyyou/assets/js/75.34ae4967.js"><link rel="prefetch" href="/mflyyou/assets/js/76.7b42229e.js"><link rel="prefetch" href="/mflyyou/assets/js/77.0ed63c57.js"><link rel="prefetch" href="/mflyyou/assets/js/78.16dee96f.js"><link rel="prefetch" href="/mflyyou/assets/js/8.0476bdcb.js"><link rel="prefetch" href="/mflyyou/assets/js/80.a7e467ad.js"><link rel="prefetch" href="/mflyyou/assets/js/81.77689652.js"><link rel="prefetch" href="/mflyyou/assets/js/82.ac0c77ea.js"><link rel="prefetch" href="/mflyyou/assets/js/83.866c1af6.js"><link rel="prefetch" href="/mflyyou/assets/js/84.c40cb145.js"><link rel="prefetch" href="/mflyyou/assets/js/85.a2f77426.js"><link rel="prefetch" href="/mflyyou/assets/js/86.2a4320a1.js"><link rel="prefetch" href="/mflyyou/assets/js/87.fa3b9bc7.js"><link rel="prefetch" href="/mflyyou/assets/js/88.ca3a2353.js"><link rel="prefetch" href="/mflyyou/assets/js/89.599b9ed1.js"><link rel="prefetch" href="/mflyyou/assets/js/9.9ed1f826.js"><link rel="prefetch" href="/mflyyou/assets/js/90.d626a497.js"><link rel="prefetch" href="/mflyyou/assets/js/91.b546a07a.js"><link rel="prefetch" href="/mflyyou/assets/js/92.e369ff4e.js"><link rel="prefetch" href="/mflyyou/assets/js/93.cdffa607.js"><link rel="prefetch" href="/mflyyou/assets/js/94.4e7be313.js"><link rel="prefetch" href="/mflyyou/assets/js/95.2bb38e9a.js"><link rel="prefetch" href="/mflyyou/assets/js/96.77f15dfc.js"><link rel="prefetch" href="/mflyyou/assets/js/97.d33fcf38.js"><link rel="prefetch" href="/mflyyou/assets/js/98.5c38d6a2.js"><link rel="prefetch" href="/mflyyou/assets/js/99.463cd264.js">
    <link rel="stylesheet" href="/mflyyou/assets/css/0.styles.69128c36.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mflyyou/" class="home-link router-link-active"><!----> <span class="site-name">Mflyyou</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/mflyyou/java/base/java-messy-code.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/mflyyou/go/base/go-command.html" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/mflyyou/springboot/" class="nav-link">
  SpringBoot
</a></div><div class="nav-item"><a href="/mflyyou/tcp-ip/http/http-cors-jsonp/" class="nav-link">
  TCP/IP
</a></div><div class="nav-item"><a href="/mflyyou/dev-tools/asdf/" class="nav-link">
  开发工具
</a></div><div class="nav-item"><a href="/mflyyou/devops/docker/" class="nav-link">
  DevOps
</a></div> <a href="https://github.com/zhangpanqin/mflyyou" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/mflyyou/java/base/java-messy-code.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/mflyyou/go/base/go-command.html" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/mflyyou/springboot/" class="nav-link">
  SpringBoot
</a></div><div class="nav-item"><a href="/mflyyou/tcp-ip/http/http-cors-jsonp/" class="nav-link">
  TCP/IP
</a></div><div class="nav-item"><a href="/mflyyou/dev-tools/asdf/" class="nav-link">
  开发工具
</a></div><div class="nav-item"><a href="/mflyyou/devops/docker/" class="nav-link">
  DevOps
</a></div> <a href="https://github.com/zhangpanqin/mflyyou" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Java 基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mflyyou/java/base/java-messy-code.html" class="sidebar-link">深入理解 Java 乱码问题</a></li><li><a href="/mflyyou/java/base/java-run-command.html" class="sidebar-link">java command</a></li><li><a href="/mflyyou/java/base/java-reference.html" class="sidebar-link">java 中强软弱虚引用的妙用</a></li><li><a href="/mflyyou/java/base/how-to-read-file-in-java.html" class="sidebar-link">Java-中读取文件内容的-n-中方式</a></li><li><a href="/mflyyou/java/base/java-asynchronous-programming.html" class="sidebar-link">java 异步编程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>IO</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mflyyou/java/io/io-module.html" class="sidebar-link">从linux内核理解Java怎样实现Socket通信</a></li><li><a href="/mflyyou/java/io/java-io.html" class="sidebar-link">从Linux内核理解Java中的IO</a></li><li><a href="/mflyyou/java/io/java-nio.html" class="sidebar-link">从Linux内核理解JAVA的NIO</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JUC</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mflyyou/java/juc/synchronized.html" aria-current="page" class="active sidebar-link">从锁升级的角度理解 synchronized</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mflyyou/java/juc/synchronized.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/mflyyou/java/juc/synchronized.html#synchronized-使用" class="sidebar-link">synchronized 使用</a></li><li class="sidebar-sub-header"><a href="/mflyyou/java/juc/synchronized.html#synchronized-原理" class="sidebar-link">synchronized 原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mflyyou/java/juc/synchronized.html#原理描述" class="sidebar-link">原理描述</a></li><li class="sidebar-sub-header"><a href="/mflyyou/java/juc/synchronized.html#对象布局" class="sidebar-link">对象布局</a></li><li class="sidebar-sub-header"><a href="/mflyyou/java/juc/synchronized.html#jol-查看对象信息" class="sidebar-link">Jol 查看对象信息</a></li></ul></li><li class="sidebar-sub-header"><a href="/mflyyou/java/juc/synchronized.html#锁升级过程" class="sidebar-link">锁升级过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mflyyou/java/juc/synchronized.html#普通对象到轻量级锁" class="sidebar-link">普通对象到轻量级锁</a></li><li class="sidebar-sub-header"><a href="/mflyyou/java/juc/synchronized.html#偏向锁" class="sidebar-link">偏向锁</a></li><li class="sidebar-sub-header"><a href="/mflyyou/java/juc/synchronized.html#重量级锁" class="sidebar-link">重量级锁</a></li></ul></li></ul></li><li><a href="/mflyyou/java/juc/volatile.html" class="sidebar-link">你需要了解 Lock 的前提-volatile</a></li><li><a href="/mflyyou/java/juc/thread-pool-executor.html" class="sidebar-link">ThreadPoolExecutor</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mflyyou/java/jvm/" class="sidebar-link">JVM 参数查看</a></li><li><a href="/mflyyou/java/jvm/jvm-memory-model.html" class="sidebar-link">认识 Java 运行时数据区</a></li><li><a href="/mflyyou/java/jvm/class-loader.html" class="sidebar-link">Java 类加载器及类加载过程</a></li><li><a href="/mflyyou/java/jvm/jvm-gc.html" class="sidebar-link">了解垃圾回收和常用虚拟机参数</a></li><li><a href="/mflyyou/java/jvm/jvm-gc-demo.html" class="sidebar-link">GC 示例</a></li><li><a href="/mflyyou/java/jvm/G1.html" class="sidebar-link">G1</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>通用工具</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mflyyou/java/lib/snowflake.html" class="sidebar-link">雪花算法</a></li><li><a href="/mflyyou/java/lib/distributed_lock.html" class="sidebar-link">分布式锁</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>在 Java 中为保证线程安全，可以使用关键字 <code>synchronized</code> 保护代码，在多个线程之间同时只能有一个线程执行被保护的代码。</p> <p><code>synchronized</code> 锁的到底是什么？是对象，还是代码块呢？</p> <p>保证线程安全已经有了 <code>synchronized</code> 为什么又会出现 <code>Lock</code> 呢，二者之间有什么区别呢？</p> <p><code>synchronized</code> 一定比 <code>Lock</code> 性能差吗？</p> <p><code>synchronized</code> 的锁升级过程是什么，偏向锁，轻量级锁，自旋锁，重量级锁怎么一步一步实现的？</p> <h2 id="synchronized-使用"><a href="#synchronized-使用" class="header-anchor">#</a> synchronized 使用</h2> <p>1、用在静态方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleUserSync</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 相当于   synchronized (SimpleUserSync.class){a++;}</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span>  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addA_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        a<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>2、用在成员方法上</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleUserSync</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 相当于   synchronized (this){a++;}</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span>  <span class="token keyword">void</span> <span class="token function">addA_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        a<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>3、用在代码块</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> <span class="token constant">LOCK</span> <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addA_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token constant">LOCK</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        a<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="synchronized-原理"><a href="#synchronized-原理" class="header-anchor">#</a> synchronized 原理</h2> <h3 id="原理描述"><a href="#原理描述" class="header-anchor">#</a> 原理描述</h3> <p>如果对一项技术只停留在会用的阶段是远远不够的，原理性的知识可避免掉到坑里面去。</p> <p><code>JDK 1.6</code> 之前，还没有进行 <code>synchronized</code> 的优化。那个时候 <code>synchronized</code> 只要申请锁，<code>java 进程</code> 就会从 <code>用户态</code> 切换到 <code>内核态</code>,需要操作系统配合锁定，这种切换相对来说比较占用系统资源。</p> <p><code>Lock</code> 的实现的思想是：线程基于 <code>CAS</code> 操作在 <code>用户态</code> 自旋改变内部的 <code>state</code>，操作成功即可获取锁，操作不成功，继续自旋获取直到成功（分配的 cpu 时间执行完之后，再获取到 cpu 资源，仍接着自旋获取锁）。这种实现方式在锁竞争比较小的情况下，效率是比较高的。比起 <code>用户态</code> 切换到 <code>内核态</code>，让线程在哪里自旋一会效率是比较高的。如果一直自旋（比如说 1 分钟）获取不到锁，那<code>用户态</code> 切换到 <code>内核态</code> 比你自旋一分钟效率会高。</p> <p><code>Lock</code> 不一定比 <code>synchronized</code> 效率高，在锁竞争的几率极大的情况下，自旋消耗的资源远大于 <code>用户态</code> 切换到 <code>内核态</code>占用的资源。</p> <p><code>JDK 1.6</code> 对 <code>synchronized</code> 做了优化。在锁竞争不大的情况下，使用 <code>偏向锁</code> 和 <code>轻量级锁</code>，这样只用在 <code>用户态</code> 完成锁的申请。当锁竞争的时候呢，会让其自旋继续获取锁，获取 n 次还是没有获取到（自适应自旋锁），升级为 <code>重量级锁</code>，<code>用户态</code> 切换到 <code>内核态</code>，从系统层级获取锁。</p> <p>锁升级的宏观表现大致是这个样子。自适应自旋锁，自旋的次数 n，是 <code>JVM</code> 根据算法收集其自旋多少次获取锁算出来的（JDK 1.6 之后），是一个预测值，随着数据收集越来越多，它也越准确。</p> <p><code>synchronized</code> 是通过锁对象来实现的。因此了解一个对象的布局，对我们理解锁的实现及升级是很有帮助的。</p> <h3 id="对象布局"><a href="#对象布局" class="header-anchor">#</a> 对象布局</h3> <img src="/blog/20200613211643.png?author=zhangpanqin" alt="image-20200613211643599" style="zoom:25%;"> <p>对象填充，是将一个对象大小不足 8 个字节的倍数时，使用 0 填充补齐，为了更高效效率的读取数据，64 java 虚拟机，一次读取是 64 bit（8 字节）。</p> <h4 id="对象头-object-header"><a href="#对象头-object-header" class="header-anchor">#</a> 对象头（Object Header）</h4> <p>在 64 位 JVM 上有一个压缩指针选项-XX:+UseCompressedOops，默认是开启的。开启之后 <code>Class Pointer</code> 部分就会压缩为 4 字节，对象头大小为 <code>12 字节</code></p> <p><img src="/blog/20200613201507.png?author=zhangpanqin" alt=""></p> <h4 id="mark-word"><a href="#mark-word" class="header-anchor">#</a> Mark Word</h4> <p><img src="/blog/20200613163707.png?author=zhangpanqin" alt="图来自马士兵教育多线程公开课"></p> <p><code>偏向锁位</code> 和 <code>锁标志位</code> 是锁升级过程中承担重要的角色。</p> <h3 id="jol-查看对象信息"><a href="#jol-查看对象信息" class="header-anchor">#</a> Jol 查看对象信息</h3> <p>我们可以使用 <code>jol</code> 查看一个对象的对象头信息，已达到观测锁升级的过程</p> <p><a href="https://hg.openjdk.java.net/code-tools/jol/file/tip/jol-samples/src/main/java/org/openjdk/jol/samples/" target="_blank" rel="noopener noreferrer"> jol 官方示例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.openjdk.jol<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jol-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JOLSample_01_Basic</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JOLSample_01_Basic<span class="token punctuation">.</span>A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> f<span class="token punctuation">;</span>
        <span class="token keyword">int</span> a<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p><img src="/blog/20200613214753.png?author=zhangpanqin" alt="image-20200613214753341"></p> <h2 id="锁升级过程"><a href="#锁升级过程" class="header-anchor">#</a> 锁升级过程</h2> <p><img src="/blog/20200613163442.png?author=zhangpanqin" alt="图来自马士兵教育多线程公开课"></p> <p><font color="red">偏向锁是默认开启的，但是有个延迟时间</font></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 查看偏向锁配置的默认参数</span>
<span class="token function">java</span> <span class="token parameter variable">-XX:+PrintFlagsInitial</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-i</span> biased

<span class="token comment"># 偏向锁启动的延迟，Java 虚拟机启动 4 秒之后，创建的对象才是匿名偏向，否则是普通对象</span>
<span class="token comment">#intx BiasedLockingStartupDelay                 = 4000                                {product}</span>
<span class="token comment"># 默认开启偏向锁</span>
<span class="token comment">#bool UseBiasedLocking                          = true                                {product}</span>
</code></pre></div><p><font color="red">锁升级之后，用户线程不能降级。GC 线程可以降级</font></p> <h3 id="普通对象到轻量级锁"><a href="#普通对象到轻量级锁" class="header-anchor">#</a> 普通对象到轻量级锁</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JOLSample_12_ThinLocking</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">A</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassLayout</span> layout <span class="token operator">=</span> <span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;**** 对象创建,没有经过锁竞争&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>layout<span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;**** 获取到锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>layout<span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;**** 锁释放&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>layout<span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>因为偏向锁的延迟，创建的对象为普通对象（偏向锁位 0，锁标志位 01），获取锁的时候，<code>无锁</code>（偏向锁位 0，锁标志位 01） 升级为 <code>轻量级锁</code>（偏向锁位 0，锁标志位 00），释放锁之后，对象的锁信息（偏向锁位 0，锁标志位 01）</p> <img src="/blog/20200613221547.png?author=zhangpanqin" alt="image-20200613221547109" style="zoom:33%;"> <p><code>synchronized (a)</code> 的时候，由 <code>a</code> 的 <code>Mark Word</code> 中锁偏向 0，锁标志位 01 知道锁要升级为轻量级锁。java 虚拟机会在当前的线程的栈帧中建立一个锁记录（Lock Record）空间，Lock Record 储存锁对象的 <code>Mark World</code>拷贝和当前锁对象的指针。</p> <p>java 虚拟机，使用 <code>CAS</code> 将 a 的 <code>Mark Word（62 位）</code> 指向当前线程（main 线程）中 <code>Lock Record</code> 指针，CAS 操作成功，将 a 的锁标志位变为 00。</p> <img src="/blog/20200613224235.png?author=zhangpanqin" alt="image-20200613224235023" style="zoom:50%;"> <p>CAS 操作失败。会依据 a 对象 Mark Word 判断是否指向当前线程的栈帧，如果是，说明当前线程已经拥有锁了，直接进入代码块执行（可重入锁）。</p> <p>如果 a 对象的 Mark Word 判断是另外一个线程拥有所，会升级锁，锁标志位改为 （10）。</p> <p>轻量级锁解锁，就是将 <code>Lock Record</code> 中的 a 的 mark word 拷贝，通过 CAS 替换 a 对象头中的 mark word ,替换成功解锁顺利完成。</p> <h3 id="偏向锁"><a href="#偏向锁" class="header-anchor">#</a> 偏向锁</h3> <p>偏向锁是比轻量级锁更轻量的锁。轻量级锁，每次获取锁的时候，都会使用 CAS 判断是否可以加锁，不管有没有别的线程竞争。</p> <p>偏向锁呢，比如说 T 线程获取到了 a 对象的偏向锁，a 的 Mark Word 会记录当前 T 线程的 id ,当下次获取锁的时候。T 线程再获取 a 锁的时候，只需要判断 a 的 Mark Word 中的偏向锁位和当前持有 a 锁的线程 id，而不再需要通过 CAS 操作获取偏向锁了。</p> <p>延迟 6 秒创建 a 对象，这时已经过了偏向锁延迟的时间，创建的对象为可偏向对象。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JOLSample_13_BiasedLocking</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">A</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassLayout</span> layout <span class="token operator">=</span> <span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;**** Fresh object&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>layout<span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;**** With the lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>layout<span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;**** After the lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>layout<span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
        <span class="token comment">// no fields</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><img src="/blog/20200613231613.png?author=zhangpanqin" alt="image-20200613231613645" style="zoom:33%;"> <h3 id="重量级锁"><a href="#重量级锁" class="header-anchor">#</a> 重量级锁</h3> <p>写了一个 demo ，验证 偏向锁，轻量级锁，重量级锁的逐渐升级过程。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JOLSample_14_FatLocking</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 延迟六秒执行例子，创建的 a 为可偏向对象</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">A</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassLayout</span> layout <span class="token operator">=</span> <span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;**** 查看初始化 a 的对象头&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>layout<span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 这里模拟获取锁，当前获取到的锁为 偏向锁</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 阻塞等待获取 t 线程完成</span>
        t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;**** t 线程获得锁之后&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>layout<span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// a 的存在两个想成竞争锁，锁升级为轻量级锁</span>
                out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;**** t2 第二次获取锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>layout<span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 开启 t3 线程模拟竞争，t3 会自旋获得锁，由于 t2 阻塞了 3 秒，t3 自旋是得不到锁的，锁升级为重量级锁</span>
        <span class="token keyword">final</span> <span class="token class-name">Thread</span> t3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;**** t3 不停获取锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>layout<span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 为了 t2 先获得锁，这里阻塞 10ms ,再开启 t3 线程</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t3<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>t3<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 验证 gc 可以使锁降级</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;**** After System.gc()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>layout<span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-txt extra-class"><pre class="language-txt"><code>**** 查看初始化 a 的对象头
com.fly.blog.sync.JOLSample_14_FatLocking$A object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           05 00 00 00 (00000101 00000000 00000000 00000000) (5)

**** t 线程获得锁之后
com.fly.blog.sync.JOLSample_14_FatLocking$A object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           05 f0 52 d3 (00000101 11110000 01010010 11010011) (-749539323)

**** t2 第二次获取锁
com.fly.blog.sync.JOLSample_14_FatLocking$A object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           f8 38 c3 10 (11111000 00111000 11000011 00010000) (281229560)

**** t3 不停获取锁
com.fly.blog.sync.JOLSample_14_FatLocking$A object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           5a 1b 82 d2 (01011010 00011011 10000010 11010010) (-763225254)

**** After System.gc()
com.fly.blog.sync.JOLSample_14_FatLocking$A object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           09 00 00 00 (00001001 00000000 00000000 00000000) (9)
</code></pre></div><p>观察各阶段对象头中的 <code>偏向锁位</code> 和 <code>锁标志位</code> 。可以看到锁在不断升级。然后看到 gc 之后，又变成了无锁。</p> <p><code>t2</code> 线程持有锁 <code>a</code> 的 <code>轻量级锁</code> 的时候，t3 也在获得 a 的 <code>轻量级锁</code>，<code>CAS</code> 修改 a 的 <code>Mark Word</code> 为 t3 所有失败。导致了锁升级为重量级锁，设置 a 的锁标志位为 10，并且将 <code>Mark Word</code> 指针指向一个 monitor 对象，并将当前线程阻塞，将当前线程放入到 <code>_EntryList</code> 队列中。当 t2 执行完之后，它解锁的时候发现当前锁已经升级为重量级锁，释放锁的时候，会唤醒 <code>_EntryList</code> 的线程，让它们去抢 a 锁。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">ObjectMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _owner        <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// 持有这把锁监视器线程</span>
    _WaitSet      <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// 处于wait状态的线程，会被加入到_WaitSet</span>
    _EntryList    <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span> <span class="token comment">// 处于等待锁block状态的线程，会被加入到该列表</span>
<span class="token punctuation">}</span>
</code></pre></div><p><a href="https://docs.oracle.com/javase/specs/jls/se8/html/index.html" target="_blank" rel="noopener noreferrer">Java Language Specification<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-txt extra-class"><pre class="language-txt"><code>Java Language Specification    https://docs.oracle.com/javase/specs/jls/se8/html/index.html
Every object, in addition to having an associated monitor, has an associated wait set. A wait set is a set of threads.

When an object is first created, its wait set is empty. Elementary actions that add threads to and remove threads from wait sets are atomic. Wait sets are manipulated solely through the methods Object.wait, Object.notify, and Object.notifyAll.
</code></pre></div><p>调用对象的 <code>Object.wait</code> 方法，该线程会释放锁，并将当前线程放入到 monitor 的 <code>_WaitSet</code> 队列中，等某个线程调用 <code>Object.notify, and Object.notifyAll</code>，实际就是唤醒 <code>_WaitSet</code> 中的线程。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/zhangpanqin/mflyyou/edit/main/docs/java/juc/synchronized.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/10/29 上午7:32:10</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
            ←
            <a href="/mflyyou/java/io/java-nio.html" class="prev">
                从Linux内核理解JAVA的NIO
            </a></span> <span class="next"><a href="/mflyyou/java/juc/volatile.html">
                你需要了解 Lock 的前提-volatile
            </a>
            →
        </span></p></div> </main> <aside class="right-sidebar"> <div class="right-sidebar-toc-container" style="display:;"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:650px"><div style="font-weight:bold;text-align:center;">从锁升级的角度理解 synchronized</div> <hr> <div class="toc-box"><ul><li><a href="/mflyyou/java/juc/synchronized.html#前言" class="toc-sidebar-link">前言</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/mflyyou/java/juc/synchronized.html#synchronized-使用" class="toc-sidebar-link">synchronized 使用</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/mflyyou/java/juc/synchronized.html#synchronized-原理" class="toc-sidebar-link">synchronized 原理</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/mflyyou/java/juc/synchronized.html#原理描述" class="toc-sidebar-link">原理描述</a></li><li class="toc-sidebar-sub-header"><a href="/mflyyou/java/juc/synchronized.html#对象布局" class="toc-sidebar-link">对象布局</a></li><li class="toc-sidebar-sub-header"><a href="/mflyyou/java/juc/synchronized.html#jol-查看对象信息" class="toc-sidebar-link">Jol 查看对象信息</a></li></ul></li><li><a href="/mflyyou/java/juc/synchronized.html#锁升级过程" class="toc-sidebar-link">锁升级过程</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/mflyyou/java/juc/synchronized.html#普通对象到轻量级锁" class="toc-sidebar-link">普通对象到轻量级锁</a></li><li class="toc-sidebar-sub-header"><a href="/mflyyou/java/juc/synchronized.html#偏向锁" class="toc-sidebar-link">偏向锁</a></li><li class="toc-sidebar-sub-header"><a href="/mflyyou/java/juc/synchronized.html#重量级锁" class="toc-sidebar-link">重量级锁</a></li></ul></li></ul></div></div></div></div> <div class="right-sidebar-toolbar"><div class="option-box"><img src="/mflyyou/images/system/toc.png" class="nozoom"> <span class="show-txt">目录</span></div> <div class="option-box"><img src="/mflyyou/images/system/toggle.png" width="30px" class="nozoom"> <span class="show-txt">左栏</span></div> <div title="从Linux内核理解JAVA的NIO" class="option-box" style="padding-left:2px;text-align:center;"><a href="/mflyyou/java/io/java-nio.html"><img src="/mflyyou/images/system/pre2.png" width="30px" class="nozoom"> <span class="show-txt">上一篇</span></a></div> <div title="你需要了解 Lock 的前提-volatile" class="option-box" style="padding-left:2px;text-align:center;"><a href="/mflyyou/java/juc/volatile.html"><img src="/mflyyou/images/system/next2.png" width="30px" class="nozoom"> <span class="show-txt">下一篇</span></a></div></div> </aside></div><div class="global-ui"><!----><!----></div></div>
    <script src="/mflyyou/assets/js/app.0c7751fa.js" defer></script><script src="/mflyyou/assets/js/4.ec17e064.js" defer></script><script src="/mflyyou/assets/js/2.2ab84419.js" defer></script><script src="/mflyyou/assets/js/79.6faa50b1.js" defer></script><script src="/mflyyou/assets/js/12.60b8c9aa.js" defer></script>
  </body>
</html>
