<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>从linux内核理解Java怎样实现Socket通信 | Mflyyou</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/mflyyou/favicon.ico">
    <meta name="description" content="张攀钦的笔记">
    <meta name="theme-color" content="#3eaf7c">
    
    <link rel="preload" href="/mflyyou/assets/css/0.styles.b6588544.css" as="style"><link rel="preload" href="/mflyyou/assets/js/app.1ebce3ec.js" as="script"><link rel="preload" href="/mflyyou/assets/js/5.060b7482.js" as="script"><link rel="preload" href="/mflyyou/assets/js/2.337a644b.js" as="script"><link rel="preload" href="/mflyyou/assets/js/73.d613ca64.js" as="script"><link rel="preload" href="/mflyyou/assets/js/13.4af4aae9.js" as="script"><link rel="prefetch" href="/mflyyou/assets/js/10.13d2098d.js"><link rel="prefetch" href="/mflyyou/assets/js/100.6b5f6658.js"><link rel="prefetch" href="/mflyyou/assets/js/101.1309bb11.js"><link rel="prefetch" href="/mflyyou/assets/js/102.a670d5e1.js"><link rel="prefetch" href="/mflyyou/assets/js/103.a654de66.js"><link rel="prefetch" href="/mflyyou/assets/js/104.3ee8ac1b.js"><link rel="prefetch" href="/mflyyou/assets/js/105.f865a9da.js"><link rel="prefetch" href="/mflyyou/assets/js/106.3db4bc18.js"><link rel="prefetch" href="/mflyyou/assets/js/107.86df4273.js"><link rel="prefetch" href="/mflyyou/assets/js/108.b7e9e440.js"><link rel="prefetch" href="/mflyyou/assets/js/11.0bf0370f.js"><link rel="prefetch" href="/mflyyou/assets/js/12.fa71d27f.js"><link rel="prefetch" href="/mflyyou/assets/js/14.1489cead.js"><link rel="prefetch" href="/mflyyou/assets/js/15.2ee76f25.js"><link rel="prefetch" href="/mflyyou/assets/js/16.84f457ea.js"><link rel="prefetch" href="/mflyyou/assets/js/17.5d4f1dec.js"><link rel="prefetch" href="/mflyyou/assets/js/18.c6b9fecb.js"><link rel="prefetch" href="/mflyyou/assets/js/19.1035b370.js"><link rel="prefetch" href="/mflyyou/assets/js/20.def9a443.js"><link rel="prefetch" href="/mflyyou/assets/js/21.26682c03.js"><link rel="prefetch" href="/mflyyou/assets/js/22.62a9c6b0.js"><link rel="prefetch" href="/mflyyou/assets/js/23.515399df.js"><link rel="prefetch" href="/mflyyou/assets/js/24.6bf3a2cd.js"><link rel="prefetch" href="/mflyyou/assets/js/25.a7fc332e.js"><link rel="prefetch" href="/mflyyou/assets/js/26.acc05f74.js"><link rel="prefetch" href="/mflyyou/assets/js/27.df62034b.js"><link rel="prefetch" href="/mflyyou/assets/js/28.a17f9051.js"><link rel="prefetch" href="/mflyyou/assets/js/29.bf9b8bf2.js"><link rel="prefetch" href="/mflyyou/assets/js/3.172e0e5c.js"><link rel="prefetch" href="/mflyyou/assets/js/30.c1b15405.js"><link rel="prefetch" href="/mflyyou/assets/js/31.1ca60331.js"><link rel="prefetch" href="/mflyyou/assets/js/32.c60f993e.js"><link rel="prefetch" href="/mflyyou/assets/js/33.cd2ec5a7.js"><link rel="prefetch" href="/mflyyou/assets/js/34.2ae655a8.js"><link rel="prefetch" href="/mflyyou/assets/js/35.39f0314c.js"><link rel="prefetch" href="/mflyyou/assets/js/36.76ac8750.js"><link rel="prefetch" href="/mflyyou/assets/js/37.92fa0b22.js"><link rel="prefetch" href="/mflyyou/assets/js/38.1e81e861.js"><link rel="prefetch" href="/mflyyou/assets/js/39.e45c223b.js"><link rel="prefetch" href="/mflyyou/assets/js/4.17a133fa.js"><link rel="prefetch" href="/mflyyou/assets/js/40.850524c7.js"><link rel="prefetch" href="/mflyyou/assets/js/41.d904d47b.js"><link rel="prefetch" href="/mflyyou/assets/js/42.74644fc4.js"><link rel="prefetch" href="/mflyyou/assets/js/43.d9b5b83a.js"><link rel="prefetch" href="/mflyyou/assets/js/44.6c61b2f6.js"><link rel="prefetch" href="/mflyyou/assets/js/45.66700c63.js"><link rel="prefetch" href="/mflyyou/assets/js/46.dc39c419.js"><link rel="prefetch" href="/mflyyou/assets/js/47.0ddd4e71.js"><link rel="prefetch" href="/mflyyou/assets/js/48.053c6f31.js"><link rel="prefetch" href="/mflyyou/assets/js/49.6f5f4490.js"><link rel="prefetch" href="/mflyyou/assets/js/50.dd55f743.js"><link rel="prefetch" href="/mflyyou/assets/js/51.12a7ecf3.js"><link rel="prefetch" href="/mflyyou/assets/js/52.826138a9.js"><link rel="prefetch" href="/mflyyou/assets/js/53.9d5ff3e8.js"><link rel="prefetch" href="/mflyyou/assets/js/54.29061e3d.js"><link rel="prefetch" href="/mflyyou/assets/js/55.d814cfd2.js"><link rel="prefetch" href="/mflyyou/assets/js/56.c7059609.js"><link rel="prefetch" href="/mflyyou/assets/js/57.68dbe6db.js"><link rel="prefetch" href="/mflyyou/assets/js/58.06bbd4a4.js"><link rel="prefetch" href="/mflyyou/assets/js/59.3c39689b.js"><link rel="prefetch" href="/mflyyou/assets/js/6.939cdf3c.js"><link rel="prefetch" href="/mflyyou/assets/js/60.0c3fa548.js"><link rel="prefetch" href="/mflyyou/assets/js/61.34c71010.js"><link rel="prefetch" href="/mflyyou/assets/js/62.ccb9cf2e.js"><link rel="prefetch" href="/mflyyou/assets/js/63.ad9dc6aa.js"><link rel="prefetch" href="/mflyyou/assets/js/64.2ac503ea.js"><link rel="prefetch" href="/mflyyou/assets/js/65.d9e32710.js"><link rel="prefetch" href="/mflyyou/assets/js/66.9ad8e53d.js"><link rel="prefetch" href="/mflyyou/assets/js/67.d0e9b568.js"><link rel="prefetch" href="/mflyyou/assets/js/68.131208e9.js"><link rel="prefetch" href="/mflyyou/assets/js/69.152fc2aa.js"><link rel="prefetch" href="/mflyyou/assets/js/7.09832819.js"><link rel="prefetch" href="/mflyyou/assets/js/70.a6a4c0d9.js"><link rel="prefetch" href="/mflyyou/assets/js/71.35aa5807.js"><link rel="prefetch" href="/mflyyou/assets/js/72.1b63f1ed.js"><link rel="prefetch" href="/mflyyou/assets/js/74.b49eac90.js"><link rel="prefetch" href="/mflyyou/assets/js/75.cb165e12.js"><link rel="prefetch" href="/mflyyou/assets/js/76.0710e669.js"><link rel="prefetch" href="/mflyyou/assets/js/77.52c1a01a.js"><link rel="prefetch" href="/mflyyou/assets/js/78.c748b2b5.js"><link rel="prefetch" href="/mflyyou/assets/js/79.c2d56fac.js"><link rel="prefetch" href="/mflyyou/assets/js/8.0139ba8e.js"><link rel="prefetch" href="/mflyyou/assets/js/80.b4badf91.js"><link rel="prefetch" href="/mflyyou/assets/js/81.a2e99bcd.js"><link rel="prefetch" href="/mflyyou/assets/js/82.5c0e5ecc.js"><link rel="prefetch" href="/mflyyou/assets/js/83.290d422f.js"><link rel="prefetch" href="/mflyyou/assets/js/84.f26844dd.js"><link rel="prefetch" href="/mflyyou/assets/js/85.c226a65d.js"><link rel="prefetch" href="/mflyyou/assets/js/86.f9fd95fe.js"><link rel="prefetch" href="/mflyyou/assets/js/87.cdb9b919.js"><link rel="prefetch" href="/mflyyou/assets/js/88.5f3630e8.js"><link rel="prefetch" href="/mflyyou/assets/js/89.43523bf0.js"><link rel="prefetch" href="/mflyyou/assets/js/9.5bef5ca8.js"><link rel="prefetch" href="/mflyyou/assets/js/90.e2cb20cd.js"><link rel="prefetch" href="/mflyyou/assets/js/91.4f92828a.js"><link rel="prefetch" href="/mflyyou/assets/js/92.b42ed060.js"><link rel="prefetch" href="/mflyyou/assets/js/93.fa96fb9d.js"><link rel="prefetch" href="/mflyyou/assets/js/94.ef7b58a2.js"><link rel="prefetch" href="/mflyyou/assets/js/95.f452a910.js"><link rel="prefetch" href="/mflyyou/assets/js/96.36d19357.js"><link rel="prefetch" href="/mflyyou/assets/js/97.1e0d9cd1.js"><link rel="prefetch" href="/mflyyou/assets/js/98.c1326730.js"><link rel="prefetch" href="/mflyyou/assets/js/99.2401c0fe.js">
    <link rel="stylesheet" href="/mflyyou/assets/css/0.styles.b6588544.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mflyyou/" class="home-link router-link-active"><!----> <span class="site-name">Mflyyou</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/mflyyou/java/base/java-messy-code.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/mflyyou/go/base/go-command.html" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/mflyyou/springboot/project-sumary/" class="nav-link">
  SpringBoot
</a></div><div class="nav-item"><a href="/mflyyou/tcp-ip/http/http-cors-jsonp/" class="nav-link">
  TCP/IP
</a></div><div class="nav-item"><a href="/mflyyou/dev-tools/asdf/" class="nav-link">
  开发工具
</a></div><div class="nav-item"><a href="/mflyyou/devops/docker/" class="nav-link">
  DevOps
</a></div> <a href="https://github.com/zhangpanqin/mflyyou" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/mflyyou/java/base/java-messy-code.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/mflyyou/go/base/go-command.html" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/mflyyou/springboot/project-sumary/" class="nav-link">
  SpringBoot
</a></div><div class="nav-item"><a href="/mflyyou/tcp-ip/http/http-cors-jsonp/" class="nav-link">
  TCP/IP
</a></div><div class="nav-item"><a href="/mflyyou/dev-tools/asdf/" class="nav-link">
  开发工具
</a></div><div class="nav-item"><a href="/mflyyou/devops/docker/" class="nav-link">
  DevOps
</a></div> <a href="https://github.com/zhangpanqin/mflyyou" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Java 基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mflyyou/java/base/java-messy-code.html" class="sidebar-link">深入理解 Java 乱码问题</a></li><li><a href="/mflyyou/java/base/java-run-command.html" class="sidebar-link">java command</a></li><li><a href="/mflyyou/java/base/java-reference.html" class="sidebar-link">java 中强软弱虚引用的妙用</a></li><li><a href="/mflyyou/java/base/how-to-read-file-in-java.html" class="sidebar-link">Java-中读取文件内容的-n-中方式</a></li><li><a href="/mflyyou/java/base/java-asynchronous-programming.html" class="sidebar-link">java 异步编程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>IO</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mflyyou/java/io/io-module.html" aria-current="page" class="active sidebar-link">从linux内核理解Java怎样实现Socket通信</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#内核参数说明" class="sidebar-link">内核参数说明</a></li><li class="sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#本文内容" class="sidebar-link">本文内容</a></li></ul></li><li class="sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#bio-通信" class="sidebar-link">BIO 通信</a></li><li class="sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#全连接队列和半链接队列" class="sidebar-link">全连接队列和半链接队列</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#tcp-抓包" class="sidebar-link">TCP 抓包</a></li><li class="sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#全连接队列溢出" class="sidebar-link">全连接队列溢出</a></li><li class="sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#半链接队列溢出" class="sidebar-link">半链接队列溢出</a></li></ul></li><li class="sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#nio-通信" class="sidebar-link">NIO 通信</a></li><li class="sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#io-多路复用" class="sidebar-link">IO 多路复用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#epoll-相关的系统调用" class="sidebar-link">epoll 相关的系统调用</a></li><li class="sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#epoll-触发方式" class="sidebar-link">epoll 触发方式</a></li></ul></li><li class="sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#java-多路复用" class="sidebar-link">Java 多路复用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#一个简单-demo" class="sidebar-link">一个简单 Demo</a></li></ul></li><li class="sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#参考资料" class="sidebar-link">参考资料</a></li></ul></li><li><a href="/mflyyou/java/io/java-io.html" class="sidebar-link">从Linux内核理解Java中的IO</a></li><li><a href="/mflyyou/java/io/java-nio.html" class="sidebar-link">从Linux内核理解JAVA的NIO</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JUC</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mflyyou/java/juc/synchronized.html" class="sidebar-link">从锁升级的角度理解 synchronized</a></li><li><a href="/mflyyou/java/juc/volatile.html" class="sidebar-link">你需要了解 Lock 的前提-volatile</a></li><li><a href="/mflyyou/java/juc/thread-pool-executor.html" class="sidebar-link">ThreadPoolExecutor</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mflyyou/java/jvm/" class="sidebar-link">JVM 参数查看</a></li><li><a href="/mflyyou/java/jvm/jvm-memory-model.html" class="sidebar-link">认识 Java 运行时数据区</a></li><li><a href="/mflyyou/java/jvm/class-loader.html" class="sidebar-link">Java 类加载器及类加载过程</a></li><li><a href="/mflyyou/java/jvm/jvm-gc.html" class="sidebar-link">了解垃圾回收和常用虚拟机参数</a></li><li><a href="/mflyyou/java/jvm/jvm-gc-demo.html" class="sidebar-link">GC 示例</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>通用工具</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mflyyou/java/lib/snowflake.html" class="sidebar-link">雪花算法</a></li><li><a href="/mflyyou/java/lib/distributed_lock.html" class="sidebar-link">分布式锁</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>前段时间买本书研究了 <code>TCP/IP</code> 通信，弄清楚了计算机之间是怎么通信的。网络通信的的基础就是 <code>TCP/IP 协议簇</code>，也被称为 <code>TCP/IP 协议栈</code> ，也被简称为 <code>TCP/IP 协议</code>。 <code>TCP/IP 协议</code> 并不是只有 <code>TCP</code> 和 <code>IP</code> 协议，只是这俩用的比较多，就用这两个起的名字。</p> <p>我们目前使用的 <code>HTTP</code> , <code>FTP</code> , <code>SMTP</code> , <code>DNS</code> , <code>HTTPS</code> , <code>SSH</code> , <code>MQTT</code> , <code>RPC</code> 等都是以 <code>TCP/IP协议</code> 为基础。下图针对的是 <code>传输层为 TCP</code> 。</p> <img src="/blog/20200718221518.svg?author=zhangpanqin" alt="TCP_IP 同一以太网 (1)" style="zoom:50%;"> <p><code>Linux 内核</code> 为我们屏蔽了 <code>TCP/IP</code> 通信模型的复杂性，并且 Linux 中一切皆文件，因此为我们抽象了 <code>Socket</code> 文件，实际我们编码的时候，主要是通过一些系统调用和 <code>Socket</code> 打交道。</p> <p>在 Java 中，网络通信这块 <code>netty</code> 提供了很大的便利，但是你了解了这些原理之后，<code>netty</code> 你也了解的差不多了。</p> <h3 id="内核参数说明"><a href="#内核参数说明" class="header-anchor">#</a> 内核参数说明</h3> <p><a href="https://www.kernel.org/doc/Documentation/sysctl/net.txt" target="_blank" rel="noopener noreferrer">/proc/sys/net/* 说明<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt" target="_blank" rel="noopener noreferrer">TCP/IP 内核参数说明<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.kernel.org/doc/Documentation/sysctl/fs.txt" target="_blank" rel="noopener noreferrer">文件系统部分 /proc/sys/fs/* 说明<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-txt extra-class"><pre class="language-txt"><code>https://www.kernel.org/doc/Documentation/sysctl/net.txt
https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt
https://www.kernel.org/doc/Documentation/sysctl/fs.txt
</code></pre></div><p>修改内核参数，有两种改法，比如修改 <code>tcp_syn_retries = 5</code></p> <ul><li>临时修改</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 查看参数的完整值 net.ipv4.tcp_syn_retries = 6</span>
<span class="token function">sysctl</span> <span class="token parameter variable">-a</span>  <span class="token operator">|</span> <span class="token function">grep</span> tcp_syn_retries
<span class="token comment"># linux 一切皆文件，所以这个东西也是会在文件中保存，我们可以修改这个文件内容，临时生效，重启之后就不影响</span>
<span class="token comment"># 内核属性文件路径都是在 /proc/sys 下，剩余的路径就是 net.ipv4.tcp_syn_retries 中的 . 替换为 /</span>
<span class="token builtin class-name">echo</span> <span class="token number">5</span> <span class="token operator">&gt;</span> /proc/sys/net/ipv4/tcp_syn_retries

<span class="token comment"># 查看修改之后的值</span>
<span class="token function">sysctl</span> <span class="token parameter variable">-a</span>  <span class="token operator">|</span> <span class="token function">grep</span> tcp_syn_retries
</code></pre></div><ul><li>永久修改</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># tcp_syn_retries = 7</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;net.ipv4.tcp_syn_retries = 7&quot;</span> <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf

<span class="token comment"># 让修改生效</span>
<span class="token function">sysctl</span> <span class="token parameter variable">-p</span>

<span class="token comment"># 查看修改之后的值</span>
<span class="token function">sysctl</span> <span class="token parameter variable">-a</span>  <span class="token operator">|</span> <span class="token function">grep</span> tcp_syn_retries
</code></pre></div><h3 id="本文内容"><a href="#本文内容" class="header-anchor">#</a> 本文内容</h3> <ul><li>BIO 通信模型（画图说明）及 java 代码实现</li> <li>NIO 通信模型及 java 代码实现</li> <li>多路复用通信模型（画图说明），主要是 <code>epoll</code>，会详细讲解</li></ul> <p>通信模型是按照 <code>BIO</code> -&gt; <code>NIO</code> -&gt; <code>多路复用</code> 慢慢演变过来的，因为互联网的发展，并发要求比较高。</p> <p><a href="https://github.com/zhangpanqin/fly-java-socket" target="_blank" rel="noopener noreferrer">本文所用代码地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-txt extra-class"><pre class="language-txt"><code>https://github.com/zhangpanqin/fly-java-socket
</code></pre></div><p>本文内容环境：</p> <ul><li>jdk .18</li> <li>Linux version 3.10.0-693.5.2.el7.x86_64</li></ul> <h2 id="bio-通信"><a href="#bio-通信" class="header-anchor">#</a> BIO 通信</h2> <p><img src="/blog/20200719112747.svg?author=zhangpanqin" alt="Socket 通信 (1)"></p> <p><code>BIO 通信模型</code> 中，<code>服务端</code> <code>ServerSocket.accpet</code> 会阻塞等待新的客户端经过 <code>TCP 三次握手</code> 建立连接，当客户端 <code>Socket</code> 建立了链接，就可以通过 <code>ServerSocket.accpet</code> 得到这个 <code>Socket</code> ，然后对这个 <code>Socket</code> 进行读写数据。</p> <p><code>Socket</code> 读写数据时，会阻塞当前线程直到操作完成，因此我们需要为每个客户端分配一个线程，然后在线程中死循环从 <code>Socket</code> 读取数据（客户端发来的数据）。还需要分配一个线程池对 <code>Socket</code> 进行写数据 （发送数据到客户端）。</p> <img src="/blog/20200719151354.svg?author=zhangpanqin" alt="Java Bio"> <p>应用程序调用系统调用 <code>read</code> 将数据从 <code>内核态</code> 到 <code>用户态</code> ,这个过程在 <code>BIO</code> 中是阻塞的。而且数据你不知道什么时候过来，只能在一个线程中死循环查看数据是否可读。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当内核没有准备好数据的时候，一直在这里阻塞等待数据到来</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>length <span class="token operator">=</span> inputStreamBySocket<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token constant">EOF</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;接收到客户端的消息,clientId: {} ,message: {}&quot;</span><span class="token punctuation">,</span> clientId<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;客户端关闭了,clientId: {},服务端释放资源&quot;</span><span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>服务端主动往客户端写数据，应用程序调用 <code>write</code> 也是阻塞的。 我们可以通过线程池来做。为每个客户端会分配一个 id 属性维持会话，用 <code>ConcurrentHashMap&lt;Integer, SocketBioClient&gt;</code> 保持，要想 1 号客户端写数据，直接从这个 <code>Map</code> 拿出客户端，然后往里面写入数据。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writeMessage</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> clientId<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据客户端 id 取出客户端。</span>
    <span class="token keyword">final</span> <span class="token class-name">SocketBioClient</span> socketBioClient <span class="token operator">=</span> <span class="token constant">CLIENT</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>socketBioClient<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;clientId: &quot;</span> <span class="token operator">+</span> clientId <span class="token operator">+</span> <span class="token string">&quot; 不合法&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 在线程池中运行写入数据</span>
    threadPoolExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>socketBioClient<span class="token punctuation">.</span><span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">CLIENT</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        socketBioClient<span class="token punctuation">.</span><span class="token function">writeMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>BIO 通信</code> 在并发比较大的时候，就显得力不从心了。比如有五万链接建立，就需要建立五万个线程来进行维护通信。在 <code>java</code> 中线程占用的内存假设为 <code>512KB</code>，内存占用 <code>24GB(50000*0.5/1024GB)</code>，还有 CPU 需要调度五万个线程来读取客户端数据和应答，CPU 绝大数的资源都会浪费在线程切换上去了，并且通信的实时性更不能保证。</p> <h2 id="全连接队列和半链接队列"><a href="#全连接队列和半链接队列" class="header-anchor">#</a> 全连接队列和半链接队列</h2> <p>1、服务端需要绑定一个 <code>serverIp</code> 和 <code>serverPort</code> ; java 中 api 为 <code>ServerSocket.bind</code></p> <p>2、然后在这个 <code>serverIp</code> 和 <code>serverPort</code> 上监听客户端的链接的到来</p> <p>3、客户单绑定一个 <code>clientIp</code> 和 <code>clientPort</code>，然后调用 <code>Socket.conect(serverIp,serverPort)</code>，经过内核建立 Tcp 链接。</p> <p>4、然后在服务端死循环调用 <code>ServerSocket.accept</code> 拿到建立连接 <code>Socket</code></p> <p>5、<code>Socket.read</code> 读取客户端发来的数据，<code>Socket.wirte</code> 写数据到客户端</p> <p><code>serverIp</code> 和 <code>serverPort</code> 是确定的，只要 <code>clientIp</code> 和 <code>clientPort</code> 只要有一个不同就可以看做是不同的客户端。</p> <p><code>clientIp</code> <code>clientPort</code> <code>serverIp</code> <code>serverPort</code> 在通信中也叫四元组，这四个确定才能建立 <code>TCP/IP</code> 链接。</p> <p>比如我们的浏览器加载页面的时候，实际是随机创建了一个合法 <code>本地 port</code> ，加上已知的 <code>clientIp</code> 去请求 <code>serverIp</code> 和 <code>serverPort</code> 获取数据。</p> <p><img src="/blog/20200726150610.svg?author=zhangpanqin" alt="TCP 链接建立 (2)"></p> <p>​ 客户端链接服务端的 <code>TCP</code> 三次握手过程：</p> <p>1、<code>客户端</code> 发送一个 <code>SYN</code> 包给服务端，在 <code>客户端</code> 运行 <code>netstat -natp</code> ，可以查看到处于 <code>SYN-SENT</code> 状态</p> <p>2、<code>服务端</code> 接受到 <code>客户端</code> <code>SYN</code> 包，将连接放入半链接队列，然后发送 <code>客户端</code> 一个 <code>SYN+ACK</code> 包，状态处于 <code>SYN_REVD</code></p> <p>3、<code>客户端</code> 收到来服务端的 <code>SYN+ACK</code> 包，回复一个 <code>ACK</code>，状态处于 <code>ESTABLISHED</code> (服务端全连接队列满的时候，客户端链接也是这个状态，当你发送数据的时候，服务端会回复一个 <code>RST</code> 包重置链接)</p> <p>4、<code>服务端</code> 收到来自客户端的 <code>ACK</code>，链接状态变为 <code>ESTABLISHED</code> （只有服务端看这个状态状态的链接才是真正 TCP 链接过程走完的），并将连接放入到全连接队列</p> <p>队列是一个有界队列，当全连接队列和半链接队列溢时，会有配置的内核参数决定采用对应的策略处理。</p> <h3 id="tcp-抓包"><a href="#tcp-抓包" class="header-anchor">#</a> TCP 抓包</h3> <div class="language-bash extra-class"><pre class="language-bash"><code> <span class="token comment"># wireshark,需要安装这个程序，抓包相关的截图，我使用的 wireshark，mac 也有对应程序</span>
 <span class="token comment"># -i 指定抓取那个网卡，port 指定只显示这个 port 的包</span>
 tshark <span class="token parameter variable">-i</span> eth0 port <span class="token number">10222</span>

 <span class="token comment"># linux 自带</span>
 tcpdump <span class="token parameter variable">-nn</span> <span class="token parameter variable">-i</span> eth0 port <span class="token number">10222</span>
</code></pre></div><h3 id="全连接队列溢出"><a href="#全连接队列溢出" class="header-anchor">#</a> 全连接队列溢出</h3> <p>我在写代码验证及抓包的时候发现，设置的全队列长度为 10，但是可以建立 11 个链接，12 个链接建立的时候就发生了全连接溢出。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">cat</span> /proc/sys/net/ipv4/tcp_abort_on_overflow

<span class="token comment"># 临时修改</span>
<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">&gt;</span> /proc/sys/net/ipv4/tcp_abort_on_overflow
<span class="token comment"># 临时修改，修改为 2 之后，发现重试只有两次了</span>
<span class="token builtin class-name">echo</span> <span class="token number">2</span> <span class="token operator">&gt;</span> /proc/sys/net/ipv4/tcp_synack_retries
</code></pre></div><p>当 <code>tcp_abort_on_overflow</code> 为 0 时（默认），表示如果第三次握手（客户端发送了 <code>ACK</code>）的时候，全连接队列满了，服务端会发送给客户端一个包让其重试发送 <code>ACK</code>。<code>sysctl -a | grep tcp_synack_retries</code> 查看服务端配置第三次握手重试的次数，默认为 5 次。</p> <p><img src="/blog/20200725201134.png?author=zhangpanqin" alt="image-20200725201134175"></p> <p>TCP 三次握手中的第三次客户端发送 <code>ACK</code> 给服务端，全连接队列满了，会丢弃第三次的 <code>ACK</code> 包，所以后续的过程中，是客户端再次发送 <code>ACK</code> 的包给服务端，服务端一直丢弃，所以，客户端一直发送 <code>ACK</code>。</p> <p>当 <code>tcp_abort_on_overflow</code> 为 1 时，表示如果第三次握手（客户端发送了 <code>ACK</code>）的时候，全连接队列满了，服务端会回复一个 <code>RST</code> 包，关闭连接过程</p> <p><img src="/blog/20200725200201.png?author=zhangpanqin" alt="image-20200725200200971"></p> <h3 id="半链接队列溢出"><a href="#半链接队列溢出" class="header-anchor">#</a> 半链接队列溢出</h3> <p>半链接队列的长度计算公式，来源于 <a href="/mflyyou/java/io/[https:/cjting.me/2019/08/28/tcp-queue/#全连接队列溢出](https:/cjting.me/2019/08/28/tcp-queue/#全连接队列溢出)">从一次 Connection Reset 说起，TCP 半连接队列与全连接队列</a></p> <ul><li><code>backlog</code>，<code>listen</code> 时传入的参数，我传入的 10</li> <li><code>somaxconn</code> ，我的是 128</li> <li><code>tcp_max_syn_backlog</code>，我的为 128</li></ul> <p><a href="https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt" target="_blank" rel="noopener noreferrer">somaxconn 和 tcp_max_syn_backlog 参数含义<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 查看对应端口的 Send-Q</span>
ss <span class="token parameter variable">-lnt</span>

<span class="token comment"># net.core.somaxconn = 128</span>
<span class="token function">sysctl</span> <span class="token parameter variable">-a</span> <span class="token operator">|</span> <span class="token function">grep</span> somaxconn

<span class="token comment"># net.ipv4.tcp_max_syn_backlog = 128</span>
<span class="token function">sysctl</span> <span class="token parameter variable">-a</span> <span class="token operator">|</span> <span class="token function">grep</span> tcp_max_syn_backlog
</code></pre></div><p>syn flood 攻击，模拟半链接溢出</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># -p 指定端口</span>
<span class="token comment"># --rand-source 伪造源 ip</span>
<span class="token comment"># -S 只发送 SYN 包</span>
<span class="token comment"># --flood 不停的攻击</span>
<span class="token comment"># 10.211.55.8 攻击的目的 ip</span>
hping3 <span class="token parameter variable">-S</span> <span class="token parameter variable">--flood</span> --rand-source <span class="token parameter variable">-p</span> <span class="token number">10222</span> <span class="token number">10.211</span>.55.8
<span class="token comment"># 计算半链接的数量</span>
<span class="token function">netstat</span> <span class="token parameter variable">-natp</span> <span class="token operator">|</span> <span class="token function">grep</span> SYN <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span>
</code></pre></div><p>我分别将 <code>backlog</code> 设置为 7，123，511 测试的公式正确</p> <div class="language-txt extra-class"><pre class="language-txt"><code>nr_table_entries = min(backlog, somaxconn, tcp_max_syn_backlog)
nr_table_entries = max(nr_table_entries, 8)
// roundup_pow_of_two: 将参数（nr_table_entries + 1）向上取整到最小的 2^n
nr_table_entries = roundup_pow_of_two(nr_table_entries + 1)
max_qlen_log = max(3, log2(nr_table_entries))
max_queue_length = 2^max_qlen_log
</code></pre></div><p><code>SYN FLOOD</code> 的防御</p> <p>客户端发送大量的 SYN 包，然后就不走后面的握手过程，导致服务端半链接队列满了，无法接受正常用户的握手链接。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 默认为 1，开启 syn cookie</span>
<span class="token function">cat</span> /proc/sys/net/ipv4/tcp_syncookies

<span class="token comment"># 临时修改为 0 ，tcp_syncookies</span>
<span class="token builtin class-name">echo</span> <span class="token number">0</span> <span class="token operator">&gt;</span> /proc/sys/net/ipv4/tcp_syncookies
</code></pre></div><p>内核参数 <code>tcp_syncookies</code> 设置可以帮我们做一些防御 <code>SYN FLOOD</code> 攻击，当设置为 0 的时候，半链接队列满了，服务端会丢弃客户端的 <code>SYN</code> 包，客户端链接的时候，没有收到 <code>SYN+ACK</code> 会重试发送 <code>SYN</code> 包，超过了重试次数，建立连接失败。</p> <p>linux 中是内核参数 <code>net.ipv4.tcp_syn_retries = 6</code> ，限制 <code>SYN</code> 重试次数，当前半链接队列已经满了，新的正常链接建立的时候，重试发送的 <code>SYN</code> 次数。</p> <p>当设置 <code>tcp_syncookies=0</code> 时，是不能抵御 <code>SYN FLOOD</code> 攻击的，新的正常用户建立不了链接。</p> <p><img src="/blog/20200726134558.png?author=zhangpanqin" alt="image-20200726134431509"></p> <p>当设置 <code>tcp_syncookies=1</code> 时，新的正常链接（走三次握手）还是可以建立 TCP 连接的，前提是 <code>全连接队列没有满</code>，全连接队列满了，走全连接队列的逻辑。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 临时修改</span>
<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">&gt;</span> /proc/sys/net/ipv4/tcp_syncookies
</code></pre></div><p>全连接队列没有满，服务端会回复一个带 <code>syncookie</code> 的 <code>SYN+ACK</code> 包给客户端，就是给这个包加一个会话标识，客户端收到这个 <code>SYN+ACK</code> 包必须将 <code>syncookie</code> 携带发送 <code>ACK</code> 才能建立三次握手的链接。</p> <p>全连接队列满的话会从上面全连接队列。</p> <p><a href="https://github.com/zhangpanqin/fly-java-socket/tree/master/socket-bio" target="_blank" rel="noopener noreferrer">Socket Bio 通信 GitHub 地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="nio-通信"><a href="#nio-通信" class="header-anchor">#</a> NIO 通信</h2> <p>从 <code>BIO</code> 演变到 <code>NIO</code> ,只是支持了同步非阻塞。不要小看非阻塞这个特性，他可以将我们的线程模型降低为一个（在不考虑读写客户端实时性的情况下），<code>BIO</code> 不管你怎么修改，始终都要一个客户端对应一个读线程。<code>NIO</code> 在不考虑性能的情况下，理论可以一个线程管理 n 个客户端。</p> <p><code>ServerSocketChannel.accept</code> 可以不阻塞等待客户端建立连接；</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// bio 会在这里阻塞等待新的客户端建立。</span>
        <span class="token comment">// nio 不阻塞等待，有链接建立，返回客户端。没有链接返回 null</span>
        <span class="token keyword">final</span> <span class="token class-name">SocketChannel</span> accept <span class="token operator">=</span> serverSocket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>accept<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            accept<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> currentIdClient <span class="token operator">=</span> <span class="token constant">CLIENT_ID</span><span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">SocketNioClient</span> socketNioClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SocketNioClient</span><span class="token punctuation">(</span>currentIdClient<span class="token punctuation">,</span> accept<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token constant">CLIENT</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>currentIdClient<span class="token punctuation">,</span> socketNioClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>socketNioClient<span class="token punctuation">,</span> <span class="token string">&quot;客户端-&quot;</span> <span class="token operator">+</span> currentIdClient<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;接受客户端你失败&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>SocketChannel.read 可以不阻塞等待数据从内核态到用户态，内核态中没有数据，直接返回。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// bio 不管有没有数据，都要在这里等待读取</span>
    <span class="token comment">// nio 当内核中没有数据可以读取，内核会返回 0</span>
    length <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        byteBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        s <span class="token operator">=</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;接收到客户端的消息,clientId: {} ,message: {}&quot;</span><span class="token punctuation">,</span> clientId<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token constant">EOF</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;客户端主动关闭了,clientId: {},服务端释放资源&quot;</span><span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 这里在内核没有准备好数据的时候，可以在这里执行一些别的业务代码</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 NIO 模型下，一个线程就可以管理所有的读写了(不考虑响应客户端的实时性 )。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>fly<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>nio</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fly<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">ChatPushDTO</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">InetSocketAddress</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span><span class="token class-name">ByteBuffer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>channels<span class="token punctuation">.</span></span><span class="token class-name">ServerSocketChannel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>channels<span class="token punctuation">.</span></span><span class="token class-name">SocketChannel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Objects</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ConcurrentLinkedDeque</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author 张攀钦
 * @date 2020-07-19-16:32
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NioSingleThread</span> <span class="token keyword">implements</span> <span class="token class-name">AutoCloseable</span> <span class="token punctuation">{</span>
    <span class="token comment">// 客户端发送这个消息，说明要断开连接，服务端主动断开连接</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">EOF</span> <span class="token operator">=</span> <span class="token string">&quot;exit&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 保存会话，由于这个是在单线程中操作的，不需要用并发容器</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span> <span class="token constant">MAP</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// http 接口主动发消息时，将消息保存在这个队列中</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentLinkedDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatPushDTO</span><span class="token punctuation">&gt;</span></span> <span class="token constant">QUEUE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentLinkedDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 因为单线程操作，所以直接申请堆外 buffer，这样性能高，没有考虑能不能接受客户端发送消息的大小，简单写法，只考虑 1024 个字节。</span>
    <span class="token keyword">final</span> <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 服务端 socket 绑定那个 端口</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>
    <span class="token comment">// 全链接队列的 backlog,不理解这个属性，看上面的 BIO</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> backlog<span class="token punctuation">;</span>
    <span class="token comment">// 本次绑定 ServerSocketChannel</span>
    <span class="token keyword">private</span> <span class="token class-name">ServerSocketChannel</span> <span class="token keyword">open</span><span class="token punctuation">;</span>

    <span class="token comment">// NioSingleThread 会注册到 ioc 中，closed 标记是否调用了NioSingleThread bean 被销毁时调用的 close 方法</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> closed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ServerSocketChannel</span> <span class="token function">getOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">open</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">NioSingleThread</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>backlog <span class="token operator">=</span> backlog<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">open</span> <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置使用 NIO 模型, ServerSocketChannel.accept 时候不阻塞</span>
            <span class="token keyword">open</span><span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">open</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">,</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @Bean(destroyMethod = &quot;close&quot;)
     * public NioSingleThread nioSingleThread() {
     * 	return new NioSingleThread(9998, 20);
     * }
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        closed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span><span class="token keyword">open</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">open</span><span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">open</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;关闭客户端了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 初始化之后，启动了一个线程</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">Integer</span> clientIdAuto <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 先判断这个 bean 是否被销毁了，销毁了，说明服务端的在关闭，顺便也关闭 socket</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>closed<span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">open</span><span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                <span class="token keyword">open</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 处理新的客户端链接建立</span>
                        <span class="token keyword">final</span> <span class="token class-name">SocketChannel</span> accept <span class="token operator">=</span> <span class="token keyword">open</span><span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>accept<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            accept<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token constant">MAP</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>clientIdAuto<span class="token punctuation">,</span> accept<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            clientIdAuto<span class="token operator">++</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token comment">// 处理读取事件</span>
                        <span class="token constant">MAP</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>clientId<span class="token punctuation">,</span> client<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                byteBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">final</span> <span class="token keyword">int</span> read <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>read <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token constant">MAP</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>read <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        byteBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token keyword">final</span> <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;读取客户端 clientId: {} 到的数据: {}&quot;</span><span class="token punctuation">,</span> clientId<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token constant">EOF</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                                client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                            <span class="token punctuation">}</span>
                                        <span class="token punctuation">}</span>
                                    <span class="token punctuation">}</span>

                                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;读取数据异常,clientId: {}&quot;</span><span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>

                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// 处理写事件</span>
                        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">QUEUE</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">final</span> <span class="token class-name">ChatPushDTO</span> peek <span class="token operator">=</span> <span class="token constant">QUEUE</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>peek<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">final</span> <span class="token class-name">Integer</span> chatId <span class="token operator">=</span> peek<span class="token punctuation">.</span><span class="token function">getChatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">final</span> <span class="token class-name">String</span> message <span class="token operator">=</span> peek<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">final</span> <span class="token class-name">SocketChannel</span> socketChannel <span class="token operator">=</span> <span class="token constant">MAP</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>chatId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>socketChannel<span class="token punctuation">)</span> <span class="token operator">||</span> socketChannel<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

                            byteBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            byteBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            byteBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            socketChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token punctuation">}</span>


                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;服务端异常&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;NioSingleThread&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

	<span class="token comment">// 对外暴露的接口，写事件</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writeMessage</span><span class="token punctuation">(</span><span class="token class-name">ChatPushDTO</span> chatPushDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>chatPushDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">QUEUE</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>chatPushDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><a href="https://github.com/zhangpanqin/fly-java-socket/tree/master/socket-nio" target="_blank" rel="noopener noreferrer">NIO 代码 GitHub 地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><code>NIO</code> 模型已经不错了，减少了线程和内存占用。但是它有一个弊端就是客户端有没有数据还是需要调用系统调用 <code>read</code> 来看看是否有数据到达。</p> <p>当比如有五万个链接的时候，我们需要调用系统调用五万次 <code>int read = client.read(byteBuffer)</code>，换而言之用户态到内核态需要切换五万次，这也是不小的计算机资源消耗。</p> <p><code>IO 模型</code> 继续演变到目前常用比较广泛的 <code>多路复用</code>，它解决了这个系统调用多次的问题，将五万次的系统调用减少到一次或者多次。</p> <h2 id="io-多路复用"><a href="#io-多路复用" class="header-anchor">#</a> IO 多路复用</h2> <p><code>NIO</code> 存在的弊端：不管你客户端有没有数据传过来，我都要调用系统调用看看有没有数据到来。</p> <p>客户端建立连接之后，内核会为这个客户端分配一个 <code>fd(文件描述符)</code>。</p> <p><code>IO 多路复用</code> 指的是内核监控客户端（fd）有没有数据到来，当我们想要知道哪些客户端数据到来了，只需要调用多路复用器 <code>select</code> , <code>poll</code> , <code>epoll</code> 提供的系统调用即可，将想要知道的客户端（fd）传进去，内核就会返回哪些客户端（fd）数据准备好了。我们从原来的五万次系统调用，降低到一次，大大降低了系统开销。<code>epoll</code> 是这三个多路复用器中效率最高的一个。</p> <p>1、<code>select</code> 一次调用传入的 fd 是有数量限制的（一次只能传入 1024 个，不同的内核参数可能会不同），五万链接会调用 30 次左右系统调用，但是内核还是会遍历这五万个链接，检查是否有数据可读。然后调用对应的系统调用，获得有数据到达的客户端 （fd），然后操作 <code>fd</code> 将数据从 <code>内核态</code> copy 到 <code>用户态</code> 去做业务处理。</p> <p>2、<code>poll</code> 和 <code>select</code> 差不多，只是系统调用时传入的 fd 没有限制。<code>poll</code> 和 <code>select</code> 只是减少了系统调用，实际内核也是遍历每个链接检查是否可读，所以效率和连接总数成线性关系，建立连接的客户端越多效率越低。</p> <p>3、<code>epoll</code> 不是内核轮训每个 <code>fd</code> 检验是否可读。当客户端数据到达，内核将网卡中将数据读到到自己的内存空间，内核会将有数据到达的连接放入到一个队列中去，用户态的程序只需要调用 <code>epoll</code> 提供的系统调用，从这个队里中拿到链接对应的 <code>fd</code> 即可，所以效率和活跃连接数有关，和连接总数没有关系（百万链接中可能只有 20% 是活跃链接）。</p> <h3 id="epoll-相关的系统调用"><a href="#epoll-相关的系统调用" class="header-anchor">#</a> epoll 相关的系统调用</h3> <p><code>epoll</code> 内部维护了一个红黑树和队列，红黑树记录当前多路复用器需要监测哪些链接的那些操作（读写等），队列中就是哪些操作就绪的链接。</p> <h4 id="epoll-create"><a href="#epoll-create" class="header-anchor">#</a> <code>epoll_create</code></h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//  返回文件描述符，这个文件描述符对应 epoll 实例，fd 在后续 epoll 相关的系统调用中有用</span>
<span class="token keyword">int</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>epoll_create</code> 创造一个多路复用器实例 <code>epoll</code>，返回一个 <code>epfd</code>，这个 <code>epfd</code> 指向了<code>epoll</code>的实例。<code>epfd</code> 实际就是一个文件描述符。</p> <h4 id="epoll-ctl"><a href="#epoll-ctl" class="header-anchor">#</a> <code>epoll_ctl</code></h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">int</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">int</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> struct epoll_event <span class="token operator">*</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>epoll_ctl</code> 将客户端或者服务端对应的 socket fd 注册 epoll 上，op 就是指定当前系统调用的类型，是将 fd 注册到 epoll ，还是从 epoll 删除 fd，还是修改在 epoll 上 event 。event 指的是 io 操作（读、写等）。</p> <p><code>epoll_ctl</code> 设置 epoll 的实例监听哪些客户端或者服务端，并且指定监听它们的那些 io 操作。</p> <h4 id="epoll-wait"><a href="#epoll-wait" class="header-anchor">#</a> <code>epoll_wait</code></h4> <div class="language- extra-class"><pre class="language-text"><code># epoll 返回了准备好 io 操作的 fd 的数量
int epoll_wait(int epfd, struct epoll_event *events,int maxevents, int timeout);
</code></pre></div><p>获取当前多路复用器（epfd）上有多少个客户端 io 操作就绪（注册 epoll 中时指定的操作）。<code>epoll_wait</code> 当没有指定 timeout 时，会一直阻塞等待至少有一个客户端 <code>io</code> 操作就绪。<code>timeout</code> 大于 0 会在超时时直接返回 0。</p> <p>epoll_event 是接受这个系统调用中准备好的事件，事件数据结构中可以拿到对应的客户端 fd。</p> <p><code>epoll_wait</code> 是阻塞调用，返回的话：</p> <ul><li><p>有 io 操作就绪</p></li> <li><p>指定的超时时间到了</p></li> <li><p>调用被打断就会返回</p></li></ul> <h3 id="epoll-触发方式"><a href="#epoll-触发方式" class="header-anchor">#</a> epoll 触发方式</h3> <p>epoll 监控多个文件描述符的 io 事件，什么样的情况 epoll 认为是可以读写呢，这是就事件的触发方式。epoll 支持两重触发方式，边缘触发（edge trigger，ET）和水平触发 (level trigger，LT)。</p> <p>每个 <code>fd</code> 缓冲区，fd 缓冲区中又可以分为读缓冲区和写缓冲区。每个客户端链接对应一个 fd。</p> <p>客户端数据来了，网卡会将客户端来的数据从网卡的内存中写入到链接对应内核中的 fd 读缓冲区。应用程序调用 <code>epoll_wait</code> 知道那个链接有数据到达了，再将这个数据从内核态读到用户态，然后做数据处理。</p> <p>往客户端写数据。应用程序调用 socket (对应一个 fd) api，将数据从用户态写入到内核态中的 fd 写缓冲区中去，然后内核会将数据写入到网卡中去，网卡在适当的时机再发给客户端。</p> <p>如果 fd 的写缓冲区满了，当调用 write 的时候就会阻塞等待写缓冲区腾出空间来。</p> <p>TCP 链接数据发送的时候，会有一个滑动窗口控制数据的发送。当发送的快，接受的慢，当超过了这个流量控制，发送的数据包，没有收到客户端发来的 <code>ACK</code> ，会继续重试发送数据包。</p> <p>下图是在流控之内正常发送，服务端发包，客户端接收到，恢复一个 <code>ACK</code>。</p> <img src="/blog/20200726191559.png?author=zhangpanqin" alt="image-20200726191559755" style="zoom:150%;"> <p>这个是流控之外没有发送成功，会等待接着发送的。</p> <p><img src="/blog/20200726191825.png?author=zhangpanqin" alt="image-20200726191825717"></p> <p>这个也和 fd 的读写缓冲区有关系，客户端的度读缓冲区满了，服务端再怎么发，也不会成功的。</p> <p>服务端写数据到客户端，会从</p> <h4 id="_1、水平触发时机"><a href="#_1、水平触发时机" class="header-anchor">#</a> 1、水平触发时机</h4> <ul><li><p>对于读操作，只要读缓冲内容不为空，LT 模式返回读就绪。</p></li> <li><p>对于写操作，只要写缓冲区不满，LT 模式会返回写就绪。</p></li></ul> <h4 id="_2、边缘触发时机"><a href="#_2、边缘触发时机" class="header-anchor">#</a> 2、边缘触发时机</h4> <h5 id="读操作"><a href="#读操作" class="header-anchor">#</a> 读操作</h5> <ul><li><p>当缓冲区由不可读变为可读的时候，即缓冲区由空变为不空的时候。</p></li> <li><p>当有新数据到达时，即缓冲区中的待读数据变多的时候。</p></li></ul> <h5 id="写操作"><a href="#写操作" class="header-anchor">#</a> 写操作</h5> <ul><li><p>当缓冲区由不可写变为可写时。</p></li> <li><p>当有旧数据被发送走，即缓冲区中的内容变少的时候。</p></li></ul> <p>边缘触发相当于只有增量的时候才会触发。</p> <h2 id="java-多路复用"><a href="#java-多路复用" class="header-anchor">#</a> Java 多路复用</h2> <p>Java 中对多路复用器的抽象是 <code>Selector</code> 。根据不同的平台通过 <code>SPI</code>获得不同的 <code>SelectorProvider</code>。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 根据 SPI 获取多路复用器，linux 是 epoll,mac 下是 KQueue</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">AbstractSelector</span> <span class="token function">openSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token comment">// 获取服务端 socket</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">ServerSocketChannel</span> <span class="token function">openServerSocketChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token comment">// 获取客户端 socket</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">SocketChannel</span> <span class="token function">openSocketChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Selector</span> <span class="token keyword">implements</span> <span class="token class-name">Closeable</span> <span class="token punctuation">{</span>

	<span class="token comment">// 相当于 epoll_create ,创建一个多路复用器</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Selector</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">SelectorProvider</span><span class="token punctuation">.</span><span class="token function">provider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 相当于 epoll_wait</span>
    <span class="token comment">// select 实现使用了 synchronized ，它的锁和 register 使用的锁有重复，当 select 阻塞的时候，调用 register 也会被阻塞。</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">int</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">int</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>

    <span class="token comment">// 打断 epoll_wait 的阻塞</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Selector</span> <span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 释放 epoll 的示例</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>

    <span class="token comment">// 方法在 AbstractSelector extends Selector</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">SelectionKey</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">AbstractSelectableChannel</span> ch<span class="token punctuation">,</span><span class="token keyword">int</span> ops<span class="token punctuation">,</span> <span class="token class-name">Object</span> att<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SocketChannel</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSelectableChannel</span> <span class="token keyword">implements</span>
        <span class="token class-name">ByteChannel</span><span class="token punctuation">,</span> <span class="token class-name">ScatteringByteChannel</span><span class="token punctuation">,</span> <span class="token class-name">GatheringByteChannel</span><span class="token punctuation">,</span> <span class="token class-name">NetworkChannel</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 从通道读取数据是加锁的,方法线程安全。读取之后的结果 ByteBuffer 操作需要自己保证安全
     * synchronized(this.readLock)
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">int</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span> dst<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 将缓冲区的数据写入到通道中,加锁。但是 ByteBuffer 需要自己保证安全
     * synchronized(this.writeLock)
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">int</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span> src<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="一个简单-demo"><a href="#一个简单-demo" class="header-anchor">#</a> 一个简单 Demo</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * @author 张攀钦
 * @date 2020-07-26-16:15
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SocketDemo1</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 调用 socket() 系统调用获取 socketfd</span>
        <span class="token keyword">final</span> <span class="token class-name">ServerSocketChannel</span> <span class="token keyword">open</span> <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 注册多路复用器的 socket 必须是非阻塞的</span>
        <span class="token keyword">open</span><span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 调用 bind 系统调用，将 socketfd 绑定特定的 ip 和 port</span>
        <span class="token keyword">open</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token string">&quot;10.211.55.8&quot;</span><span class="token punctuation">,</span> <span class="token number">10224</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 调用 epoll_create 多创建一个多路复用器，epoll</span>
        <span class="token keyword">final</span> <span class="token class-name">Selector</span> open1 <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// epoll_ctl 让 epoll 监听 socketfd 的 哪些io 操作</span>
        <span class="token keyword">open</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>open1<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 解决 Selector.select 阻塞的时候，调用 Selector.register 被阻塞的问题，这个点很重要，一定要理解</span>
        <span class="token keyword">final</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> objects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建监听客户端的 epoll，可以根据业务，创建一定数量 epoll,每个 epoll 下监听一定量客户端链接</span>
        <span class="token class-name">Selector</span> open2 <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 这个线程用于读取数据</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 调用这个方法会阻塞，阻塞的时候等待 io 操作，select 阻塞的时候锁没有释放，当调用 register 也被阻塞了，最终可能造成多个线程					  // 都被阻塞</span>
                    <span class="token keyword">int</span> select <span class="token operator">=</span> open2<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>select <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> selectionKeys <span class="token operator">=</span> open2<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">final</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> selectionKeys<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;随便输入数据&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// 可以在这里阻塞将数据从内核态读入到用户态，主要为了验证缓冲区和 Tcp 的滑动窗口</span>
                            <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">final</span> <span class="token class-name">SelectionKey</span> next <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">final</span> <span class="token class-name">SocketChannel</span> channel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> next<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">final</span> <span class="token class-name">ByteBuffer</span> allocate <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">final</span> <span class="token keyword">int</span> read <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>allocate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment">// 长度为 -1 的时候说明客户端关闭了</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>read <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>read <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    allocate<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>allocate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">// 在这里解决 select 阻塞 register 的问题。</span>
                    <span class="token keyword">final</span> <span class="token class-name">Runnable</span> poll <span class="token operator">=</span> objects<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>poll<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        poll<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// 主要用于接受客户端的链接，并将链接注册到 epoll 的逻辑</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>open1<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> selectionKeys <span class="token operator">=</span> open1<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> selectionKeys<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">final</span> <span class="token class-name">SelectionKey</span> next <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> next<span class="token punctuation">.</span><span class="token function">isAcceptable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">final</span> <span class="token class-name">ServerSocketChannel</span> channel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span><span class="token punctuation">)</span> next<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">final</span> <span class="token class-name">SocketChannel</span> accept <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>accept<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                accept<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                objects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                                    open2<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                        accept<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>open2<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_READ</span> <span class="token operator">|</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_WRITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClosedChannelException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                open2<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <p><a href="http://www.eventhelix.com/RealtimeMantra/Networking/" target="_blank" rel="noopener noreferrer">TCP/IP 介绍<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/zhangpanqin/mflyyou/edit/main/docs/java/io/io-module.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/6/6 下午3:29:38</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
            ←
            <a href="/mflyyou/java/base/java-asynchronous-programming.html" class="prev">
                java 异步编程
            </a></span> <span class="next"><a href="/mflyyou/java/io/java-io.html">
                从Linux内核理解Java中的IO
            </a>
            →
        </span></p></div> </main> <aside class="right-sidebar"> <div class="right-sidebar-toc-container" style="display:;"><div class="pos-box"><div class="icon-arrow"></div> <div class="scroll-box" style="max-height:650px"><div style="font-weight:bold;text-align:center;">从linux内核理解Java怎样实现Socket通信</div> <hr> <div class="toc-box"><ul><li><a href="/mflyyou/java/io/io-module.html#前言" class="toc-sidebar-link">前言</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#内核参数说明" class="toc-sidebar-link">内核参数说明</a></li><li class="toc-sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#本文内容" class="toc-sidebar-link">本文内容</a></li></ul></li><li><a href="/mflyyou/java/io/io-module.html#bio-通信" class="toc-sidebar-link">BIO 通信</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/mflyyou/java/io/io-module.html#全连接队列和半链接队列" class="toc-sidebar-link">全连接队列和半链接队列</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#tcp-抓包" class="toc-sidebar-link">TCP 抓包</a></li><li class="toc-sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#全连接队列溢出" class="toc-sidebar-link">全连接队列溢出</a></li><li class="toc-sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#半链接队列溢出" class="toc-sidebar-link">半链接队列溢出</a></li></ul></li><li><a href="/mflyyou/java/io/io-module.html#nio-通信" class="toc-sidebar-link">NIO 通信</a><ul class="toc-sidebar-sub-headers"></ul></li><li><a href="/mflyyou/java/io/io-module.html#io-多路复用" class="toc-sidebar-link">IO 多路复用</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#epoll-相关的系统调用" class="toc-sidebar-link">epoll 相关的系统调用</a></li><li class="toc-sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#epoll-触发方式" class="toc-sidebar-link">epoll 触发方式</a></li></ul></li><li><a href="/mflyyou/java/io/io-module.html#java-多路复用" class="toc-sidebar-link">Java 多路复用</a><ul class="toc-sidebar-sub-headers"><li class="toc-sidebar-sub-header"><a href="/mflyyou/java/io/io-module.html#一个简单-demo" class="toc-sidebar-link">一个简单 Demo</a></li></ul></li><li><a href="/mflyyou/java/io/io-module.html#参考资料" class="toc-sidebar-link">参考资料</a><ul class="toc-sidebar-sub-headers"></ul></li></ul></div></div></div></div> <div class="right-sidebar-toolbar"><div class="option-box"><img src="/mflyyou/images/system/toc.png" class="nozoom"> <span class="show-txt">目录</span></div> <div class="option-box"><img src="/mflyyou/images/system/toggle.png" width="30px" class="nozoom"> <span class="show-txt">左栏</span></div> <div title="java 异步编程" class="option-box" style="padding-left:2px;text-align:center;"><a href="/mflyyou/java/base/java-asynchronous-programming.html"><img src="/mflyyou/images/system/pre2.png" width="30px" class="nozoom"> <span class="show-txt">上一篇</span></a></div> <div title="从Linux内核理解Java中的IO" class="option-box" style="padding-left:2px;text-align:center;"><a href="/mflyyou/java/io/java-io.html"><img src="/mflyyou/images/system/next2.png" width="30px" class="nozoom"> <span class="show-txt">下一篇</span></a></div></div> </aside></div><div class="global-ui"><!----><!----></div></div>
    <script src="/mflyyou/assets/js/app.1ebce3ec.js" defer></script><script src="/mflyyou/assets/js/5.060b7482.js" defer></script><script src="/mflyyou/assets/js/2.337a644b.js" defer></script><script src="/mflyyou/assets/js/73.d613ca64.js" defer></script><script src="/mflyyou/assets/js/13.4af4aae9.js" defer></script>
  </body>
</html>
